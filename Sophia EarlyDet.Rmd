---
title: "Sophia Early Detection"
author: "Robin Myte"
date: "16 augusti 2016"
output: html_document
---

#PROTEIN analyis

##Olink and VIP data + libraries
```{r olink biobank data import,echo=FALSE,message=FALSE}

setwd("~/Dropbox/Documents/JOBB ONKO/Sophia Early Detection")

# Packages RUN
library(cluster)
library(Hmisc)
library(FactoMineR)
library(GenABEL)
library(mgcv)
library(car)
library(boot)
library(gdata)
library(gplots)
library(xlsx)
library(reshape)
library(ENmix)
library(gdata)                
library(ggExtra)
library(dplyr)
library(tidyr)
library(lme4)
library(broom)
library(forcats)
library(circlize)
library(RColorBrewer)
library(minfi)
library(MuMIn)


# Functions 
source('~/Dropbox/Documents/JOBB ONKO/R/Kaplan Meier.R')
source("~/Dropbox/Documents/JOBB ONKO/R/confadjust.R")
source("~/Dropbox/Documents/JOBB ONKO/R/summ.R")
source("~/Dropbox/Documents/JOBB ONKO/R/RD quartiles.R")
source('~/Dropbox/Documents/JOBB ONKO/R/table_myte.R')
source('~/Dropbox/Documents/JOBB ONKO/R/subtype clog.R')
# Table function, show NA
tab <- function(x,y=1){
  if(length(y)>1){table(x,y,useNA = "always")
    } else{table(x,useNA = "always")} 
} 
# Import data 
# OLINK data - Inflammation 
p.inflam = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophiaearlydetection/NPX and linear_INF.xlsx",
                            rows=1:267,
                           sheet=1, 
                           skipEmptyRows=FALSE)
p.inflamlod = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophiaearlydetection/NPX and linear_INF.xlsx",
                            rows=1:267,
                           sheet=2, 
                           skipEmptyRows=FALSE)
#p.inflam <- p.inflam[1:266,]

# OLINK data - oncology 
p.onc = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophiaearlydetection/NPX and linear_ONCII.xlsx",
                           rows=1:270,
                          sheet=1, 
                           skipEmptyRows=FALSE)
p.onclod = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophiaearlydetection/NPX and linear_ONCII.xlsx",
                           rows=1:270,
                          sheet=2, 
                           skipEmptyRows=FALSE)
#p.onc <- p.onc[1:269,]

# MERGE inflam and onc
p.inflam["id"] <- p.inflamlod["id"] <- as.numeric(p.inflam$NPX)
p.onc["id"] <- p.onclod["id"] <- as.numeric(p.onc$NPX)
datx <- merge(p.inflam,p.onc,by="id")
datlod <- merge(p.inflamlod,p.onclod,by="id")
# Remove variables
datx <- dplyr::select(datx,-contains("NPX"),-contains("Flagged"))
datlod <- dplyr::select(datlod,-contains("Ctrl"),-contains("NPX"),-contains("Flagged"),-contains("Chip"),-contains("MissData"),-contains("S-Type"))
# Fix variable names 
names(datx) <- gsub('-', '_', names(datx))
names(datlod) <- gsub('-', '_', names(datlod))
names(datx)[-1] <- substr(names(datx)[-1],5,nchar(names(datx)[-1]))
names(datlod)[-1] <- substr(names(datlod)[-1],5,nchar(names(datlod)[-1]))
# Remove double variables:
par(mfrow=c(2,2))
plot(datx$TGFA,datx$TGF_alpha)
plot(datx$HGF.y,datx$HGF.x)
plot(datx$VEGF_A.y,datx$VEGF_A.x)
#datx <- dplyr::select(datx,-HGF.x,-TGFA,-VEGF_A.x) %>% rename(HGF=HGF.y,VEGF_A=VEGF_A.y)
#datlod <- dplyr::select(datlod,-HGF.x,-TGFA,-VEGF_A.x) %>% rename(HGF=HGF.y,VEGF_A=VEGF_A.y)
datx <- dplyr::select(datx,-HGF.y,-TGF_alpha,-VEGF_A.y) %>% dplyr::rename(HGF=HGF.x,VEGF_A=VEGF_A.x)
datlod <- dplyr::select(datlod,-HGF.y,-TGF_alpha,-VEGF_A.y) %>% dplyr::rename(HGF=HGF.x,VEGF_A=VEGF_A.x)
par(mfrow=c(1,1))
# MISSING OLINK-data
# percent missing in each variable, endast på datx, datlod har inga missing (ersatt med lowest detectable value)
na.col <- apply(datx,2,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.col)
na.col[na.col>0.8]
summary(datx[,names(na.col[na.col>0.8])])
# percent missing in each obs
na.row <- apply(datx,1,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.row) #Som högst 12 %, så OK

# SELECT and FILTER OLINK data
names(datlod)==names(datx) #samma variabler i båda
var <- names(datlod)[-1] #lista för senare bruk

# VIP data 
phen = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophiaearlydetection/crc_enkatdata160907.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)
alder = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophiaearlydetection/phenotypdata.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)
# fixa id och age-variabler
phen <- phen[order(phen$pat_code),]
alder <- alder[order(alder$pat_code),]
phen["id"] <- phen$pat_code
phen["birth"] <- alder$birth
phen["pdatum"] <- alder$pdatum
phen["bdatum"] <- as.Date(as.character(phen$birth),'%Y%m%d')
phen["pdatum2"] <- as.Date(as.character(phen$pdatum),'%Y%m%d')
phen["age"] <- as.numeric((phen$pdatum2-phen$bdatum))/365
phen[phen==9999] <- NA
phen[phen==8888] <- NA

# NYA VARIABLER VIP
# Select lifestyle variables of interest:
summary(phen)

phen <- dplyr::select(phen,id,casecontrol,caseset,caseset2,provnr,pdatum2,diadat=DIADAT,age,gender,langd,vikt,bmi,skol,stg,blods0,blods2,sbt,dbt,starts_with("med"),smartmed,andra_mediciner,g6,sm_status,sn_status,pa_index,pa_index_miss)
##nya
phen["agef"] <- ceiling(phen$age)
phen["age4"] <- cut(phen$agef,breaks=c(0,40,50,60,70),right=T,labels=c(30,40,50,60))
# BMI
phen["bmi3"] <- cut(phen$bmi,breaks=c(0,20,25,30,50),right=T,labels=c(1,2,3,4))
phen$bmi3 <- fct_relevel(phen$bmi3,"2")
phen$stgc <- phen$stg
phen$stg <- log(phen$stg)
phen["midbp"] <- (phen$sbt+phen$dbt)/2
# Medicin variable, tar du NÅGON medicin
phen["med"] <- rowSums(phen[,19:23],na.rm=T) 
phen$med <- as.factor(ifelse(phen$med>0,1,ifelse(phen$med==0&phen$med_C5f==1,0,9999)))
# Smoking 
phen["smoke"] <- as.factor(phen$sm_status)
levels(phen$smoke) <- c(1,2,0,1,2)
phen$smoke<- fct_relevel(phen$smoke,"0")
# Snus
phen["snus"] <- as.factor(phen$sn_status)
levels(phen$snus) <- c(1,2,0)
phen$snus<- fct_relevel(phen$snus,"0")
phen[which(is.na(phen$pa_index)==T),"pa_index"] <- 1
# MetS variables
# Z-transformed variables per gender and sample
phen<- transform(phen, 
          bmiz=ave(bmi, gender, provnr, FUN=scale),
          stgz=ave(stg, gender, provnr, FUN=scale),
          midbpz=ave(midbp, gender, provnr, FUN=scale),
          blods0z=ave(blods0, gender, provnr, FUN=scale),
          skolz=ave(skol, gender, provnr, FUN=scale))
phen["metsz"] <- phen$bmiz + phen$stgz + phen$midbpz + phen$blods0z + phen$skolz
# Cut-off MetS
phen["bmi2"] <- ifelse(phen$bmi>=30,1,0)
phen["stg2"] <- ifelse(phen$stgc>=1.7,1,0)
phen[is.na(phen$med_C5a),"med_C5a"] <- 0
phen["ht2"] <- ifelse(phen$sbt>=130|phen$dbt>=85|phen$med_C5a==1,1,0)
phen["htm"] <- phen$med_C5a
phen["gluc2"] <- ifelse(phen$blods0>=5.6,1,0)
phen["skol2"] <- ifelse(phen$skol>=6.2,1,0)
phen["mets"] <- phen$stg2 + phen$ht2 + phen$gluc2 + phen$skol2
phen["mets2"] <- as.factor(ifelse((phen$bmi>=25)&(phen$mets>1),1,0))

# Kön
phen$gender <- as.factor(phen$gender)

# Final remove all uncessesary variables:
phen <- dplyr::select(phen,-contains("med_"),-smartmed,-andra_mediciner,-sm_status,-sn_status)
summary(phen)

# MISSING VIP:
# percent missing in each obs
na.row <- apply(phen,1,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.row) #En individ har missing på 60€ av variablerna, (har bara kön och ålder)
na.row[na.row>0.5]
phen[names(na.row[na.row>0.5]),] 

#Select and filter phen data
phen <- filter(phen,id!=phen[names(na.row[na.row>0.5]),"id"])

# merge PHEN och OLINK data 

# NA-data
dat1 <- merge(phen,datx,by="id")
dat1 <- unite(dat1,"person",caseset,casecontrol,remove=FALSE)

# LOD-data
dat2 <- merge(phen,datlod,by="id")
dat2 <- unite(dat2,"person",caseset,casecontrol,remove=FALSE)

# Borttagna flagged prover: (11 stycken + 1 som saknade phen data), stämmer överrens med OLINKs lista. 
phen[!(phen$id %in% dat1$id),"pat_code"]

#dub <-  dplyr::select(dat1,contains("HGF"),contains("IL_6"),contains("SCF"),contains("TRAIL"),contains("TGF"),contains("VEGF")) %>% names()


# ANNAT
# Get Nature communications significant associations PEA vs Lifestyle
natcom = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/VariablesNatCom.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)

natcom <- dplyr::select(natcom,-Waist,-TLS)  
natcom <- natcom[,c("var","Age","Sex","Height","Weight","BMI","SBP","DBP","Smoking","Snus")]
# Only take proteins we have in our study:
var.n <- as.factor(gsub('-', '_', natcom$var))
levels(var.n)[levels(var.n)=="ErbB2"] <- "ERBB2"
levels(var.n)[levels(var.n)=="ErbB3"] <- "ERBB3"
levels(var.n)[levels(var.n)=="ErbB4"] <- "ERBB4"
levels(var.n)[levels(var.n)=="FasL"] <- "FASLG"
levels(var.n)[levels(var.n)=="CEA"] <- "CEACAM5"
levels(var.n)[levels(var.n)=="MIC_A"] <- "MIC_A/B"
levels(var.n)[levels(var.n)=="TGF_beta_1"] <- "LAP.TGF_beta_1"
var.n <- as.character(var.n)
natcom$var <- var.n

natcom1 <- natcom[natcom$var %in% var,]

par(mfrow=c(1,1))
```

Samma variabler i onc och infl panel?
```{r check olink panels,echo=F}
on <- names(p.onc)[2:93]
inf <- names(p.inflam)[2:91]
on <- substr(on,5,nchar(on))
inf <- substr(inf,5,nchar(inf))

inf[inf %in% on]
on[on %in% inf]

summary(select(dat1,contains("VEGF-A")))
summary(select(dat1,contains("HGF")))
```


##Descriptive statistics:

Histograms:

```{r histograms olink proteins,echo=F}
dplyr::select(dat.lme,provnr,one_of(var1[1:50])) %>% melt(id="provnr") %>%
  ggplot(aes(x=value, fill=as.factor(provnr))) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 
  
dplyr::select(dat.lme,provnr,one_of(var1[51:100])) %>% melt(id="provnr") %>%
  ggplot(aes(x=value, fill=as.factor(provnr))) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 
  
dplyr::select(dat.lme,provnr,one_of(var1[101:length(var1)])) %>% melt(id="provnr") %>%
  ggplot(aes(x=value, fill=as.factor(provnr))) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 
  

```

Changes in metS variables:
```{r changes in MetS over time}
# some dont have repeated samples:
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Continous with change-indicator variable
d <-  dat1 %>% dplyr::filter(!person %in% id2) %>% dplyr::select(metsz,bmi,stgc,midbp,blods0,skol,person,age,provnr,gender) %>% 
  dplyr::rename(MetS=metsz, BMI=bmi, Trigclycerides=stgc, midXXBP=midbp, Blood_glucose=blods0, Total_cholsterol=skol, Sex=gender) %>%
  melt(id=c("person","age","provnr","Sex"))
d1 <- filter(d, provnr==1);names(d1) <- c("person", paste0(names(d1)[-1],1));d1 <- d1[order(d1$person),]
d2 <- filter(d, provnr==2);names(d2) <- c("person", paste0(names(d2)[-1],2));d2 <- d2[order(d2$person),]
d3 <- cbind(d1,d2)
d3["diff"] <- d3$value2-d3$value1
d3["change"] <- as.factor(ifelse(d3$diff>0,"increase","decrease"))
names(d3) <- c(names(d),names(d),"diff","Change")
d1 <- d3[,c(1:6,13,14)]
d2 <- d3[,c(7:12,13,14)]
d3 <- rbind(d1,d2)
#Fix factor levels
levels(d3$variable) <- gsub("XX","-",levels(d3$variable))
levels(d3$variable) <- gsub("_"," ",levels(d3$variable))
levels(d3$Sex) <- c("Men","Women") 

# plot   
ggplot(d3, aes(y=value,x=age,group=person,color=Change)) + geom_point(aes(shape=Sex),size=2) + geom_line(alpha=0.7) + facet_wrap(~variable, scales="free") + 
  theme_bw() + xlab("Age") + ylab(" ") 

# groups
#dat1 %>% dplyr::select(mets2, bmi2, stg2, ht2, gluc2,person,age) %>% melt(id=c("person","age")) %>% na.omit() %>%
#  ggplot(aes(y=value,x=age,group=person,fill=value)) + geom_point() + geom_line() + facet_wrap(~variable) 

```


Heatmap of levels

Rows are variables, columns are observations. Observations are sorted according to case. Gray squares indicate missing observations.

```{r heatmap all IP, fig.width=12, fig.height=8, message=FALSE, warnings=FALSE}

# Data fix  8*8 inch pic
dat11 <- dplyr::select(dat1, provnr, casecontrol, person, one_of(var))  %>% 
          mutate(case=factor(casecontrol,labels=c("control","case")),
                 case.provnr=interaction(case,provnr),cpnum=as.numeric(case.provnr)) %>% 
          unite(person_case_provnr,case.provnr, person, sep=" ",remove=F)

# remove NAs
con <- dplyr::select(dat11, one_of(var),person_case_provnr,cpnum) %>% arrange(cpnum) %>% dplyr::select(-cpnum)

# Sort columns after amount of NA
n <- apply(con[,var],2,function(x) sum(is.na(x)))
n <- sort(n,decreasing=F)
n <- names(n)


# Heatmap 
# get rownames
df <- melt(con,id.vars="person_case_provnr")
df$person_case_provnr <- factor(df$person_case_provnr,levels=as.character(con$person_case_provnr))
df$variable <- factor(df$variable,levels=n)
levels(df$variable) <- gsub("_","-",levels(df$variable))

ggplot(df, aes(y = variable, x = person_case_provnr)) + 
   geom_tile(aes(fill = value), colour = "white") + 
   scale_fill_gradient(low = "dodgerblue4", high = "gold", na.value="gray") +
   theme(axis.text.x = element_text(angle = 55, hjust = 1))+
   geom_vline(xintercept=which(levels(df$person_case_provnr) %in% c("control.1 22_0", "case.1 36_1", "control.2 48_0")) + c(0.5, 0.5,0.5), col="black")
   


```

##Cluster analysis:

```{r standardized cluster analysis ,echo=F, fig.pos = "H",fig.width=8, fig.height=8}
source('~/Dropbox/Documents/JOBB ONKO/R/heatmap3.R')

# Data fix 8*8 inch pic
# Remove many NAs
na1 <- apply(dat1[,var],2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.15]
manyna1 <- names(na1[na1>=0.15])

#
# Data - provnr 
corre <-  dplyr::select(dat1,provnr, gender, age4, bmi2, stg2, ht2, gluc2, mets2, one_of(var)) %>%
        dplyr::select(-one_of(c(manyna1))) %>% 
        mutate(bmi2=coalesce(as.integer(bmi2), 9999L), stg2=coalesce(as.integer(stg2), 9999L),
               ht2=coalesce(as.integer(ht2), 9999L), mets2=coalesce(as.integer(mets2), 9999L)) 

var1 <- dplyr::select(corre, IL_8:FR_alpha) %>% names()
corre[,var1] <- scale(corre[,var1])
#Remove NAs
con <- na.omit(corre) 

heat <- dplyr::select(con, IL_8:FR_alpha)
heat <- heat %>% as.matrix()
heat <- t(heat)

#col legends
pal <- brewer.pal(4,"Set1")
con$stg2 <- as.character(factor(con$stg2, labels=c("gray95","black","gray")))
con$gluc2 <- as.character(factor(con$gluc2, labels=c("gray95","black")))
con$ht2 <-as.character(factor(con$ht2, labels=c("gray95","black","gray"))) 
con$bmi2 <- as.character(factor(con$bmi2, labels=c("gray95","black","gray")))
con$mets2 <- as.character(factor(con$mets2, labels=c("gray95","black","gray")))
con$gender <- as.character(factor(con$gender, labels=c("darkorange","brown")))
con$age4 <- as.character(factor(con$age4, labels=c("cyan","dodgerblue1","dodgerblue4","purple")))
con$provnr <- as.character(factor(con$provnr, labels=c("#F8766D", "#00BA38")))

fcol <- dplyr::select(con, provnr, age4, gender,mets2, bmi2, ht2, gluc2, stg2) %>% 
  dplyr::rename(Sample=provnr, Age=age4, Sex=gender, MetS=mets2, BMI_above_30=bmi2, Hypertension=ht2, 
                Raised_glucose=gluc2, Raised_triglycerides=stg2) %>% as.matrix()
colnames(fcol) <- gsub("_"," ",colnames(fcol))

# col heatmap
#my_palette <- colorRampPalette(c("dodgerblue4","goldenrod"))(200)
my_palette <- colorRampPalette(c("dodgerblue4","gray90","goldenrod"))(200)

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="average")}
dist.pear <- function(x) as.dist(1-cor(t(x),method="spearman",use="pairwise.complete.obs"))

# Plot Heatmap 
heatmap.3(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun = mydist,
          col=my_palette,
          margins=c(8,16), KeyValueName=" ",
          ColSideColors=fcol,ColSideColorsSize=6, RowSideColorsSize=2)

legend("topright", title = " ", 
       legend = c("Sample 1","Sample 2"," ","Age <40","Age 40-50","Age 50-60", "Age >60", " ", 
                  "Male", "Female", " ", "Positive", "Negative"," ","Missing"),
       fill= c("#F8766D", "#00BA38","white","cyan","dodgerblue1","dodgerblue4","purple","white", "darkorange","brown","white","black","gray95","white","gray"),
       border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)



```


##Associations biomarkers vs lifestyle

###Mixed models:
Use Random intercepts models.
For nlme, the column "Intercept" refers the measure of the variability for each random effect that you added to the model. "Residual" refers to the measure of the variability that is not due to differences between individuals. The ICC here is always non-negative, allowing it to be interpreted as the proportion of total variance that is "between groups." 

```{r lmm testing}
dat.lme <- dplyr::select(dat1,ESM_1,casecontrol,g6,person,provnr,age,gender,langd,vikt,skol,stg,blods0,blods2,sbt,dbt,smoke,snus,med) %>% na.omit()

test <- lme(ESM_1 ~ 1, random=list(~1|person), dat.lme)
summary(test)
# "between person", variance:
tapply(dat.lme$ESM_1,dat.lme$person,mean)
sd(tapply(dat.lme$ESM_1,dat.lme$person,mean))/sqrt(2)
# Residual "Within person", variance:
tapply(dat.lme$ESM_1,dat.lme$person,sd)
mean(tapply(dat.lme$ESM_1,dat.lme$person,sd),na.rm=T)

#lme4
lme1 <- lmer(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med+(1|person) , dat.lme, REML=F)
(s <- summary(lme1))

#nlme (blir samma)
lme2 <- lme(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, random=list(~1|person), dat.lme,method="ML")
(s <- summary(lme2))
anova(lme2)
#variation in intercept between individuals: basically the same as in the model output, under random effects "Intercept"
sd(lme2$coefficients$random$person)

# GLS in nlme
gls1 <- gls(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, weights=~person, dat.lme ,method="ML", na.action=na.omit)
(s <- summary(gls1))

# Fixed plm doesnt work, duplicated obs
fixed <- plm(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, data=dat.lme, index=c("person"), model="within")
summary(fixed)

# Random plm
random <- plm(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, data=dat.lme, index=c("person"), model="random")
summary(random)

#With glm:
glm1 <- glm(ESM_1~casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,dat.lme,family="gaussian")
summary(glm1)
anova(glm1,test="Chisq")
#Loop:
library(nlme)
#calculate models with LAPPLY
models1 <- lapply(dat.lme[,var1], function(q){
   lme(q ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random = ~1|person,
            na.action=na.omit,
            data=dat.lme)
    })

summary(models1$IL_8)
anova(models1$IL_8,test="Chisq")
```

Mixed models loop:

```{r mixed effects models,echo=F}

# Data fix 
dat.lme <- dat1
var <- dplyr::select(dat1, IL_8:FR_alpha) %>% names()

# Physical activity vairabel
dat.lme["phys"] <- dat.lme$g6
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="2") 

# Variables with many missing: Remove with over 50% missing
dat.11 <- dplyr::select(dat.lme,one_of(var))
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])
# Remove them: (only important if dat1 is used)
# Remove TRAIL because it is the same as TNFSF10
dat <- dplyr::select(dat.11,-one_of(c(manyna1)),-TRAIL)
var1 <- names(dat)
alpha <- 0.05/length(var1)

#Set outliers to NA (>3 in standardized pearson residual in the analyses)
load("/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/residual analysis/outliers.RData")
for(i in 1:nrow(outliers)){
  dat.lme[dat.lme$id==outliers[i,"id"], as.character(outliers[i,"variable"])] <- NA
}


#
# Model fitting 
# Lifestyle variables: KÖR BMI för sig, verkar vara problem
cov <- c("casecontrol","age","gender","langd","vikt","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
p <- length(cov)
covm <- c("casecontrol","age","gender","phys","smoke","bmi","bmi2","stg2","ht2","gluc2","skol2",
          "metsz","mets2","bmiz","stgz","midbpz","blods0z","skolz") 
pm <- length(covm)
# Matrix to store estimate in:
mod1 <- matrix(nrow=ncol(dat),ncol=length(cov))
coef1 <- sd1 <- matrix(nrow=ncol(dat),ncol=length(cov)+2)
mod.mets1 <- matrix(nrow=ncol(dat),ncol=12)
coef.mets1 <- sd.mets1 <- matrix(nrow=ncol(dat), ncol=12) 
# colnames
colnames(mod1) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
colnames(coef1) <-  colnames(sd1) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Ex.smoking","Snus","Ex.snus","Medications")
colnames(mod.mets1) <-  c("MetS_score","MetS_groups",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score",
                          "BMI_groups","Triglycerices_groups","Hypertension","Glucose_groups","Cholesterol_groups")
colnames(coef.mets1) <- colnames(sd.mets1) <- c("MetS_score","MetS_groups",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score",
                          "BMI_groups","Triglycerices_groups","Hypertension","Glucose_groups","Cholesterol_groups")
# rownames
rownames(mod1) <- rownames(coef1)<- rownames(sd1) <- rownames(mod.mets1) <- rownames(coef.mets1)  <- rownames(sd.mets1) <- var1 
# residuals:
res.proteins <- dat.lme[,var1]
# intraclass correlations:
icc <- numeric(length(var1))
names(icc) <- var1
icc.lifestyle <- numeric(length(var1))
names(icc.lifestyle) <- var1
icc.mets <- numeric(length(var1))
names(icc.mets) <- var1
# Rsq conditional and marginal
r2 <- data.frame(var=var1,r2m=numeric(length(var1)),r2c=numeric(length(var1)),
                 r2m.mets=numeric(length(var1)),r2c.mets=numeric(length(var1)),
                 r2m.comp=numeric(length(var1)),r2c.comp=numeric(length(var1)),
                 r2m.life=numeric(length(var1)),r2c.life=numeric(length(var1)))
#
# Main loop:
#
j=0
for(i in var1){
  j=j+1
  cat(length(var1)-j," ")
  dat.lme["var"] <- dat.lme[,i]
  #Emply model
  g <- lme(var~casecontrol+age+gender+phys+smoke, 
            random =list(~1|person),
            na.action=na.exclude, method="ML",
            data=dat.lme)
  #icc empty
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icc[j] <- varests[1]/sum(varests)
  # Rsq empty:
    g <- lme(var~casecontrol+age+gender+phys+smoke, random =list(~1|person),  na.action=na.omit, method="ML",  data=dat.lme)
    r <-  r.squaredGLMM(g)
    r2[j,2] <- r[1]
    r2[j,3] <- r[2]
  # MODELs lifestyle
    g <- lme(var~casecontrol+age+gender+langd+vikt+phys+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.exclude, method="ML",
            data=dat.lme)
    # p-values
    a <-   anova(g)
    s <- summary(g)
    mod1[j,] <- a$`p-value`[-1]
    # Coefficients
    coef1[j,] <- s$tTable[-1,1]
    # SD
    sd1[j,] <- s$tTable[-1,2]
    # Intercept : between-subjects variace, residual: within subject variance
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icc.lifestyle[j] <- varests[1]/sum(varests)
    #Rsq lifestyle
    g <- lme(var~casecontrol+age+gender+langd+vikt+phys+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.omit, method="ML",
            data=dat.lme)
     r <-  r.squaredGLMM(g)
    r2[j,8] <- r[1]
    r2[j,9] <- r[2]
 # MODELs MetS
    g1 <- lme(var~metsz+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g2 <- lme(var~mets2+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g3 <- lme(var~bmiz+stgz+midbpz+blods0z+skolz+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g4 <- lme(var~bmi2+stg2+ht2+gluc2+skol2+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    #ICC
    varests <- as.numeric(VarCorr(g1)[c(1,2)]) 
    icc.mets[j] <- varests[1]/sum(varests)
    #Resiudals:
    res.proteins[,i] <- residuals(g1, type="pearson")
    # P-values
    mod.mets1[j,1] <- anova(g1)$`p-value`[2]
    mod.mets1[j,2] <- anova(g2)$`p-value`[2]
    mod.mets1[j,3:7] <- anova(g3)$`p-value`[2:6]
    mod.mets1[j,8:12] <- anova(g4)$`p-value`[2:6]

    # Coefficients
    coef.mets1[j,1] <- summary(g1)$tTable[2,1]
    coef.mets1[j,2] <- summary(g2)$tTable[2,1]
    coef.mets1[j,3:7] <- summary(g3)$tTable[2:6,1]
    coef.mets1[j,8:12] <- summary(g4)$tTable[2:6,1]

    # sd
    sd.mets1[j,1] <- summary(g1)$tTable[2,2]
    sd.mets1[j,2] <- summary(g2)$tTable[2,2]
    sd.mets1[j,3:7] <- summary(g3)$tTable[2:6,2]
    sd.mets1[j,8:12] <- summary(g4)$tTable[2:6,2]
    #Rsq mets
    g1 <- lme(var~metsz+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.omit,method="ML",data=dat.lme)
    r <-  r.squaredGLMM(g1)
    r2[j,4] <- r[1]
    r2[j,5] <- r[2]
    #Rsq mets components
   g3 <- lme(var~bmiz+stgz+midbpz+blods0z+skolz+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.omit,method="ML",data=dat.lme)
     r <-  r.squaredGLMM(g3)
    r2[j,6] <- r[1]
    r2[j,7] <- r[2]
}

res.proteins["id"] <- dat.lme$id

```

plot residuals:
  
```{r plot residuals}
#Histograms
res.proteins %>% melt() %>% ggplot(aes(x=value)) + geom_histogram() + facet_wrap(~variable,scales="free")

#Variables with potential outliers found from inspecting histograms::

# alla med >3 i pearson residual:
gdat <- res.proteins %>%mutate(index=seq(1,nrow(res.proteins)), id=as.character(dat.lme$id)) %>% melt(id=c("index","id")) 
outliers <- gdat[is.na(gdat$value)==F&abs(gdat$value)>3,]
tab(drop.levels(outliers$variable))

# plotta de med över 3 i pearson residual visas
res.proteins %>% dplyr::select(one_of(as.character(outliers$variable))) %>% 
  mutate(index=seq(1,nrow(res.proteins)), id=as.character(dat.lme$id)) %>% 
  melt(id=c("index","id")) %>% mutate(out=as.factor(ifelse(abs(value)>3,"outlier","normal"))) %>% 
  ggplot(aes(x=index,y=value,col=out)) +
  geom_point(size=1) + 
  scale_colour_manual(values=c("black","red")) +
  facet_wrap(~variable,scales="free") 

```

Get significant varaibles:
```{r get significants}

# Significant lifestyle variables
modf.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
modm <- data.frame(var=rownames(modf.bh0),ifelse(modf.bh0<=0.05,1,0)) 
signm <- mutate(modm,sum.sign=rowSums(modm[,-1])) %>% filter(sum.sign>0) #get significant variables 
signm <- signm[order(signm$var),]
coefm <- data.frame(var=rownames(coef1),coef1)
signm 

# Significant MetS
mets.bh1 <- apply(mod.mets1, 2, p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.sign <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,2:8])) %>% filter(sum.sign>0) 
mets.sign <- mets.sign[order(mets.sign$var),]
mets.coef <- data.frame(var=rownames(coef.mets1),coef.mets1)
mets.sign 

write.xlsx(mets.sign, file ="mets sign.xlsx",sheetName = "TestSheet", row.names = T)


# Skapa Sophias excel-fil:
# Get names
ProteinNames <- read.csv("~/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/ProteinNames.csv", sep=";")
# adj p
mod.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
mod.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")
sop <- data.frame(r2, icc=icc.mets, 
                  padj=mod.bh0[,2],age=coef1[,2],agesd=sd1[,2],
                  padj=mod.bh0[,3],sex=coef1[,3],sexsd=sd1[,3],
                  padj=mod.bh0[,4],height=coef1[,4],heightsd=sd1[,4],
                  padj=mod.bh0[,5],weight=coef1[,5],weightsd=sd1[,5],
                  padj=mod.bh0[,6],phys=coef1[,6],physsd=sd1[,6],

                  padj=mod.bh1[,1],MetS_score=coef.mets1[,1],sd=sd.mets1[,1],
                  padj=mod.bh1[,2],MetS_groups=coef.mets1[,2],sd=sd.mets1[,2],
                  padj=mod.bh1[,3],BMI_score=coef.mets1[,3],sd=sd.mets1[,3],
                  padj=mod.bh1[,4],Triglycerices_score=coef.mets1[,4],sd=sd.mets1[,4],
                  padj=mod.bh1[,5],MidBP_score=coef.mets1[,5],sd=sd.mets1[,5],
                  padj=mod.bh1[,6],P.glucose_score=coef.mets1[,6],sd=sd.mets1[,6],
                  padj=mod.bh1[,7],Cholesterol_score=coef.mets1[,7],sd=sd.mets1[,7],
                  
                  padj=mod.bh1[,8],BMI_groups=coef.mets1[,8],sd=sd.mets1[,8],
                  padj=mod.bh1[,9],Triglycerices_groups=coef.mets1[,9],sd=sd.mets1[,9],
                  padj=mod.bh1[,10],Hypertension=coef.mets1[,10],sd=sd.mets1[,10],
                  padj=mod.bh1[,11],P.glucose_groups=coef.mets1[,11],sd=sd.mets1[,11],
                  padj=mod.bh1[,12],Cholesterol_groups=coef.mets1[,12],sd=sd.mets1[,12])
#names(sop) <- c(names(r2),"icc",rep(c("padj","coef","sd"),17))             
sop <- sop[order(sop$var),]
sop2 <- merge(sop,ProteinNames,by="var",all.x=T)

# Export estimates to excel
#write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
#write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
write.xlsx(sop2, file ="sophia.xlsx",sheetName = "TestSheet", row.names = T)

```


ICC
ICC = proportion of total variance that is "between groups." 

```{r plot ICC}
#Plot ICCs
gdata <- data.frame(var1=var1,icc=icc) 
ggplot(gdata,aes(x=reorder(var1,icc),y=icc)) +
  geom_bar(stat="identity",width=.15) +
  geom_point(size=1)+
  coord_flip() 
```

Proteins with low and high icc?
ICC = proportion of total variance that is "between groups." 
Proteins with low ICCs, "more black", that is higher variation within indiviuals, between the two samples. 
Proteins with high ICCs, "less black", more variation between individuals. Most individuals have little diff between two samples.

```{r icc plot variables with extreme ICC}
# ICC under 0.1 - little of variation is between individuals (more within individuals)
icclow <- names(icc[icc<0.05])
dplyr::select(dat.lme,person,provnr,one_of(icclow)) %>% melt(id=c("person","provnr")) %>% 
  ggplot(aes(y=value, x=as.factor(person),color=as.factor(provnr))) +
  geom_point(size=0.5) + 
  geom_line(aes(group=as.factor(person)),color="black") + 
  facet_wrap(~variable,scales="free") + theme_bw() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())

# ICC over 0.8 - much of total variation is between indiviuals
icclow <- names(icc[icc>0.9])
dplyr::select(dat.lme,person,provnr,one_of(icclow)) %>% melt(id=c("person","provnr")) %>% 
  ggplot(aes(y=value, x=as.factor(person),color=as.factor(provnr))) +
  geom_point(size=0.5) + 
  geom_line(aes(group=as.factor(person)),color="black") + 
  facet_wrap(~variable,scales="free") + theme_bw() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())

```


Plot R2
```{r r squared plot}
r2 <- mutate(r2, icc=icc, icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1),labels=c("<25%","25-50%","50-75%",">75%")),
             sign=ifelse(r2$var %in% mets.sign$var,1,0), 
             r2mchange=r2m.mets-r2m,
             r2m.mets3=cut(r2m.mets,breaks=c(0,0.1,0.2,0.3),labels=c("<10%","10-20%","20-30%")),
             r2c.mets4=cut(r2c.mets,breaks=c(0,0.25,0.5,0.75,1),labels=c("<25%","25-50%","50-75%",">75%")),
             r2mchange3=cut(r2mchange,breaks=c(-0.1,0.05,0.1,0.15,0.20,0.3),labels=c("<5%","5-10%","10-15%","15-20%","20-30%")),
             r2mchange.comp=r2m.comp-r2m,
             r2m.comp3=cut(r2m.comp,breaks=c(0,0.1,0.2,0.3),labels=c("<10%","10-20%","20-30%")),
             r2c.como4=cut(r2c.comp,breaks=c(0,0.25,0.5,0.75,1),labels=c("<25%","25-50%","50-75%",">75%")),
             r2mchange.comp3=cut(r2mchange.comp,breaks=c(-0.1,0.05,0.1,0.15,0.20,0.3),labels=c("<5%","5-10%","10-15%","15-20%","20-30%")))
levels(r2$var) <- gsub("_","-",levels(r2$var))

# MetS 
ggplot(r2, aes(x=r2mchange, y=r2m.mets, color=icc4, label=var)) + geom_point(aes(size=r2mchange),alpha=0.8) + 
  geom_text(aes(size=r2mchange), nudge_x = 0.001,nudge_y = -0.005,vjust="inward",hjust="inward") + 
  geom_text(data=r2[r2$sign==1,], aes(x=r2mchange, y=r2m.mets, color=icc4, label=var, size=r2mchange), 
            nudge_x = 0.001,nudge_y = -0.005,vjust="inward",hjust="inward",col="black") + 
  scale_size(range = c(1,7), guide = FALSE) +
  scale_color_discrete(name = "ICC") +
  xlab("Change in variance explained\n by including MetS") + ylab("Variance explained by fixed factors")

# MetS components
ggplot(r2, aes(x=r2mchange.comp, y=r2m.comp, color=icc4, label=var)) + geom_point(aes(size=r2mchange.comp),alpha=0.8) + 
  geom_text(aes(size=r2mchange.comp), nudge_x = 0.001,nudge_y = -0.005,vjust="inward",hjust="inward") + 
  geom_text(data=r2[r2$sign==1,], aes(x=r2mchange.comp, y=r2m.comp, color=icc4, label=var, size=r2mchange.comp), 
            nudge_x = 0.001,nudge_y = -0.005,vjust="inward",hjust="inward",col="black") + 
  scale_size(range = c(1,7), guide = FALSE) +
  scale_color_discrete(name = "ICC") +
  xlab("Change in variance explained\n by including MetS components") + ylab("Variance explained by fixed factors")

```

Volcano plot
```{r volcano plot}
# p-threshold
pthreshold = -log10(0.05/length(icc.mets))

#MetS
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc,coef=coef.mets1[,1] ,p=mod.mets1[,1],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS") +
  #theme_bw() +
  xlab("Coefficient MetS") + ylab("log10 P-value")


#BMI
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef.mets1[,3] ,p=mod.mets1[,3],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange.comp3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS components") +
  #theme_bw() +
  xlab("Coefficient BMI") + ylab("log10 P-value")

#Trig
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef.mets1[,4] ,p=mod.mets1[,4],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange.comp3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS components") +
  #theme_bw() +
  xlab("Coefficient Triglycerides") + ylab("log10 P-value")

#HT
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef.mets1[,10] ,p=mod.mets1[,10],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange.comp3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS components") +
  #theme_bw() +
  xlab("Coefficient Hypertension") + ylab("log10 P-value")

#Mid BP
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef.mets1[,5] ,p=mod.mets1[,5],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange.comp3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS components") +
  #theme_bw() +
  xlab("Coefficient Mid-BP") + ylab("log10 P-value")

#P-glucose
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef.mets1[,6] ,p=mod.mets1[,6],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange.comp3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS components") +
  #theme_bw() +
  xlab("Coefficient p-glucose") + ylab("log10 P-value")

#Total cholesterol
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef.mets1[,7] ,p=mod.mets1[,7],
                   r2m.mets3=r2$r2m.mets3, r2mchange=r2$r2mchange, r2mchange3=r2$r2mchange3,r2mchange.comp3=r2$r2mchange.comp3) %>% 
  mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange.comp3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Change in variance explained\n by including MetS components") +
  #theme_bw() +
  xlab("Coefficient total cholesterol") + ylab("log10 P-value")

#LIfestyle
#Age
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef1[,2] ,p=mod1[,2],
                   r2m.life=r2$r2m.life, r2c.life=r2$r2c.life) %>% 
        mutate(r2m.life4=cut(r2m.life,breaks=c(0,0.1,0.2,0.3,0.4),labels=c("<10%","10-20%","20-30%","30-40%"))) %>% 
        mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2m.life4)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Variance explained by fixed factors") +
  #theme_bw() +
  xlab("Coefficient Age") + ylab("log10 P-value")

#Sex
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef1[,3] ,p=mod1[,3],
                   r2m.life=r2$r2m.life, r2c.life=r2$r2c.life) %>% 
        mutate(r2m.life4=cut(r2m.life,breaks=c(0,0.1,0.2,0.3,0.4),labels=c("<10%","10-20%","20-30%","30-40%"))) %>% 
        mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2m.life4)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Variance explained by fixed factors") +
  #theme_bw() +
  xlab("Coefficient Sex (female)") + ylab("log10 P-value")

#Smoking
volc <- data.frame(var=gsub("_","-",names(icc.mets)),icc=icc, coef=coef1[,13] ,p=mod1[,13],
                   r2m.life=r2$r2m.life, r2c.life=r2$r2c.life) %>% 
        mutate(r2m.life4=cut(r2m.life,breaks=c(0,0.1,0.2,0.3,0.4),labels=c("<10%","10-20%","20-30%","30-40%"))) %>% 
        mutate(plog=-log10(p), icc4=cut(icc, breaks=c(0,0.25,0.5,0.75,1)))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2m.life4)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,6), guide = FALSE) + 
  #scale_color_discrete(name = "Variance explained\n by fixed factors") +
  scale_color_discrete(name = "Variance explained by fixed factors") +
  #theme_bw() +
  xlab("Coefficient Smoking (smokers)") + ylab("log10 P-value")
```


Plot significant variabls in mixed models:

```{r univariate assoc plots mixed models,echo=F}

# PLOTTING  
#Loop som plottar alla singificanta associationer:
cov <- c("age","gender","langd","vikt","g6","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
nam <- c("Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
coef1 <- as.data.frame(coef1)
sd1 <- as.data.frame(sd1)
str(dat.lme[,cov])
k=0
for(i in cov){
  k=k+1
  # Ta ut significants
  s1 <- signm[,c("var",nam[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  coef <- dplyr::select(coef1,contains(nam[k]))
  coef <- as.matrix(coef[nn,])
  sd <- dplyr::select(sd1,contains(nam[k]))
  sd <- as.matrix(sd[nn,])
  s1 <- data.frame(s1,Coef=round(coef,4),SE=round(sd,4))
  cat("\nSignificant associations: \n")
  print(nam[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
  #Samma som i Enroth?
  if(nam[k] %in% names(natcom)){
    nat1 <- natcom[natcom[,nam[k]]>0,]
  cat("\nAlso significant in Enroth 2014 \n")
  print(s1[s1[,1] %in% nat1[,1],])
  }else cat("\nCovariate not included in Enroth 2014 \n")
  # Plotta 
  if(sum(signm[,nam[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme[,i])==T){ 
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
    #,
  }else{
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  } 
}

```

Plot significant variables in mixed models: pooled prov 1 o 
Not as clear

```{r univariate plots mixed models,echo=F}

# PLOTTING
#Loop som plottar alla singificanta associationer:
cov <- c("age","gender","langd","vikt","g6","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
nam <- c("Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
coef1 <- as.data.frame(coef1)
sd1 <- as.data.frame(sd1)
str(dat.lme[,cov])
k=0
for(i in cov){
  k=k+1
  # Ta ut significants
  s1 <- signm[,c("var",nam[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  coef <- dplyr::select(coef1,contains(nam[k]))
  coef <- as.matrix(coef[nn,])
  sd <- dplyr::select(sd1,contains(nam[k]))
  sd <- as.matrix(sd[nn,])
  s1 <- data.frame(s1,Coef=round(coef,4),SE=round(sd,4))
  cat("\nSignificant associations: \n")
  print(nam[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
  #Samma som i Enroth?
  if(nam[k] %in% names(natcom)){
    nat1 <- natcom[natcom[,nam[k]]>0,]
  cat("\nAlso significant in Enroth 2014 \n")
  print(s1[s1[,1] %in% nat1[,1],])
  }else cat("\nCovariate not included in Enroth 2014 \n")
  # Plotta 
  if(sum(signm[,nam[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme[,i])==T){ 
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
    #,
  }else{
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=gdata2[,i]))+
    geom_smooth(method="lm",color="black")+
    geom_point(position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  } 
}



```

Plot significant BMI/MetS variables:

```{r plot METS/BMI associations,echo=F}

# PLOTTING  
#Loop som plottar alla singificanta associationer:
# 2*2 plots: 6*7 inch
# 3*3 plots: 9*10.5 inch

nam <- colnames(mod.mets1)
covm <- c("bmi3","bmi","mets2","metsz","ht2","htm")
str(dat.lme[,covm])
dat.lme$ht2 <- as.factor(dat.lme$ht2)
dat.lme$htm <- as.factor(dat.lme$htm)
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="1") 
k=0
for(i in covm){
  k=k+1
  # Ta ut significants
  s1 <- mets.sign[,c("var",nam[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  if(nam[k]=="BMIgroups"){
    s1 <- data.frame(s1,coef=round(mets.coef[nn,2:4],4))
  }else{ s1 <- data.frame(s1,coef=round(mets.coef[nn,nam[k]],4)) } 
  cat("\nSignificant associations: \n")
  print(nam[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
  # Plotta 
  if(sum(mets.sign[,nam[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme[,i])==T){ 
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    levels(gdata2$variable) <- gsub('_', '-', levels(gdata2$variable))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  }else{
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    levels(gdata2$variable) <- gsub('_', '-', levels(gdata2$variable))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  } 
}

```

Plot variables with potential relation to physical activity:

```{r plot physical activity associations,echo=F}
#Variables related to Phys-activity:
phys1 <- data.frame(var=rownames(mod1),
                    p=mod1[,"Physical.activity"],padj=p.adjust(mod1[,"Physical.activity"],method="bonferroni"),
                    coef=coef1[,"Physical.activity"],sd=sd1[,"Physical.activity"])
phys1 <- filter(phys1,p<0.05)
#phys1 <- filter(phys1,padj<0.9)
phys1 <- phys1[order(phys1$p,decreasing = F),]
nn <- as.character(phys1$var)

# Plot:
gdata <- dat.lme[,c("phys","provnr",nn)]
gdata$provnr <- as.factor(gdata$provnr)
gdata$phys <- as.factor(gdata$phys)
names(gdata) <- gsub('_', '-', names(gdata))
gdata2 <- melt(gdata,id=c("phys","provnr"))
# Print variables:
phys1
# plot
ggplot(na.omit(gdata2),aes(y=value,x=provnr,fill=phys))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=phys),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+
    xlab("Sample")+ylab("") + 
    scale_colour_discrete(guide = FALSE) + 
    scale_fill_discrete(name = "Physical activity")

#as continous:
#ggplot(gdata2,aes(y=value,x=as.numeric(phys),fill=provnr))+
#    geom_smooth(aes(color=provnr),method="lm",color="black") +
#    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
#    facet_wrap(~variable,scales="free")+theme_bw()+xlab("Physical activity")+ylab("")

levels(phys1$var) <- gsub('_', '-', levels(phys1$var))
write.xlsx(phys1, file ="phys2 significants.xlsx",sheetName = "TestSheet", row.names = T)

```


Mets Matched line plot prov 1 och 2:
```{r mets match line plots,echo=F}
x1 <- c("CCL4","FGF_21","FURIN","HGF","LYPD3","SCF","SEZ6L")
x2 <- c("ERBB2","ESM_1","FGF_21","FGF_BP1","FURIN","HGF","IL_18R1","IL_7","IL_8","LYPD3","SCF","TNFSF14","VEGFR_2")

#mets continous
gdata <- dplyr::select(dat.lme,metsz,provnr,person,one_of(x2))
gdata$provnr <- as.factor(gdata$provnr)
gdata2 <- melt(gdata,id=c("metsz","provnr","person"))
gdata2 <- gdata2[order(gdata2$provnr),]
# Skapa diff variabel mellan prov 1 och 2 för mets och markörer 
gdata2 <- transform(gdata2, 
          metsdiff=ave(metsz, person, variable,  FUN=function(x) diff(x)),
          valuediff=ave(value, person, variable,  FUN=function(x) diff(x)))
gdata2 <- mutate(gdata2,
                 metschange=ifelse(metsdiff>0,"increase","decrease"),
                 valuechange=ifelse(valuediff>0,"increase","decrease"),
                 metsvaluechange=interaction(metschange,valuechange))
#colors:
pal <- c("dodgerblue","dodgerblue4","firebrick","darkorchid","gold","darkorange")

# plot
ggplot(gdata2,aes(y=value,x=metsz))+
    geom_smooth(aes(fill=provnr),method="lm",color="black",alpha=0.3)+
    geom_line(aes(group=as.factor(person),color=metsvaluechange),alpha=0.8,size=0.5)+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab("MetS continous")+ylab("")+
    scale_fill_manual(values=pal)+
    scale_color_manual(values=pal)

# Mets groups - blir shit! 
gdata <- dplyr::select(dat.lme,mets2,provnr,person,one_of(x1))
gdata$provnr <- as.factor(gdata$provnr)
gdata2 <- melt(gdata,id=c("mets2","provnr","person"))
# plot
ggplot(gdata2,aes(y=value,x=provnr,fill=mets2))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_line(aes(group=as.factor(person)),position=position_dodge(width=0.7),alpha=0.4,size=0.3)+
    #geom_point(aes(color=mets2),position=position_dodge(width=0.7),size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab("MetS yes/no")+ylab("")
#position = position_jitterdodge()

```


MetS changed over time? Predict MetS in sample 2? 

```{r mets predict testing,echo=F}
# Significant variables with mets2
x1 <- c("CCL4","FGF_21","FURIN","HGF","LYPD3","SCF","SEZ6L")
x2 <- c("ERBB2","ESM_1","FGF_21","FGF_BP1","FURIN","HGF","IL_18R1","IL_7","IL_8","LYPD3","SCF","TNFSF14","VEGFR_2")

# Några saknar upprepade prover: Samma om man använder LOB eller NA data
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1,y=dat.2,by="person")

# View sample 1 and 2 BMI / MetS
dat.diff <- dplyr::select(dat.rep,casecontrol.x,age.x,age.y,mets2.x,mets2.y,bmi.x,bmi.y,vikt.x,vikt.y,langd.x,FURIN.x,FURIN.y) %>% 
  mutate(mets.diff = as.numeric(mets2.y)-as.numeric(mets2.x))
View(dat.diff)
table(dat.diff$mets.diff)
dplyr::filter(dat.diff,mets.diff==1) %>% View()

#Predict sample 2 MetS
# Log-reg of yes/no mets variable:
form <- as.formula(paste0("mets2.y~mets2.x+age.x+gender.x+casecontrol.x+",paste0(x1,".x",collapse="+")))
pred1 <- glm(form,
             data=dat.rep,
             family="binomial")
summary(pred1)
cbind(round(exp(cbind(OR = coef(pred1), confint(pred1))),2))

# Lin-reg of metsz
form <- as.formula(paste0("metsz.y~metsz.x+age.x+gender.x+casecontrol.x+",paste0(x2,".x",collapse="+")))
pred2 <- lm(form, data=dat.rep)
summary(pred2)

```


###Differences by differences analysis

```{r difference lm models,echo=F}
# Data fix 
dat.lme <- dat1

# Physical activity vairabel
dat.lme["phys"] <- dat.lme$g6
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="2") 

# Variables with many missing: Remove with over 50% missing
dat.11 <- dplyr::select(dat.lme,one_of(var))
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])

# Remove them: (only important if dat1 is used)
# Remove TRAIL because it is the same as TNFSF10
dat <- dplyr::select(dat.11,-one_of(c(manyna1)),-TRAIL) 
var1 <- names(dat)
alpha <- 0.05/length(var1)

# some dont have repeated samples:
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat.lme, !person %in% id2)

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1, y=dat.2, by="person")
dim(dat.rep)

#Set outliers to NA (>3 in standardized pearson residual in the analyses)
load("/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/residual analysis/outliersd.RData")
for(i in 1:nrow(outliers.d)){
  dat.rep[dat.rep$id==outliers.d[i,"id"], as.character(outliers.d[i,"variable"])] <- NA
}

#Create diff variables:
dat.rep <- dat.rep %>% mutate(mets.diff=metsz.y-metsz.x, 
                              phys.diff=phys.y-phys.x, weight.diff=vikt.y-vikt.x, bmi.diff=bmi.y-bmi.x, stg.diff=stg.y-stg.x,
                              sbt.diff=sbt.y-sbt.x, dbt.diff=dbt.y-dbt.x,midbp.diff=midbp.y-midbp.x,
                              blods0.diff=blods0.y-blods0.x, blods2.diff=blods2.y-blods2.x,  skol.diff=skol.y-skol.x,
                              bmiz.diff=bmiz.y-bmiz.x, stgz.diff=stgz.y-stgz.x, midbpz.diff=midbpz.y-midbpz.x,
                              blods0z.diff=blods0z.y-blods0z.x, skolz.diff=skolz.y-skolz.x)
#histograms
#dat.rep %>% dplyr::select(mets.diff:skolz.diff) %>% melt() %>% ggplot(aes(x=value)) + geom_histogram() + 
#  facet_wrap(~variable, scales="free")
#
# Model fitting 
# Matrix to store estimate in:
mod1.d <- matrix(nrow=ncol(dat),ncol=15)
coef1.d <- sd1.d <- matrix(nrow=ncol(dat),ncol=15+2)
mod.mets1.d <- matrix(nrow=ncol(dat),ncol=6)
coef.mets1.d <- sd.mets1.d <- matrix(nrow=ncol(dat), ncol=6) 
# colnames
colnames(mod1.d) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
colnames(coef1.d) <-  colnames(sd1.d) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Cholesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Ex.smoking","Snus","Ex.snus","Medications")
colnames(mod.mets1.d) <-  c("MetS_score",
                            "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score")
colnames(coef.mets1.d) <- colnames(sd.mets1.d) <- c("MetS_score",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score")
# rownames
rownames(mod1.d) <- rownames(coef1.d)<- rownames(sd1.d) <- rownames(mod.mets1.d) <- rownames(coef.mets1.d)  <- rownames(sd.mets1.d) <- var1 
# residuals:
res.proteins.d <- dat.rep[,paste0(var1,".x")];names(res.proteins.d) <- var1
# Rsq conditional and marginal
r2.d <- data.frame(var=var1, r2=numeric(length(var1)), r2.mets=numeric(length(var1)))

j=0
for(i in var1){
  j=j+1
  cat(length(var1)-j," ")
  dat.rep["var"] <- dat.rep[,paste(i,"y",sep=".")]-dat.rep[,paste(i,"x",sep=".")]
  #Empty model for R2
  g <- lm(var~casecontrol.x+age.x+gender.x+phys.diff+smoke.x,
            na.action=na.exclude,
            data=dat.rep)
  s <- summary(g)
  r2.d[j,2] <- s$adj.r.squared
  # MODELs lifestyle
    g <- lm(var~casecontrol.x+age.x+gender.x+langd.x+weight.diff+phys.diff+skol.diff+stg.diff+blods0.diff+blods2.diff+sbt.diff+dbt.diff
            +smoke.x+snus.x+med.x,
            na.action=na.exclude,
            data=dat.rep)
    # p-values
    a <-   anova(g)
    s <- summary(g)
    mod1.d[j,] <- a$`Pr(>F)`[1:15]
    # Coefficients
    coef1.d[j,] <- tidy(g)[2:18,2]
    # SD
    sd1.d[j,] <- tidy(g)[2:18,3]
 # MODELs MetS
    g1 <- lm(var~mets.diff+casecontrol.x+age.x+gender.x+phys.diff+smoke.x,
               na.action=na.exclude, data=dat.rep)
    #g3 <- lm(var~bmiz.diff+stgz.diff+midbpz.diff+blods0z.diff+skolz.diff+casecontrol.x+age.x+gender.x+phys.diff+smoke.x,
     #          na.action=na.exclude, data=dat.rep)
    g3 <- lm(var~bmi.diff+stg.diff+midbp.diff+blods0.diff+skol.diff+casecontrol.x+age.x+gender.x+phys.diff+smoke.x,
               na.action=na.exclude, data=dat.rep)
    #Resiudals:
    res.proteins.d[,i] <- residuals(g1, type="pearson")
    # P-values
    mod.mets1.d[j,1] <- anova(g1)$`Pr(>F)`[1]
    mod.mets1.d[j,2:6] <- anova(g3)$`Pr(>F)`[1:5]
    
    # Coefficients
    coef.mets1.d[j,1] <- tidy(g1)[2,2]
    coef.mets1.d[j,2:6] <- tidy(g3)[2:6,2]

    # sd
    sd.mets1.d[j,1] <- tidy(g1)[2,3]
    sd.mets1.d[j,2:6] <- tidy(g3)[2:6,3]
   
    #Rsquared:
    s <- summary(g1)
    r2.d[j,3] <- s$adj.r.squared

}

```

plot residuals:
```{r plot residuals}
res.proteins.d %>% melt() %>% ggplot(aes(x=value)) + geom_histogram() + facet_wrap(~variable,scales="free")

#Variables with potential outliers found from inspecting histograms:
# alla med >3 i pearson residual:
gdat <- res.proteins.d %>% mutate(index=seq(1,nrow(res.proteins.d)), id=as.character(dat.rep$id.x)) %>% melt(id=c("index","id")) 
outliers.d <- gdat[is.na(gdat$value)==F&abs(gdat$value)>3,]
tab(drop.levels(outliers.d$variable))

# plotta de med över 3 i pearson residual visas
res.proteins.d %>% dplyr::select(one_of(as.character(outliers.d$variable))) %>% 
  mutate(index=seq(1,nrow(res.proteins.d)), id=as.character(dat.rep$id.x)) %>% 
  melt(id=c("index","id")) %>% mutate(out=as.factor(ifelse(abs(value)>3,"outlier","normal"))) %>% 
  ggplot(aes(x=index,y=value,col=out)) +
  geom_point(size=1) + 
  scale_colour_manual(values=c("black","red")) +
  facet_wrap(~variable,scales="free") 

```


Get significants:
```{r get significants diff by diff}

# Significant lifestyle variables
modf.bh0 <- apply(mod1.d,2,p.adjust,method="bonferroni")
modm <- data.frame(var=rownames(modf.bh0),ifelse(modf.bh0<=0.05,1,0)) 
signm.d <- mutate(modm,sum.sign=rowSums(modm[,-1])) %>% filter(sum.sign>0) #get significant variables 
signm.d <- signm.d[order(signm.d$var),]
coefm.d <- data.frame(var=rownames(coef1.d),coef1.d)
signm.d

# Significant MetS
mets.bh1 <- apply(mod.mets1.d,2,p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.sign.d <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,2:7])) %>% filter(sum.sign>0) 
mets.sign.d <- mets.sign.d[order(mets.sign.d$var),]
mets.coef.d <- data.frame(var=rownames(coef.mets1.d),coef.mets1.d)
mets.sign.d

# Skapa Sophias excel-fil:
# adj p
mod.bh0 <- apply(mod1.d,2,p.adjust,method="bonferroni")
mod.bh1 <- apply(mod.mets1.d,2,p.adjust,method="bonferroni")
sop <- data.frame(r2,
                  padj=mod.bh0[,2],age=coef1[,2],agesd=sd1[,2],
                  padj=mod.bh0[,3],sex=coef1[,3],sexsd=sd1[,3],
                  padj=mod.bh0[,4],height=coef1[,4],heightsd=sd1[,4],
                  padj=mod.bh0[,5],weight=coef1[,5],weightsd=sd1[,5],
                  padj=mod.bh0[,6],phys=coef1[,6],physsd=sd1[,6],

                  mod.bh1[,1],coef.mets1[,1],sd.mets1[,1],
                  mod.bh1[,2],coef.mets1[,2],sd.mets1[,2],
                  mod.bh1[,3],coef.mets1[,3],sd.mets1[,3],
                  mod.bh1[,4],coef.mets1[,4],sd.mets1[,4],
                  mod.bh1[,5],coef.mets1[,5],sd.mets1[,5],
                  mod.bh1[,6],coef.mets1[,6],sd.mets1[,6],
                  mod.bh1[,7],coef.mets1[,7],sd.mets1[,7],
                  
                  mod.bh1[,8],coef.mets1[,8],sd.mets1[,8],
                  mod.bh1[,9],coef.mets1[,9],sd.mets1[,9],
                  mod.bh1[,10],coef.mets1[,10],sd.mets1[,10],
                  mod.bh1[,11],coef.mets1[,11],sd.mets1[,11],
                  mod.bh1[,12],coef.mets1[,12],sd.mets1[,12])
names(sop) <- c(names(r2),rep(c("padj","coef","sd"),17))                

sop <- sop[order(sop$var),]
# Export estimates to excel
#write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
#write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
write.xlsx(sop, file ="sophia.xlsx",sheetName = "TestSheet", row.names = T)

```

Plot R2
```{r r squared plot diff by diff}
r2.d <- mutate(r2.d, r2mchange=r2.mets-r2,
             sign=ifelse(r2$var %in% mets.sign$var,1,0), 
             r2m.mets3=cut(r2.mets,breaks=c(0,0.1,0.2,0.3),labels=c("<10%","10-20%","20-30%")),
             r2mchange3=cut(r2mchange,breaks=c(-1,0.05,0.1,0.15,0.20),labels=c("<5%","5-10%","10-15%","15-20%")))
levels(r2$var) <- gsub("_","-",levels(r2$var))

# used plot
ggplot(r2.d, aes(x=r2mchange, y=r2.mets, color=r2m.mets3, label=var)) + geom_point(aes(size=r2mchange),alpha=0.8) + 
  geom_text(aes(size=r2mchange), nudge_x = 0.001,nudge_y = -0.005,vjust="inward",hjust="inward") + 
  geom_text(data=r2.d[r2.d$sign==1,], aes(x=r2mchange, y=r2.mets, color=r2m.mets3, label=var, size=r2mchange), 
            nudge_x = 0.001,nudge_y = -0.005,vjust="inward",hjust="inward",col="black") + 
  scale_size(range = c(1,7), guide = FALSE) +
  scale_color_discrete(name = "Adjusted R2") +
  xlab("Change in Adjusted R2\n by including MetS") + ylab("Adjusted R2")

```

Volcano plot
```{r volcano plot diff by diff}
# p-threshold
pthreshold = -log10(0.05/length(icc.mets))

#MetS
volc <- data.frame(var=gsub("_","-",rownames(mod.mets1)), r2=r2.d$r2.mets, sign=r2.d$sign, r2mchange=r2.d$r2mchange,
                   r2m.mets3 =r2.d$r2m.mets3, coef=coef.mets1.d[,1], p=mod.mets1.d[,1], r2mchange3=r2.d$r2mchange3) %>% 
  mutate(plog =-log10(p))

ggplot(volc, aes(y=plog, x=coef, label=var, color=r2mchange3)) + 
  geom_point(aes(size=abs(coef))) + 
  geom_text(aes(size=abs(coef)), nudge_x = 0.002,vjust="inward",hjust="inward",alpha=0.8) + 
  geom_text(data=volc[volc$sign==1,], aes(y=plog, x=coef, label=var, size=abs(coef)), 
           nudge_x = 0.002,vjust="inward",hjust="inward",col="black") + 
  geom_hline(yintercept=pthreshold,lty=2) +
  scale_size(range = c(1,7), guide = FALSE) + 
  scale_color_discrete(name = "Change in adjusted R2\n by including MetS") +
  #theme_bw() +
  xlab("Coefficient MetS") + ylab("log10 P-value")

```


##Circos
Lifestyle associations

Circos Enroth Prov 1
```{r circos enroth replicataion,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))
par(mfrow=c(1,2))

# IN ENROTH DATA_

#Data fix
lf1 <- melt(natcom1,id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
#levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

# IN OUR DATA

#Data fix
lf1 <- melt(enroth1,id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
#levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```


Circos mixed models:

```{r circos LMM all,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix
lf1 <- dplyr::select(signm,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))
# lf1 is N*3 matrix, were columns correspond to c(variable 1, variable 2, measure),
# N is number of associations

# Circos plot
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=313,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 



```


Circos - MetS and BMI

```{r Circos LMM METS,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix
# Significant MetS
mets.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.sign <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,c(2:8)])) %>% filter(sum.sign>0) 
mets.sign <- mets.sign[order(mets.sign$var),]
mets.coef <- data.frame(var=rownames(coef.mets1),coef.mets1)
mets.sign

# SCore variables:
# Data frame: 
lf1 <-  dplyr::select(mets.sign, var, MetS_score, BMI_score:Cholesterol_score,Hypertension) %>% melt(id="var") %>% 
        mutate(variable=factor(variable, labels=c("MetS","BMI","Triglycerices", "Mid-BP", "P-glucose","Cholesterol","Hypertension")))
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))
lf1$var <- as.character(lf1$var)
#
#Add empty labels for MiD-BP, P-Glucose and Cholesterol
lf1 <- rbind(lf1,c(" ",levels(lf1$variable)[4],0.5))
lf1 <- rbind(lf1,c(" ",levels(lf1$variable)[5],0.5))
#
lf1$variable <- as.character(lf1$variable)
lf1$value <- as.numeric(lf1$value)

# Circos plot
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=277,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 15, rep(2, length(unique(lf1[[2]]))-1), 15))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue", "forestgreen", "darkgoldenrod1", "red","purple", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq
grid.col[13] <- "white"

#track colors
col <- as.factor(lf1$variable)
levels(col) <- grid.col[as.character(levels(col))]
levels(col)[c(5,6)] <- "white"
col <- as.character(col)

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col, 
             link.largest.ontop = TRUE,col=col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

# Group variables:

```

Circos plot: Anneli PA
  
```{r Circos LMM Physical activity,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix
# Significant BMI and Mets
m1 <- apply(mod.mets1[,c("BMIgroups","BMIcont")],2,p.adjust,method="bonferroni")
m2 <- apply(mod1[,c("Age","Sex","Smoking","Physical.activity")],2,p.adjust,method="bonferroni")
mm <- cbind(m1,m2)
mm <- data.frame(var=rownames(mm),ifelse(mm<=0.05,1,0)) 
mets.sign <- mutate(mm,sum.sign=rowSums(mm[,2:ncol(mm)])) %>% filter(sum.sign>0) 
mets.sign <- mets.sign[order(mets.sign$var),]
mets.sign <- dplyr::select(mets.sign, var, Age, BMIgroups:sum.sign)

# Data frame:
lf1 <- filter(mets.sign,var!="TRAIL") %>% dplyr::select(-sum.sign) %>% melt(id="var") %>% 
        mutate(variable=factor(variable, labels=c("Age","BMI (groups)","BMI (continuous)","Sex","Smoking","Physical activity"))) #%>% filter(variable!="HT",variable!="HT medication")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))
lf1$var <- as.character(lf1$var)
#
#Add empty labels for PA
lf1 <- rbind(lf1,c(" ",levels(lf1$variable)[6],0.5))
#
lf1$variable <- as.character(lf1$variable)
lf1$value <- as.numeric(lf1$value)

# Circos plot
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue", "forestgreen", "darkgoldenrod1", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq
grid.col[45] <- "white"

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col, 
             link.largest.ontop = TRUE) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```


#METHYLATION

## Methylation array data
```{r methylation data import}
# Load corrected beta values
load("~/Documents/DATA-filer/Sophiaearlydetection/methylation/beta_with_celltypes.RData")

# Load list of CpGs close to or within MetS significant proteins:
mets.cpg <- read.csv("~/Documents/DATA-filer/Sophiaearlydetection/methylation/MetS CpGs.csv", stringsAsFactors=FALSE)
mets.cpg <- dplyr::rename(mets.cpg,var=IlmnID)

# Get celltypes data
#load("~/Documents/DATA-filer/Sophiaearlydetection/methylation/celltypes.RData")
#celltype <- data.frame(Barcodesection=rownames(celltypes), celltypes)
#beta1 <- merge(beta1,celltype, by="Barcodesection")
#save(beta1, file="beta_with_celltypes.RData")

# get CpGs in significant proteins genes
cpg1 <- mets.cpg$var

#merge with olink/phen data frame:
beta1 <- dplyr::select(beta1, id, Barcodesection, CD8T, CD4T, NK , Bcell, Gran, Mono, one_of(cpg1))
cpg1 <- cpg1[!(cpg1 %in% c("cg04199023", "cg10588688", "cg24421822", "cg25862752"))] # remove missing cpgs from list
mets.cpg <- mets.cpg[!(mets.cpg$var %in% c("cg04199023", "cg10588688", "cg24421822", "cg25862752")),]

sum(beta1$id %in% dat1$id)
sum(beta1$id %in% phen$id)

dat1cpg <- merge(phen, beta1, by="id")
dat1cpg <- unite(dat1cpg,"person", caseset, casecontrol, remove=FALSE)


```

Histograms:


```{r histograms CpG,echo=F}
dplyr::select(dat1cpg, one_of(cpg1[1:221])) %>% melt() %>%
  ggplot(aes(x=value)) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 

dplyr::select(dat1cpg, one_of(cpg1[221:length(cpg1)])) %>% melt() %>%
  ggplot(aes(x=value)) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 


```

cell type distributions
```{r, cell type proportions}

dplyr::select(dat1cpg,  provnr, CD8T, CD4T, NK , Bcell, Gran, Mono) %>% melt(id="provnr") %>% 
  ggplot(aes(x=value, color=as.factor(provnr))) + geom_density() + geom_rug() + facet_wrap(~variable,scales="free")

```


Heatmap of levels
Rows are variables, columns are observations. Observations are sorted according to case. Gray squares indicate missing observations.

```{r 1 heatmap CpGs, fig.width=12, fig.height=8, message=FALSE, warnings=FALSE}
var <- cpg1

# Data fix  8*8 inch pic
dat11 <- dplyr::select(dat1cpg, provnr, casecontrol, person, one_of(var))  %>% 
          mutate(case=factor(casecontrol,labels=c("control","case")),
                 case.provnr=interaction(case,provnr), cpnum=as.numeric(case.provnr)) %>% 
          unite(person_case_provnr,case.provnr, person, sep=" ",remove=F)

# remove NAs
con <- dplyr::select(dat11, one_of(var), person_case_provnr,cpnum) %>% arrange(cpnum) %>% dplyr::select(-cpnum)

# Sort columns after amount of NA
n <- apply(con[,var],2,function(x) sum(is.na(x)))
n <- sort(n,decreasing=F)
n <- names(n)

# Heatmap 
# get rownames
df <- melt(con,id.vars="person_case_provnr")
df$person_case_provnr <- factor(df$person_case_provnr,levels=as.character(con$person_case_provnr))
df$variable <- factor(df$variable,levels=n)

ggplot(df, aes(y = variable, x = person_case_provnr)) + 
   geom_tile(aes(fill = value), colour = "white") + 
   scale_fill_gradient(low = "dodgerblue4", high = "gold", na.value="gray") +
   theme(axis.text.x = element_text(angle = 55, hjust = 1))+
   geom_vline(xintercept=which(levels(df$person_case_provnr) %in% c("control.1 22_0", "case.1 36_1", "control.2 48_0")) + c(0.5, 0.5, 0.5), col="black")
   


```

##Cluster analysis:

```{r CpG standardized cluster analysis ,echo=F, fig.pos = "H",fig.width=8, fig.height=8}
var <- cpg1

# Data fix 8*8 inch pic
# Remove many NAs ARE NONE! 
na1 <- apply(dat1cpg[,var],2,function(x) sum(is.na(x))/length(x))na1[na1>=0.15]
manyna1 <- names(na1[na1>=0.15])

#
# Data - provnr 
corre <-  dplyr::select(dat1cpg, provnr, gender, age4, bmi2, stg2, ht2, gluc2, mets2, one_of(var)) %>%
        mutate(bmi2=coalesce(as.integer(bmi2), 9999L), stg2=coalesce(as.integer(stg2), 9999L),
               ht2=coalesce(as.integer(ht2), 9999L), mets2=coalesce(as.integer(mets2), 9999L)) 

var1 <- dplyr::select(corre, one_of(var)) %>% names()
corre[,var1] <- scale(corre[,var1])
#Remove NAs
con <- na.omit(corre) 

heat <- dplyr::select(con, one_of(var))
heat <- heat %>% as.matrix()
heat <- t(heat)

#col legends
pal <- brewer.pal(4,"Set1")
con$stg2 <- as.character(factor(con$stg2, labels=c("gray95","black","gray")))
con$gluc2 <- as.character(factor(con$gluc2, labels=c("gray95","black")))
con$ht2 <-as.character(factor(con$ht2, labels=c("gray95","black","gray"))) 
con$bmi2 <- as.character(factor(con$bmi2, labels=c("gray95","black","gray")))
con$mets2 <- as.character(factor(con$mets2, labels=c("gray95","black","gray")))
con$gender <- as.character(factor(con$gender, labels=c("darkorange","brown")))
con$age4 <- as.character(factor(con$age4, labels=c("cyan","dodgerblue1","dodgerblue4","purple")))
con$provnr <- as.character(factor(con$provnr, labels=c("#F8766D", "#00BA38")))

fcol <- dplyr::select(con, provnr, age4, gender,mets2, bmi2, ht2, gluc2, stg2) %>% 
  dplyr::rename(Sample=provnr, Age=age4, Sex=gender, MetS=mets2, BMI_above_30=bmi2, Hypertension=ht2, 
                Raised_glucose=gluc2, Raised_triglycerides=stg2) %>% as.matrix()
colnames(fcol) <- gsub("_"," ",colnames(fcol))

# col heatmap
#my_palette <- colorRampPalette(c("dodgerblue4","goldenrod"))(200)
my_palette <- colorRampPalette(c("dodgerblue4","gray90","goldenrod"))(200)

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="average")}
dist.pear <- function(x) as.dist(1-cor(t(x),method="spearman",use="pairwise.complete.obs"))

# Plot Heatmap 
heatmap.3(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun = mydist,
          col=my_palette,
          margins=c(8,16), KeyValueName=" ",
          ColSideColors=fcol,ColSideColorsSize=6, RowSideColorsSize=2)

legend("topright", title = " ", 
       legend = c("Sample 1","Sample 2"," ","Age <40","Age 40-50","Age 50-60", "Age >60", " ", 
                  "Male", "Female", " ", "Positive", "Negative"," ","Missing"),
       fill= c("#F8766D", "#00BA38","white","cyan","dodgerblue1","dodgerblue4","purple","white", "darkorange","brown","white","black","gray95","white","gray"),
       border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)


```

##Associations CpG vs lifestyle

Principle component regression
```{r PCA regression}

#PCA: 
pca <- prcomp(dat1cpg[,cpg1], center = TRUE, scale. = TRUE) 
summary(pca)
plot(pca,type="l")
fviz_pca_var(pca,col.circle="black")+theme_bw()+xlim(-1,1)+ylim(-1,1)

pca1 <- data.frame(bmi3=dat1cpg[,"bmi3"],sex=dat1cpg$gender,age4=dat1cpg$age4,pca$x[,1:5])

#Plot loadings
melted <- data.frame(var=mets.cpg$var, var.group=mets.cpg$OLINK.Protein_name, pca$rotation[,1:10])
melted <- melt(melted, id=c("var","var.group"))
melted <- mutate(melted, index=rep(1:471, 10))

ggplot(data=melted) +
  geom_bar(aes(x=index, y=value, fill=var.group), stat="identity") +
  facet_wrap(~variable)

# Plot
scatterplotMatrix(~PC1+PC2+PC3+PC4+PC5|bmi3, data=pca1,main="PCA",by.groups=F,smoother=F,reg.line=F,col=c("red","blue","green","purple"),pch=c(18,20,22,24))

#Ad PCs as variables
pc <- colnames(pca$x[,1:50])
dat1cpg[,colnames(pca$x[,1:50])] <- pca$x[,1:50]

```

Mixed models loop PCAs:

```{r mixed effects models,echo=F}
var <- var1 <- pc

# Data fix 
dat.lme <- dat1cpg

# Physical activity vairabel
dat.lme["phys"] <- dat.lme$g6
alpha <- 0.05/length(var1)

#Set outliers to NA (>3 in standardized pearson residual in the analyses)
#load("/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/residual analysis/outliers.RData")
#for(i in 1:nrow(outliers)){
#  dat.lme[dat.lme$id==outliers[i,"id"], as.character(outliers[i,"variable"])] <- NA
#}

#
# Model fitting 
# Lifestyle variables: KÖR BMI för sig, verkar vara problem
cov <- c("casecontrol","age","gender","langd","vikt","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
p <- length(cov)
covm <- c("casecontrol","age","gender","phys","smoke","bmi","bmi2","stg2","ht2","gluc2","skol2",
          "metsz","mets2","bmiz","stgz","midbpz","blods0z","skolz") 
pm <- length(covm)
# Matrix to store estimate in:
mod1cpg <- matrix(nrow=length(var1),ncol=length(cov))
coef1cpg <- sd1cpg <- matrix(nrow=length(var1),ncol=length(cov)+2)
mod.mets1cpg <- matrix(nrow=length(var1),ncol=12)
coef.mets1cpg <- sd.mets1cpg <- matrix(nrow=length(var1), ncol=12) 
# colnames
colnames(mod1cpg) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
colnames(coef1cpg) <-  colnames(sd1cpg) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Ex.smoking","Snus","Ex.snus","Medications")
colnames(mod.mets1cpg) <-  c("MetS_score","MetS_groups",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score",
                          "BMI_groups","Triglycerices_groups","Hypertension","Glucose_groups","Cholesterol_groups")
colnames(coef.mets1cpg) <- colnames(sd.mets1cpg) <- c("MetS_score","MetS_groups",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score",
                          "BMI_groups","Triglycerices_groups","Hypertension","Glucose_groups","Cholesterol_groups")
# rownames
rownames(mod1cpg) <- rownames(coef1cpg)<- rownames(sd1cpg) <- rownames(mod.mets1cpg) <- rownames(coef.mets1cpg)  <- rownames(sd.mets1cpg) <- var1 
# residuals:
res.proteinscpg <- dat.lme[,var1]
# intraclass correlations:
icccpg <- numeric(length(var1))
names(icccpg) <- var1
icc.lifestylecpg <- numeric(length(var1))
names(icc.lifestylecpg) <- var1
icc.metscpg <- numeric(length(var1))
names(icc.metscpg) <- var1
# Rsq conditional and marginal
r2cpg <- data.frame(var=var1,r2m=numeric(length(var1)),r2c=numeric(length(var1)),
                 r2m.mets=numeric(length(var1)),r2c.mets=numeric(length(var1)),
                 r2m.comp=numeric(length(var1)),r2c.comp=numeric(length(var1)),
                 r2m.life=numeric(length(var1)),r2c.life=numeric(length(var1)))
#
# Main loop:
#
j=0
for(i in var1){
  j=j+1
  cat(length(var1)-j," ")
  dat.lme["var"] <- dat.lme[,i]
  tryCatch({
  #Emply model
  g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke, 
            random =list(~1|person),
            na.action=na.exclude, method="ML",
            data=dat.lme)
  #icc empty
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icccpg[j] <- varests[1]/sum(varests)
  # Rsq empty:
    g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke, random =list(~1|person),  na.action=na.omit, method="ML",  data=dat.lme)
    r <-  r.squaredGLMM(g)
    r2cpg[j,2] <- r[1]
    r2cpg[j,3] <- r[2]
  # MODELs lifestyle
    g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+langd+vikt+phys+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.exclude, method="ML",
            data=dat.lme)
    # p-values
    a <-   anova(g)
    s <- summary(g)
    mod1cpg[j,] <- a$`p-value`[8:22]
    # Coefficients
    coef1cpg[j,] <- s$tTable[8:24,1]
    # SD
    sd1cpg[j,] <- s$tTable[8:24,2]
    # Intercept : between-subjects variace, residual: within subject variance
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icc.lifestylecpg[j] <- varests[1]/sum(varests)
    #Rsq lifestyle
    g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+langd+vikt+phys+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.omit, method="ML",
            data=dat.lme)
     r <-  r.squaredGLMM(g)
    r2cpg[j,8] <- r[1]
    r2cpg[j,9] <- r[2]
 # MODELs MetS
    g1 <- lme(var~metsz+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g2 <- lme(var~mets2+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g3 <- lme(var~bmiz+stgz+midbpz+blods0z+skolz+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g4 <- lme(var~bmi2+stg2+ht2+gluc2+skol2+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    #ICC
    varests <- as.numeric(VarCorr(g1)[c(1,2)]) 
    icc.metscpg[j] <- varests[1]/sum(varests)
    #Resiudals:
    res.proteinscpg[,i] <- residuals(g1, type="pearson")
    # P-values
    mod.mets1cpg[j,1] <- anova(g1)$`p-value`[2]
    mod.mets1cpg[j,2] <- anova(g2)$`p-value`[2]
    mod.mets1cpg[j,3:7] <- anova(g3)$`p-value`[2:6]
    mod.mets1cpg[j,8:12] <- anova(g4)$`p-value`[2:6]

    # Coefficients
    coef.mets1cpg[j,1] <- summary(g1)$tTable[2,1]
    coef.mets1cpg[j,2] <- summary(g2)$tTable[2,1]
    coef.mets1cpg[j,3:7] <- summary(g3)$tTable[2:6,1]
    coef.mets1cpg[j,8:12] <- summary(g4)$tTable[2:6,1]

    # sd
    sd.mets1cpg[j,1] <- summary(g1)$tTable[2,2]
    sd.mets1cpg[j,2] <- summary(g2)$tTable[2,2]
    sd.mets1cpg[j,3:7] <- summary(g3)$tTable[2:6,2]
    sd.mets1cpg[j,8:12] <- summary(g4)$tTable[2:6,2]
    #Rsq mets
    g1 <- lme(var~metsz+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.omit,method="ML",data=dat.lme)
    r <-  r.squaredGLMM(g1)
    r2cpg[j,4] <- r[1]
    r2cpg[j,5] <- r[2]
    #Rsq mets components
   g3 <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+bmiz+stgz+midbpz+blods0z+skolz+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.omit,method="ML",data=dat.lme)
     r <-  r.squaredGLMM(g3)
    r2cpg[j,6] <- r[1]
    r2cpg[j,7] <- r[2]
    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}


```

Get significants
```{r PCA significants} 
# Significant lifestyle variables
modf.bh0 <- apply(mod1cpg,2,p.adjust,method="bonferroni")
modm <- data.frame(var=rownames(modf.bh0),ifelse(modf.bh0<=0.05,1,0)) 
signmcpg <- mutate(modm,sum.sign=rowSums(modm[,-1])) %>% filter(sum.sign>0) #get significant variables 
signmcpg <- signmcpg[order(signmcpg$var),]
signmcpg

# Significant MetS
mets.bh1 <- apply(mod.mets1cpg, 2, p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.signcpg <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,2:13])) %>% filter(sum.sign>0) 
mets.signcpg <- mets.signcpg[order(mets.signcpg$var),]
mets.signcpg

```

heatmap of p-values:
```{r}
gdat <- data.frame(var=rownames(mod.mets1cpg),mod.mets1cpg)
gdat <- gdat %>% melt(id="var")
gdat$var <- fct_relevel(gdat$var, pc)
gdat$value4 <- cut(gdat$value, breaks=c(0,0.001,0.05,1), labels=c("<0.001","<0.05"," "))
  
ggplot(gdat,aes(x = var, y = variable)) + 
   geom_tile(aes(fill = value), colour = "white") + 
    scale_fill_gradientn(values=c(1,0.001,0), colors=c("white","orange","red"),trans="log",
    breaks = c(0, 0.001, 0.05, 1))+
   theme(axis.text.x = element_text(angle = 55, hjust = 1))

#discrete tiles:
ggplot(gdat,aes(x = var, y = variable)) + 
   geom_tile(aes(fill = value4)) + 
   scale_fill_manual(values=c("red","orange","white"))+
   theme(axis.text.x = element_text(angle = 65, hjust = 1))+
  


```


Mixed models loop: enskilda 

```{r CpG mixed effects models,echo=F}
var <- var1 <- cpg1

# Data fix 
dat.lme <- dat1cpg

# Physical activity vairabel
dat.lme["phys"] <- dat.lme$g6
alpha <- 0.05/length(var1)

#Set outliers to NA (>3 in standardized pearson residual in the analyses)
load("/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/residual analysis/outlierscpg.RData")
for(i in 1:nrow(outliers)){
  dat.lme[dat.lme$id==outlierscpg[i,"id"], as.character(outlierscpg[i,"variable"])] <- NA
}

#
# Model fitting 
# Lifestyle variables: KÖR BMI för sig, verkar vara problem
cov <- c("casecontrol","age","gender","langd","vikt","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
p <- length(cov)
covm <- c("casecontrol","age","gender","phys","smoke","bmi","bmi2","stg2","ht2","gluc2","skol2",
          "metsz","mets2","bmiz","stgz","midbpz","blods0z","skolz") 
pm <- length(covm)
# Matrix to store estimate in:
mod1cpg <- matrix(nrow=length(var1),ncol=length(cov))
coef1cpg <- sd1cpg <- matrix(nrow=length(var1),ncol=length(cov)+2)
mod.mets1cpg <- matrix(nrow=length(var1),ncol=12)
coef.mets1cpg <- sd.mets1cpg <- matrix(nrow=length(var1), ncol=12) 
# colnames
colnames(mod1cpg) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
colnames(coef1cpg) <-  colnames(sd1cpg) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Ex.smoking","Snus","Ex.snus","Medications")
colnames(mod.mets1cpg) <-  c("MetS_score","MetS_groups",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score",
                          "BMI_groups","Triglycerices_groups","Hypertension","Glucose_groups","Cholesterol_groups")
colnames(coef.mets1cpg) <- colnames(sd.mets1cpg) <- c("MetS_score","MetS_groups",
                          "BMI_score","Triglycerices_score","MidBP_score","P.glucose_score","Cholesterol_score",
                          "BMI_groups","Triglycerices_groups","Hypertension","Glucose_groups","Cholesterol_groups")
# rownames
rownames(mod1cpg) <- rownames(coef1cpg)<- rownames(sd1cpg) <- rownames(mod.mets1cpg) <- rownames(coef.mets1cpg)  <- rownames(sd.mets1cpg) <- var1 
# residuals:
res.proteinscpg <- dat.lme[,var1]
# intraclass correlations:
icccpg <- numeric(length(var1))
names(icccpg) <- var1
icc.lifestylecpg <- numeric(length(var1))
names(icc.lifestylecpg) <- var1
icc.metscpg <- numeric(length(var1))
names(icc.metscpg) <- var1
# Rsq conditional and marginal
r2cpg <- data.frame(var=var1,r2m=numeric(length(var1)),r2c=numeric(length(var1)),
                 r2m.mets=numeric(length(var1)),r2c.mets=numeric(length(var1)),
                 r2m.comp=numeric(length(var1)),r2c.comp=numeric(length(var1)),
                 r2m.life=numeric(length(var1)),r2c.life=numeric(length(var1)))
#
# Main loop:
#
j=0
for(i in var1){
  j=j+1
  cat(length(var1)-j," ")
  dat.lme["var"] <- dat.lme[,i]
  tryCatch({
  #Emply model
  g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke, 
            random =list(~1|person),
            na.action=na.exclude, method="ML",
            data=dat.lme)
  #icc empty
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icccpg[j] <- varests[1]/sum(varests)
  # Rsq empty:
    g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke, random =list(~1|person),  na.action=na.omit, method="ML",  data=dat.lme)
    r <-  r.squaredGLMM(g)
    r2cpg[j,2] <- r[1]
    r2cpg[j,3] <- r[2]
  # MODELs lifestyle
    g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+langd+vikt+phys+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.exclude, method="ML",
            data=dat.lme)
    # p-values
    a <-   anova(g)
    s <- summary(g)
    mod1cpg[j,] <- a$`p-value`[8:22]
    # Coefficients
    coef1cpg[j,] <- s$tTable[8:24,1]
    # SD
    sd1cpg[j,] <- s$tTable[8:24,2]
    # Intercept : between-subjects variace, residual: within subject variance
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icc.lifestylecpg[j] <- varests[1]/sum(varests)
    #Rsq lifestyle
    g <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+langd+vikt+phys+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.omit, method="ML",
            data=dat.lme)
     r <-  r.squaredGLMM(g)
    r2cpg[j,8] <- r[1]
    r2cpg[j,9] <- r[2]
 # MODELs MetS
    g1 <- lme(var~metsz+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g2 <- lme(var~mets2+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g3 <- lme(var~bmiz+stgz+midbpz+blods0z+skolz+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    g4 <- lme(var~bmi2+stg2+ht2+gluc2+skol2+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.exclude,method="ML",data=dat.lme)
    #ICC
    varests <- as.numeric(VarCorr(g1)[c(1,2)]) 
    icc.metscpg[j] <- varests[1]/sum(varests)
    #Resiudals:
    res.proteinscpg[,i] <- residuals(g1, type="pearson")
    # P-values
    mod.mets1cpg[j,1] <- anova(g1)$`p-value`[2]
    mod.mets1cpg[j,2] <- anova(g2)$`p-value`[2]
    mod.mets1cpg[j,3:7] <- anova(g3)$`p-value`[2:6]
    mod.mets1cpg[j,8:12] <- anova(g4)$`p-value`[2:6]

    # Coefficients
    coef.mets1cpg[j,1] <- summary(g1)$tTable[2,1]
    coef.mets1cpg[j,2] <- summary(g2)$tTable[2,1]
    coef.mets1cpg[j,3:7] <- summary(g3)$tTable[2:6,1]
    coef.mets1cpg[j,8:12] <- summary(g4)$tTable[2:6,1]

    # sd
    sd.mets1cpg[j,1] <- summary(g1)$tTable[2,2]
    sd.mets1cpg[j,2] <- summary(g2)$tTable[2,2]
    sd.mets1cpg[j,3:7] <- summary(g3)$tTable[2:6,2]
    sd.mets1cpg[j,8:12] <- summary(g4)$tTable[2:6,2]
    #Rsq mets
    g1 <- lme(var~metsz+CD8T+CD4T+NK+Bcell+Gran+Mono+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.omit,method="ML",data=dat.lme)
    r <-  r.squaredGLMM(g1)
    r2cpg[j,4] <- r[1]
    r2cpg[j,5] <- r[2]
    #Rsq mets components
   g3 <- lme(var~CD8T+CD4T+NK+Bcell+Gran+Mono+bmiz+stgz+midbpz+blods0z+skolz+casecontrol+age+gender+phys+smoke,
              random = ~1|person, na.action=na.omit,method="ML",data=dat.lme)
     r <-  r.squaredGLMM(g3)
    r2cpg[j,6] <- r[1]
    r2cpg[j,7] <- r[2]
    }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}

res.proteinscpg["id"] <- dat.lme$id
```

plot residuals:
  
```{r plot residuals}
#Histograms
res.proteinscpg[,1:200] %>% melt() %>% ggplot(aes(x=value)) + geom_histogram() + facet_wrap(~variable,scales="free")
res.proteinscpg[,201:ncol(res.proteinscpg)] %>% melt() %>% ggplot(aes(x=value)) + geom_histogram() + facet_wrap(~variable,scales="free")

#Variables with potential outliers found from inspecting histograms::
# alla med >3 i pearson residual:
gdat <- res.proteinscpg %>%mutate(index=seq(1,nrow(res.proteinscpg)), id=as.character(dat.lme$id)) %>% melt(id=c("index","id")) 
outlierscpg <- gdat[is.na(gdat$value)==F&abs(gdat$value)>3,]
tab(drop.levels(outlierscpg$variable))
save(outlierscpg, "outlierscpg.RData")

# plotta de med över 3 i pearson residual visas
res.proteinscpg %>% dplyr::select(one_of(as.character(outlierscpg$variable))) %>% 
  mutate(index=seq(1,nrow(res.proteinscpg)), id=as.character(dat1cpg$id)) %>% 
  melt(id=c("index","id")) %>% mutate(out=as.factor(ifelse(abs(value)>3,"outlier","normal"))) %>% 
  ggplot(aes(x=index,y=value,col=out)) +
  geom_point(size=1) + 
  scale_colour_manual(values=c("black","red")) +
  facet_wrap(~variable,scales="free") 

```

Get significant varaibles:
```{r get significants}

# Significant lifestyle variables
modf.bh0 <- apply(mod1cpg,2,p.adjust,method="bonferroni")
modm <- data.frame(var=rownames(modf.bh0),ifelse(modf.bh0<=0.05,1,0)) 
signmcpg <- mutate(modm,sum.sign=rowSums(modm[,-1])) %>% filter(sum.sign>0) #get significant variables 
signmcpg <- signmcpg[order(signmcpg$var),]
signmcpg

# Significant MetS
mets.bh1 <- apply(mod.mets1cpg, 2, p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.signcpg <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,2:8])) %>% filter(sum.sign>0) 
mets.signcpg <- mets.signcpg[order(mets.signcpg$var),]
mets.signcpg <- merge(mets.signcpg, mets.cpg[mets.cpg$var %in% mets.signcpg$var,], by="var")
mets.signcpg

write.xlsx(mets.sign, file ="mets sign.xlsx",sheetName = "TestSheet", row.names = T)

# Skapa Sophias excel-fil:
# adj p
mod.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
mod.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")
sop <- data.frame(r2,
                  padj=mod.bh0[,2],age=coef1[,2],agesd=sd1[,2],
                  padj=mod.bh0[,3],sex=coef1[,3],sexsd=sd1[,3],
                  padj=mod.bh0[,4],height=coef1[,4],heightsd=sd1[,4],
                  padj=mod.bh0[,5],weight=coef1[,5],weightsd=sd1[,5],
                  padj=mod.bh0[,6],phys=coef1[,6],physsd=sd1[,6],

                  mod.bh1[,1],coef.mets1[,1],sd.mets1[,1],
                  mod.bh1[,2],coef.mets1[,2],sd.mets1[,2],
                  mod.bh1[,3],coef.mets1[,3],sd.mets1[,3],
                  mod.bh1[,4],coef.mets1[,4],sd.mets1[,4],
                  mod.bh1[,5],coef.mets1[,5],sd.mets1[,5],
                  mod.bh1[,6],coef.mets1[,6],sd.mets1[,6],
                  mod.bh1[,7],coef.mets1[,7],sd.mets1[,7],
                  
                  mod.bh1[,8],coef.mets1[,8],sd.mets1[,8],
                  mod.bh1[,9],coef.mets1[,9],sd.mets1[,9],
                  mod.bh1[,10],coef.mets1[,10],sd.mets1[,10],
                  mod.bh1[,11],coef.mets1[,11],sd.mets1[,11],
                  mod.bh1[,12],coef.mets1[,12],sd.mets1[,12])
names(sop) <- c(names(r2),rep(c("padj","coef","sd"),17))                

sop <- sop[order(sop$var),]
# Export estimates to excel
#write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
#write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
write.xlsx(sop, file ="sophia.xlsx",sheetName = "TestSheet", row.names = T)

```


ICC
ICC = proportion of total variance that is "between groups." 

```{r plot ICC}
#Plot ICCs
gdata <- data.frame(var1=var1,icc=icc) 
ggplot(gdata,aes(x=reorder(var1,icc),y=icc)) +
  geom_bar(stat="identity",width=.15) +
  geom_point(size=1)+
  coord_flip() 
```



#Correlations between CpG and markers 

Heatmaps
```{r correlations heatmaps,echo=F}
# Proteins correlations:
prot <- dplyr::select(dat1, IL_8:FR_alpha) %>% names()

# Variables with many missing: Remove with over 50% missing
dat.11 <- dplyr::select(dat1, one_of(prot))
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])
# Remove them: (only important if dat1 is used)
# Remove TRAIL because it is the same as TNFSF10
prot <- dplyr::select(dat.11,-one_of(c(manyna1)),-TRAIL) %>% names()

cor1 <- cor(dat1[,prot],method="spearman",use="pairwise.complete.obs")

# Heatmap 2 : 9*9 inches works good
heat <- t(as.matrix(cor1))
mydist=function(c) {dist(c,method="euclidian")}
myclust <- function(x) hclust(x, method="average")

#heatmap.2(heat,col=bluered, trace="none", distfun=dist.pear, hclustfun=hclust.ave)
heatmap.2(heat, dendrogram = "col",
          distfun = mydist,
          hclustfun = myclust,
          trace="none",
          col=bluered(24),main="",margins=c(10,12),srtCol=55,key.title="Color key",key.xlab="Speaman's correlation")

# CpG correlations:
cor1 <- cor(dat1cpg[,cpg1],method="spearman",use="pairwise.complete.obs")

#Grouping
fcol <- as.factor(mets.cpg$OLINK.Protein_name)
levels(fcol) <- scales::hue_pal()(length(levels(fcol)))
fcol <- as.character(fcol)

# Heatmap 2 : 8*10 inches works good
heat <- t(as.matrix(cor1))
mydist=function(c) {dist(c,method="euclidian")}
myclust <- function(x) hclust(x, method="average")
#heatmap.2(heat,col=bluered, trace="none", distfun=dist.pear, hclustfun=hclust.ave)
heatmap.2(heat, dendrogram = "col",
           labRow = FALSE, labCol = FALSE,
          distfun = mydist,
          hclustfun = myclust,
          trace="none",
          ColSideColors=fcol,
          col=bluered(24),main="",margins=c(10,12),srtCol=55,key.title="Color key",key.xlab="Speaman's correlation")

legend("topright", title = " ", 
       legend = levels(as.factor(mets.cpg$OLINK.Protein_name)),
       fill= levels(as.factor(fcol)),
       border=FALSE, bty="n", y.intersp = 1, cex=0.8)


```

###Circos

Circos correlations: ALL proteins , plot those with R2 > 0.5. Color those with R2 > 0.8
PROV 1 o 2
```{r circos correlations ,echo=F}
#Data fix 
rdata1 <-  res.proteins 
names(rdata1) <- gsub('_', '-', names(rdata1))

# Correlations prov 1
str(rdata1)
cor1 <- cor(rdata1,method="spearman",use="pairwise.complete.obs")
# Melt
cor11 <- melt(cor1);nrow(cor11)
#Remove diagnonal in correlations matrix
cor11 <- cor11[cor11[,1]!=cor11[,2],];nrow(cor11)
# How many negative correlations above 0.5?
sum(cor11[,3]<0 & abs(cor11[,3])>0.5)
# R^2
cor11[,3] <- cor11[,3]^2
# Variable indicating R^2>0.5
cor11[,4] <- ifelse(cor11[,3]>=0.5,1,0) 
# Remove same correlations 
cor11 <- cor11[!duplicated(cor11[,3]),]
# Only those above 0.5
cor22 <- cor11[cor11[,4]==1,1:3]

# Circos plot  
# Set grid colors
uniq <- union(cor22[[1]], cor22[[2]])
col3 <- colorRampPalette(c("dodgerblue", "forestgreen", "green", "gold", "orange", "red", "purple","darkblue", "blue"),alpha=F)
grid.col=col3(length(uniq))
names(grid.col)=uniq

#Highlight cols
col <-  grid.col[match(cor22[,1],names(grid.col))]
col[cor22[3] < 0.77] = "gray90"

# Scale correlations
#cor22[,3] <- (1/(1-cor22[,3]))
cor22[,3] <- scale(cor22[,3])

# Plot
chordDiagram(cor22, 
             directional = 0,transparency=0.20,
             direction.type = c("diffHeight"),
             annotationTrack = c("grid"),annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col, col=col,
             link.sort = TRUE, link.largest.ontop = TRUE) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```

Scatterplotmatrix
```{r scatterplot matrix,echo=F}
#
panel.cor <- function(x, y, digits = 2, cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  # correlation coefficient
  r <- cor(x, y,method="spearman",use="complete")
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.6, txt)
  
  # p-value calculation
  p <- cor.test(x, y)$p.value
  txt2 <- format(c(p, 0.123456789), digits = digits)[1]
  txt2 <- paste("p= ", txt2, sep = "")
  if(p<0.01) txt2 <- paste("p= ", "<0.01", sep = "")
  text(0.5, 0.4, txt2)
}

#Diagonal histograms
panel.hist <- function(x, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) )
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks; nB <- length(breaks)
  y <- h$counts; y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, ...)
}

#plot with pairs, 9*10 inch
#data = data.frame with numeric variables
pairs(rdata1[,c("SCAMP3", "TXLNA","STAMPB","SIRT2","AXIN1", "LYN", "ABL1","LAP.TGF-beta-1")], diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")


```

Circos correlations - signiricant in metS, proteins and CpGs:

```{r circos corelations significants METS,echo=F}
#Data fix 
dim(dat1cpg[dat1cpg$id %in% dat1$id,])
rdata1 <- merge(dat1cpg,dat1,by="id") %>% dplyr::select(one_of(as.character(mets.sign$var)), one_of(cpg1))

# TRAIL is the same as TNFSF10 so remove
names(rdata1) <- gsub('_', '-', names(rdata1))

# Correlations prov 1
str(rdata1)
cor1 <- cor(rdata1, method="spearman", use="pairwise.complete.obs")
# Melt
cor11 <- melt(cor1);nrow(cor11)
#Remove diagnonal in correlations matrix
cor11 <- cor11[cor11[,1]!=cor11[,2],];nrow(cor11)
# How many negative correlations above 0.5?
sum(cor11[,3]<0 & abs(cor11[,3])>0.5)
# R^2
cor11[,3] <- cor11[,3]^2
# Remove same correlations 
cor11 <- cor11[!duplicated(cor11[,3]),]
# Only those above 0.5
cor11[,4] <- ifelse(cor11[,3]>=0.5,1,0) 
cor22 <- cor11[cor11[,4]==1,1:3]

# Circos plot
# Set grid colors
uniq <- union(cor22[[1]], cor22[[2]])
col3 <- colorRampPalette(c("dodgerblue", "forestgreen", "green", "gold", "orange", "red", "purple","darkblue", "blue"),alpha=F)
grid.col=col3(length(uniq))
names(grid.col)=uniq

#Highlight cols
col <-  grid.col[match(cor22[,1],names(grid.col))]
col[cor22[3] < 0.75] = "gray90"

# Scale correlations
#cor22[,3] <- (1/(1-cor22[,3]))
#cor22[,3] <- scale(cor22[,3])
cor22[,3] <- cor22[,3]*100

# Plot
chordDiagram(cor22, 
             directional = 0,transparency=0.20,
             direction.type = c("diffHeight"),
             annotationTrack = c("grid"),annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col, col=col,
             link.sort = TRUE, link.largest.ontop = TRUE) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y){ 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```

Scatterplot matrix METS
```{r scatterplot matrix correlatiosn METS}
#data = data.frame with numeric variables
pairs(rdata1, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")

```


