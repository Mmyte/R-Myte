---
title: "Sophia Early Detection"
author: "Robin Myte"
date: "16 augusti 2016"
output: html_document
---


##Importera data
```{r,echo=FALSE,message=FALSE}

setwd("~/Dropbox/Documents/JOBB ONKO/Sophia Early Detection")

# Packages RUN -------------------------
library(cluster)
library(Hmisc)
library(FactoMineR)
library(GenABEL)
library(mgcv)
library(car)
library(boot)
library(gdata)
library(gplots)
library(xlsx)
library(reshape)
library(ENmix)
library(gdata)                
library(ggExtra)
library(dplyr)
library(tidyr)
library(lme4)
library(broom)
library(forcats)
library(circlize)
library(RColorBrewer)

# Functions ---------------------------
source('~/Dropbox/Documents/JOBB ONKO/R/Kaplan Meier.R')
source("~/Dropbox/Documents/JOBB ONKO/R/confadjust.R")
source("~/Dropbox/Documents/JOBB ONKO/R/summ.R")
source("~/Dropbox/Documents/JOBB ONKO/R/RD quartiles.R")
source('~/Dropbox/Documents/JOBB ONKO/R/table_myte.R')
source('~/Dropbox/Documents/JOBB ONKO/R/subtype clog.R')

# Import data -------------------------
# OLINK data - Inflammation 
p.inflam = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_INF.xlsx",
                            rows=1:267,
                           sheet=1, 
                           skipEmptyRows=FALSE)
p.inflamlod = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_INF.xlsx",
                            rows=1:267,
                           sheet=2, 
                           skipEmptyRows=FALSE)
#p.inflam <- p.inflam[1:266,]

# OLINK data - oncology 
p.onc = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_ONCII.xlsx",
                           rows=1:270,
                          sheet=1, 
                           skipEmptyRows=FALSE)
p.onclod = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_ONCII.xlsx",
                           rows=1:270,
                          sheet=2, 
                           skipEmptyRows=FALSE)
#p.onc <- p.onc[1:269,]

# MERGE inflam and onc
p.inflam["id"] <- p.inflamlod["id"] <- as.numeric(p.inflam$NPX)
p.onc["id"] <- p.onclod["id"] <- as.numeric(p.onc$NPX)
datx <- merge(p.inflam,p.onc,by="id")
datlod <- merge(p.inflamlod,p.onclod,by="id")
# Remove variables
datx <- dplyr::select(datx,-contains("NPX"),-contains("Flagged"))
datlod <- dplyr::select(datlod,-contains("Ctrl"),-contains("NPX"),-contains("Flagged"),-contains("Chip"),-contains("MissData"),-contains("S-Type"))
# Fix variable names 
names(datx) <- gsub('-', '_', names(datx))
names(datlod) <- gsub('-', '_', names(datlod))
names(datx)[-1] <- substr(names(datx)[-1],5,nchar(names(datx)[-1]))
names(datlod)[-1] <- substr(names(datlod)[-1],5,nchar(names(datlod)[-1]))
# Remove double variables:
dub <-  dplyr::select(dat1,contains("HGF"),contains("IL_6"),contains("SCF"),contains("TRAIL"),contains("TGF"),contains("VEGF")) %>% names()
par(mfrow=c(2,2))
plot(datx$TGFA,datx$TGF_alpha)
plot(datx$HGF.y,datx$HGF.x)
plot(datx$VEGF_A.y,datx$VEGF_A.x)
datx <- dplyr::select(datx,-HGF.x,-TGFA,-VEGF_A.x)
datlod <- dplyr::select(datlod,-HGF.x,-TGFA,-VEGF_A.x)

# MISSING OLINK-data
# percent missing in each variable, endast på datx, datlod har inga missing (ersatt med lowest detectable value)
na.col <- apply(datx,2,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.col)
na.col[na.col>0.8]
summary(datx[,names(na.col[na.col>0.8])])
# percent missing in each obs
na.row <- apply(datx,1,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.row) #Som högst 12 %, så OK

# SELECT and FILTER OLINK data
names(datlod)==names(datx) #samma variabler i båda
var <- names(datlod)[-1] #lista för senare bruk

# VIP data 
phen = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/crc_enkatdata160907.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)
alder = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/phenotypdata.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)
# fixa id och age-variabler
phen <- phen[order(phen$pat_code),]
alder <- alder[order(alder$pat_code),]
phen["id"] <- phen$pat_code
phen["birth"] <- alder$birth
phen["pdatum"] <- alder$pdatum
phen["bdatum"] <- as.Date(as.character(phen$birth),'%Y%m%d')
phen["pdatum2"] <- as.Date(as.character(phen$pdatum),'%Y%m%d')
phen["age"] <- as.numeric((phen$pdatum2-phen$bdatum))/365
phen[phen==9999] <- NA
phen[phen==8888] <- NA

# NYA VARIABLER VIP
# Select lifestyle variables of interest:
summary(phen)
phen <- dplyr::select(phen,id,casecontrol,caseset,caseset2,provnr,pdatum2,diadat=DIADAT,age,gender,langd,vikt,bmi,skol,stg,blods0,blods2,sbt,dbt,starts_with("med"),smartmed,andra_mediciner,g6,sm_status,sn_status,pa_index,pa_index_miss)
##nya
phen["agef"] <- ceiling(phen$age)
phen["age4"] <- cut(phen$agef,breaks=c(0,40,50,60,70),right=F,labels=c(30,40,50,60))
phen["bmi3"] <- cut(phen$bmi,breaks=c(0,20,25,30,50),right=F,labels=c(1,2,3,4))
phen$bmi3 <- fct_relevel(phen$bmi3,"2")
phen$stg <- log(phen$stg)
phen["midbp"] <- (phen$sbt+phen$dbt)/2
phen["med"] <- rowSums(phen[,19:23],na.rm=T) #medicin variable, tar du NÅGON medicin
phen$med <- as.factor(ifelse(phen$med>0,1,ifelse(phen$med==0&phen$med_C5f==1,0,9999)))
phen["smoke"] <- as.factor(phen$sm_status)
levels(phen$smoke) <- c(1,2,0,1,2)
phen$smoke<- fct_relevel(phen$smoke,"0")
phen["snus"] <- as.factor(phen$sn_status)
levels(phen$snus) <- c(1,2,0)
phen$snus<- fct_relevel(phen$snus,"0")
phen[which(is.na(phen$pa_index)==T),"pa_index"] <- 1

# Final remove all uncessesary variables:
phen <- dplyr::select(phen,-contains("med_"),-smartmed,-andra_mediciner,-sm_status,-sn_status)
summary(phen)

# MISSING VIP:
# percent missing in each obs
na.row <- apply(phen,1,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.row) #En individ har missing på 60€ av variablerna, (har bara kön och ålder)
na.row[na.row>0.5]
phen[names(na.row[na.row>0.5]),] 

#Select and filter phen data
phen <- filter(phen,id!=phen[names(na.row[na.row>0.5]),"id"])

# merge PHEN och OLINK data ------------------------

# NA-data
dat1 <- merge(phen,datx,by="id")
dat1 <- unite(dat1,"person",caseset,casecontrol,remove=FALSE)

# LOD-data
dat2 <- merge(phen,datlod,by="id")
dat2 <- unite(dat2,"person",caseset,casecontrol,remove=FALSE)

# Borttagna flagged prover: (11 stycken + 1 som saknade phen data), stämmer överrens med OLINKs lista. 
phen[!(phen$id %in% dat1$id),"pat_code"]

# ANNAT -----------------------

# Get Nature communications significant associations PEA vs Lifestyle
natcom = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/VariablesNatCom.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)


```


RATIO data
```{r,echo=F}

# Hur många har repeated? 
length(table(dat1$person)[table(dat1$person)==2])
# De som inte har repeated:
ejrep <- names(table(dat1$person)[table(dat1$person)<2])
# Ta bort de som inte har repeated:
d1 <- filter(dat1,provnr==1) %>% filter(!(person %in% ejrep))
d2 <- filter(dat1,provnr==2) %>% filter(!(person %in% ejrep))

dat1r <- merge(d1,d2,by="person",all=T)
dat1r <- select(dat1r,-contains("NPX"),-contains("Flagged"),-contains("Chip"),-contains("MissData"),-contains("S-Type"))

# checka så det stämmer:
sum(dat1r$gender.x==dat1r$gender.y)
sum(dat1r$caseset.x==dat1r$caseset.y)
sum(dat1r$birth.x==dat1r$birth.y)

#Skapa ratio-variabler:
#summary(dat1r[,c("langd.x","vikt.x","101_IL-8.x","102_VEGF-A.x.x","103_BDNF.x")]/dat1r[,c(c("langd.y","vikt.y","101_IL-8.y","102_VEGF-A.x.y","103_BDNF.y"))])

#dat1r[,13:196] <- dat1r[,208:391]/dat1r[,13:196]
dat1r[,13:196] <- dat1r[,208:391]-dat1r[,13:196]
dat1r <- dat1r[,1:196]

names(dat1r) <- gsub("\\.x", "", names(dat1r))

#RATIO DATA: LOD
#Hur många har repeated? 
length(table(dat2$person)[table(dat2$person)==2])
#de som inte har repeated:
ejrep <- names(table(dat2$person)[table(dat2$person)<2])

d1 <- filter(dat2,provnr==1) %>% filter(!(person %in% ejrep))
d2 <- filter(dat2,provnr==2) %>% filter(!(person %in% ejrep))

dat2r <- merge(d1,d2,by="person",all=T)
dat2r <- select(dat2r,-contains("NPX"),-contains("Flagged"),-contains("Chip"),-contains("MissData"),-contains("S-Type"))

#check så det stämmer:
sum(dat2r$gender.x==dat2r$gender.y)
sum(dat2r$caseset.x==dat2r$caseset.y)
sum(dat2r$birth.x==dat2r$birth.y)

#Skapa ratio-variabler:
#summary(dat2r[,c("langd.x","vikt.x","101_IL-8.x","102_VEGF-A.x.x","103_BDNF.x")]/dat2r[,c(c("langd.y","vikt.y","101_IL-8.y","102_VEGF-A.x.y","103_BDNF.y"))])

#dat2r[,13:199] <- dat2r[,211:397]/dat2r[,13:199]
dat2r[,13:199] <- dat2r[,211:397]-dat2r[,13:199]
dat2r <- dat2r[,1:199]
names(dat2r) <- gsub("\\.x", "", names(dat2r))

```


Samma variabler i onc och infl panel?
```{r,echo=F}
on <- names(p.onc)[2:93]
inf <- names(p.inflam)[2:91]
on <- substr(on,5,nchar(on))
inf <- substr(inf,5,nchar(inf))

inf[inf %in% on]
on[on %in% inf]

summary(select(dat1,contains("VEGF-A")))
summary(select(dat1,contains("HGF")))
```



##Descriptive statistics:


#heatmap of levels
```{r,echo=F}
corre <- filter(dat1,provnr==1)%>%
          dplyr::select(one_of(var))
dim(corre)

# Sort columns
n <- apply(corre,2,function(x) sum(is.na(x)))
n <- sort(n,decreasing=T)
corre <- corre[names(n)]

# Sort rows according to ammount of NA
nr <- apply(corre,1,function(x) sum(is.na(x)))
names(nr) <- 1:length(nr)
nr <- sort(nr,decreasing=F)
#corre[is.na(corre)] <- 0
#corre <- apply(corre,2,sort,decreasing=T)

# Heatmap --------------------
# get rownames
corre["names"] <- rownames(corre)
df <- melt(corre,id.vars="names")
df$names <- factor(df$names,levels=names(nr))

g1 <- ggplot(df, aes(names, variable)) + 
   geom_tile(aes(fill = value), colour = "white") + 
   scale_fill_gradient(low = "darkblue",high = "yellow",na.value="white") +
   theme_bw()+labs(x = "", y = "")+
   theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     legend.position="right")

# Remove legend to add to own square
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
legend <- get_legend(g1)
g1 <- g1+theme(legend.position="none")

# Margin plots
left <- data.frame(name=1:length(n),value=round(100*n/length(n),0))
top <- data.frame(name=1:length(nr),value=round(100*nr/length(nr),0))

gleft <- ggplot(left, aes(x=name,y=value))+geom_line()+ geom_line(stat="identity")+theme_bw()+labs(x = "", y = "")+
  ylim(c(0,100))+xlim(c(1,182))+
  coord_flip()+ 
  ggtitle("Percent values below detection limit per protein")+ 
    theme(
     axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     plot.margin = unit(c(0,0,-0.5,0),"cm"),
     panel.margin = unit(c(0,0,-0.5,0),"cm"),
     plot.title = element_text(size=10))

gtop <- ggplot(top, aes(x=name,y=value)) + geom_line()+theme_bw()+labs(x = "", y = "")+
  ylim(c(0,100))+xlim(c(1,133))+
  ggtitle("Percent values below detection limit per indivual")+
  theme(
     axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     plot.margin = unit(c(0,0,-0.5,0),"cm"),
     panel.margin = unit(c(0,0,-0.5,0),"cm"),
     plot.title = element_text(size=10))
     

# Grid-arrange plot
lay <- rbind(c(NA,1,1,2),
             c(3,4,4,2),
             c(3,4,4,2))
             
grid.arrange(gtop,legend,gleft,g1,layout_matrix=lay,widths=c(0.75,2,2,0.5),heights=c(0.75,2,2)) #7*10 inches




# ggMarginal
g1 <- ggplot(df, aes(names, variable)) + 
   geom_tile(aes(fill = value), colour = "white") + 
   scale_fill_gradient(low = "darkblue",high = "yellow",na.value="white") +
   theme_bw()+labs(x = "", y = "")+
   theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     legend.position="left")

ggMarginal(g1+
  theme_bw()+
  labs(x = "", y = "")+
  theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
  legend.position="left"),
  data=top,x="value",y="name")

```


Cluster analysis heatmap ratios:

```{r,echo=F}
# Data fix -----------------

con <- filter(dat2,provnr==1)%>%
          dplyr::select(one_of(var))
con[,-1] <- scale(con[,-1])
heat <- as.matrix(con[,-c(1)])
heat <- t(heat)

#fcol <- ifelse(con$casecontrol==1,"firebrick","green")
fcol <- ifelse(con$pa_index==1,"dodgerblue1",ifelse(con$pa_index==2,"dodgerblue2",ifelse(con$pa_index==3,"dodgerblue3","dodgerblue4")))

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="complete")}

# Plot Heatmap -----------------
heatmap.2(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun =mydist,col=bluered(256),
          margins=c(6,12),srtCol=90,ColSideColors=fcol,key.title="Color key",key.xlab="standardized log-concentration")

legend("topright", legend = c("1", "2","3","4"),fill=c("dodgerblue2","dodgerblue2","dodgerblue3","dodgerblue4"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)

#legend("topright", legend = c("Case", "Control"),fill=c("firebrick","green"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)
#legend("topright", legend = c("F840","F845","Control","Missing"),fill=c("green","blue","firebrick","black"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)
```



#PCA (NOT SHOWN)

```{r,echo=F}
# Data fix -----------------
con <- filter(dat2,provnr==1)%>%
          dplyr::select(g6,one_of(var))

con[,-1] <- scale(con[,-1])
con <- na.omit(con)
con$g6 <- as.factor(con$g6)
levels(con$g6) <- c(1,2,3,4,4) #Slå ihop grupper G6

# PCA -----------------
pca <- prcomp(con[,-c(1)],center = FALSE,scale. = FALSE) 
pca;summary(pca)
plot(pca,type="l")
pca1 <- data.frame(prov=con[,1],pca$x[,1:5])

# Plot -----------------
scatterplotMatrix(~PC1+PC2+PC3+PC4+PC5|prov, data=pca1,main="PCA",by.groups=F,smoother=F,reg.line=F,col=c("red","blue","green","purple"),pch=c(18,20,22,24))

```



##Associations biomarkers vs lifestyle


Prov 1: (zntransform on model before does not change sign covariates)

```{r,echo=F}
# Data fix   ----------------- 
dat21 <- filter(dat1,provnr==1)

# Physical activity: 

# PA-index:
#dat21["phys"] <- dat21$pa_index
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,1,2,2) #Slå ihop grupper G6
# G6
dat21["phys"] <- dat21$g6
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,2,3,4,4) #Slå ihop grupper G6

# data frame for ztransform:
dat <- dplyr::select(dat21,one_of(var))

# Variables with many missing:
na <- apply(dat,2,function(x) sum(is.na(x))/length(x))
plot(na)
#remove variables with above 50% missing:
manyna <- names(na[na>=0.5])
dat <- dplyr::select(dat,-one_of(manyna))

# Model fitting   ----------------- 

# lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","bmi","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 

# Matrix to store estimate in:
mod1 <- matrix(nrow=ncol(dat),ncol=length(cov))
coef1 <- matrix(nrow=ncol(dat),ncol=1)
colnames(mod1) <- c("Case","Age","Sex","Length","Weight","BMI","Physical activity","Colesterol","Triglycerides","Glucose","Glucose tolerance","SBP","DBP","Smoking","Snus","Medications")
rownames(mod1) <- rownames(coef1) <- var1 <- names(dat)
rdata1 <- dat
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODE
  moddat <- na.omit(dat21[,c(i,cov)])
  g <- glm(moddat[,i]~.,data=moddat[,-1]) #fit model remove NAs
  coef1[j,] <- g$coefficients["phys"]
  #ANOVA
  a <-   anova(g,test="Chisq")
  mod1[j,] <- a$`Pr(>Chi)`[-1]
  #TRANSFORM data for correlation analysis
  covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<0.05][-1]) #get significant covariates + casecontrol status
  rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

#Estimates:
mod1.bh <- apply(mod1,2,p.adjust,method="BH")
mod11 <- data.frame(var=rownames(mod1.bh),ifelse(mod1.bh<=0.05,1,0)) 
sign1 <- mutate(mod11,sum.sign=rowSums(mod11[-1])) %>% filter(sum.sign>0) #get significant variables 
sign1

# Physical activity:
pa <- mod1[,6]
bh <- cbind(coef1,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
bh <- round(bh,3)
bh[bh[,2]<0.05,]
nn <- rownames(bh[bh[,3]<0.05,])


# Export estimates to excel
#write.xlsx(bh[bh[,2]<0.05,], file ="hej proteins2.xlsx",sheetName = "TestSheet", row.names = T)

# PLOTTING   ----------------- 
# plot "significant" variables
gdata <- dat21[,c("phys",nn)]
gdata$phys <- as.factor(gdata$phys)
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys,fill=phys))+
  geom_boxplot(outlier.shape=NA,alpha=0.3) + #avoid plotting outliers twice
  geom_jitter(aes(color=phys),position=position_jitter(width=.35, height=0),size=0.5)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Scatter plot with reg line
gdata <- dat21[,c("phys",nn)]
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys))+
  facet_wrap(~variable,scales="free")+theme_bw()+
  geom_smooth(method = "lm", se=FALSE, color="blue", formula = y ~ x) +
  geom_point(size=0.5,alpha=0.3)

# plot "significant" variables in full data, both sample 1 & 2
gdata <- dat1[,c("provnr","g6",nn)]
gdata$provnr <- as.factor(gdata$provnr)
gdata$g6 <- as.factor(gdata$g6)
gdata2 <- melt(gdata,id=c("provnr","g6"))
ggplot(gdata2,aes(x = g6, y = value,fill=provnr))+
  facet_wrap(~variable, scales="free")+
    geom_boxplot(outlier.shape=NA,alpha=0.2)+ #avoid plotting outliers twice
  geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
  theme_bw()

```

Prov 1 - Scatterplots:

```{r,echo0F}
#Scatterplotmatrix

panel.cor <- function(x, y, digits = 2, cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  # correlation coefficient
  r <- cor(x, y,method="spearman",use="complete")
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.6, txt)
  
  # p-value calculation
  p <- cor.test(x, y)$p.value
  txt2 <- format(c(p, 0.123456789), digits = digits)[1]
  txt2 <- paste("p= ", txt2, sep = "")
  if(p<0.01) txt2 <- paste("p= ", "<0.01", sep = "")
  text(0.5, 0.4, txt2)
}

#Diagonal histograms
panel.hist <- function(x, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) )
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks; nB <- length(breaks)
  y <- h$counts; y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, ...)
}

# MODEL 1
gdata <- dat21[,c(nn,"phys")]
#plot with pairs, 9*10 inch
pairs(gdata, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")


```

Prov 2:

```{r,echo=F}

# Data fix   ----------------- 
dat21 <- filter(dat1,provnr==2)

# Physical activity: 

# PA-index:
#dat21["phys"] <- dat21$pa_index
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,1,2,2) #Slå ihop grupper G6
# G6
dat21["phys"] <- dat21$g6
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,2,3,4,4) #Slå ihop grupper G6

# data frame for ztransform:
dat <- dplyr::select(dat21,one_of(var))

# Variables with many missing:
na <- apply(dat,2,function(x) sum(is.na(x))/length(x))
plot(na)
#remove variables with above 50% missing:
manyna <- names(na[na>=0.5])
dat <- dplyr::select(dat,-one_of(manyna))

# Model fitting   ----------------- 

# lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","bmi","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 

# Matrix to store estimate in:
mod1 <- matrix(nrow=ncol(dat),ncol=length(cov))
coef1 <- matrix(nrow=ncol(dat),ncol=1)
colnames(mod1) <- c("Case","Age","Sex","Length","Weight","BMI","Physical activity","Colesterol","Triglycerides","Glucose","Glucose tolerance","SBP","DBP","Smoking","Snus","Medications")
rownames(mod1) <- rownames(coef1) <- var1 <- names(dat)
rdata1 <- dat
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODE
  moddat <- na.omit(dat21[,c(i,cov)])
  g <- glm(moddat[,i]~.,data=moddat[,-1]) #fit model remove NAs
  coef1[j,] <- g$coefficients["phys"]
  #ANOVA
  a <-   anova(g,test="Chisq")
  mod1[j,] <- a$`Pr(>Chi)`[-1]
  #TRANSFORM data for correlation analysis
  covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<0.05][-1]) #get significant covariates + casecontrol status
  #rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

#Estimates:
mod1.bh <- apply(mod1,2,p.adjust,method="BH")
mod11 <- data.frame(var=rownames(mod1.bh),ifelse(mod1.bh<=0.05,1,0)) 
sign2 <- mutate(mod11,sum.sign=rowSums(mod11[-1])) %>% filter(sum.sign>0) #get significant variables 
sign2

# Physical activity:
pa <- mod1[,6]
bh <- cbind(coef1,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
bh <- round(bh,3)
bh[bh[,2]<0.05,]
nn <- rownames(bh[bh[,3]<0.05,])


# Export estimates to excel
write.xlsx(bh[bh[,2]<0.05,], file ="hej proteins2.xlsx",sheetName = "TestSheet", row.names = T)

# PLOTTING   ----------------- 
# plot "significant" variables
gdata <- dat21[,c("phys",nn)]
gdata$phys <- as.factor(gdata$phys)
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys,fill=phys))+
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.35, height=0),size=0.5,alpha=0.3)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Scatter plot with reg line
gdata <- dat21[,c("phys",nn)]
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys))+
  facet_wrap(~variable,scales="free")+theme_bw()+
  geom_smooth(method = "lm", se=FALSE, color="blue", formula = y ~ x) +
  geom_point(size=0.5,alpha=0.3)

# plot "significant" variables in full data, both sample 1 & 2
gdata <- dat1[,c("provnr","g6",nn)]
gdata$provnr <- as.factor(gdata$provnr)
gdata$g6 <- as.factor(gdata$g6)
gdata2 <- melt(gdata,id=c("provnr","g6"))
ggplot(gdata2,aes(x = g6, y = value,fill=provnr))+
  facet_wrap(~variable, scales="free")+
    geom_boxplot(outlier.shape=NA,alpha=0.2)+ #avoid plotting outliers twice
  geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
  theme_bw()

```


Repeated measures analysis:

```{r,echo=F}

# Data fix -----------------

# Några saknar upprepade prover: Samma om man använder LOB eller NA data
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Physical activity vairabel
#dat.lme["phys"] <- dat.lme$pa_index
dat.lme["phys"] <- dat.lme$g6

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1,y=dat.2,by="person")
dim(dat.rep)
#dat.rep$phys.x <- as.factor(dat.rep$phys.x)
#levels(dat.rep$phys.x) <- c(1,2,3,4,4) #Slå ihop grupper G6

# Hur mkt har livsstilsvariaberna ändrats på 10 år?
#View(dat.2[,9:21]-dat.1[9:21]) 
#View(dat.rep[,c("pa_index.x","pa_index.y","g6.x","g6.y")]) 

# Data frames för z-transform
dat.11 <- dplyr::select(dat.1,one_of(var))
dat.22 <- dplyr::select(dat.2,one_of(var))

# Variables with many missing: Remove with over 50% missing
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
na2 <- apply(dat.22,2,function(x) sum(is.na(x))/length(x))
#plot(na1)
#plot(na2)
manyna1 <- names(na1[na1>=0.5])
manyna2 <- names(na2[na2>=0.5])
# Remove them: (only important if dat1 is used)
dat <- dplyr::select(dat.11,-one_of(unique(c(manyna1,manyna2))))

# Model fitting  -----------------

# Lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","bmi","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
cov <- paste(cov,"x",sep=".")

# Matrix to store estimate in:
modd <- mod <- matrix(nrow=ncol(dat),ncol=length(cov)+1)
coeff <- coefd <- matrix(nrow=ncol(dat),ncol=1)
colnames(modd) <-colnames(mod) <- c("Case","Age","Sex","Length","Weight","BMI","Physical activity","Colesterol","Triglycerides","P-glucose","Glucose tolerance test","SBP","DBP","Smoking","Snus","Medications")
rownames(modd) <- rownames(mod) <- var1 <- names(dat)
rdata1 <- dat.22
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODEL 1 - adjusting for baseline
  moddat <- na.omit(dat.rep[,c(paste(i,"y",sep="."),paste(i,"x",sep="."),cov)])
  g <- glm(moddat[,paste(i,"y",sep=".")]~.,data=moddat[,-1]) #fit model remove NAs
  coeff[j,] <- g$coefficients["phys.x"]
  #ANOVA 1
  a <-   anova(g,test="Chisq")
  mod[j,] <- a$`Pr(>Chi)`[-1]
  #MODEL 2 - differences
  moddat <- data.frame(diff=dat.rep[,paste(i,"x",sep=".")]-dat.rep[,paste(i,"y",sep=".")],dat.rep[,cov])
  moddat <- na.omit(moddat)
  gd <- glm(diff~.,data=moddat) #fit model remove NAs
  coefd[j,] <- gd$coefficients["phys.x"]
  #ANOVA 2 
  ad <-   anova(gd,test="Chisq")
  modd[j,] <- c(1,ad$`Pr(>Chi)`[-1])

  #TRANSFORM data for correlation analysis
  #covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<alpha][-1]) #get significant covariates + casecontrol status
  #rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

#Estimates: MODEL 1 - baseline followup
modf.bh <- apply(mod[,-1],2,p.adjust,method="BH")
modf <- data.frame(var=rownames(modf.bh),ifelse(modf.bh<=0.05,1,0)) 
signf <- mutate(modf,sum.sign=rowSums(modf[-1])) %>% filter(sum.sign>0) #get significant variables 
signf

# Estimates: MODEL 2 - Diff:
modd.bh <- apply(modd,2,p.adjust,method="BH")
modd1 <- data.frame(var=rownames(modd.bh),ifelse(modd.bh<=0.05,1,0)) 
signd <- mutate(modd1,sum.sign=rowSums(modd1[-1])) %>% filter(sum.sign>0) #get significant variables 
signd

#Phyiscal activiry: MODEL 1 - baseline followup
pa <- mod[,7]
p <- cbind(coeff,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
p[p[,2]<0.05,]
nn <- rownames(p[p[,2]<0.05,])

# Physical activity MODEL 2 - Diff:
pa <- modd[,7]
pd <- cbind(coefd,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
pd[pd[,2]<0.05,]
nnd <- rownames(pd[pd[,2]<0.05,])

# Export estimates to excel
write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)


# PLOTTING  ----------------- 

dat.rep$phys.x <- as.factor(dat.rep$phys.x)
dat.rep$phys.y <- as.factor(dat.rep$phys.y)

# MODEL 1 - plot "significant" variables 7*7 inch
gdata <- data.frame(phys.1 = dat.rep[,"phys.x"],phys.2 = dat.rep[,"phys.y"],dat.rep[,paste(nn,"y",sep=".")])
gdata2 <- melt(gdata,id=c("phys.1","phys.2"))
ggplot(gdata2,aes(y=value,x=phys.1,fill=phys.1))+
  geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
  geom_jitter(aes(color=phys.2),position=position_jitter(width=.35, height=0),size=1.75,pch=20)+
  facet_wrap(~variable,scales="free")+theme_bw()

# MODEL 2 - plot "significant" variables 
gdata <- data.frame(phys.1=dat.rep[,c("phys.x")], phys.2=dat.rep[,c("phys.y")], (dat.rep[,paste(nnd,"x",sep=".")]-dat.rep[,paste(nnd,"y",sep=".")]))
gdata2 <- melt(gdata,id=c("phys.1","phys.2"))
ggplot(gdata2,aes(y=value,x=phys.1,fill=phys.1))+
  geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
  geom_jitter(aes(color=phys.2),position=position_jitter(width=.35, height=0),size=1.75,pch=20)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Change paths in physical activity
gdata <- dat1[,c("pa_index","g6","person","provnr")]
gdata$provnr <- as.factor(gdata$provnr)
gdata$g6 <- as.factor(gdata$g6)
gdata$pa_index <- as.factor(gdata$pa_index)
gdata <- na.omit(gdata)
gdata <- melt(gdata,id=c("person","provnr"))
ggplot(gdata,aes(x = provnr, y = value, color = value,group=person,label=person))+
  #geom_point(aes(color=g6),position=position_jitter(width=0.1, height=0.3),size=0.5)+
  geom_line(aes(color=value),position=position_jitter(width=.1, height=0.3),size=0.5)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Test - inga skillnader mellan G6 och PA-index mellan proven
testdata <- na.omit(dat.rep[,c("g6.x","g6.y")])
wilcox.test(testdata[,1],testdata[,2], paired=TRUE)
testdata <- na.omit(dat.rep[,c("pa_index.x","pa_index.y")])
wilcox.test(testdata[,1],testdata[,2], paired=TRUE)

```



```{r,echo=F}
#Scatterplotmatrix

panel.cor <- function(x, y, digits = 2, cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  # correlation coefficient
  r <- cor(x, y,method="spearman",use="complete")
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.6, txt)
  
  # p-value calculation
  p <- cor.test(x, y)$p.value
  txt2 <- format(c(p, 0.123456789), digits = digits)[1]
  txt2 <- paste("p= ", txt2, sep = "")
  if(p<0.01) txt2 <- paste("p= ", "<0.01", sep = "")
  text(0.5, 0.4, txt2)
}

#Diagonal histograms
panel.hist <- function(x, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) )
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks; nB <- length(breaks)
  y <- h$counts; y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, ...)
}

# MODEL 1
gdata <- dat.rep[,c(paste(nn,"y",sep="."),"phys.x")]
#plot with pairs, 9*10 inch
pairs(gdata, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")

# Model 2
gdata <- data.frame((dat.rep[,paste(nnd,"x",sep=".")]-dat.rep[,paste(nnd,"y",sep=".")]),phys.x=dat.rep[,c("phys.x")])
#plot with pairs, 9*10 inch
pairs(gdata, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")

```

 
 Linear mixed models: (TEST, not used)
```{r,echo=F}

lme1 <- lmer(CEACAM5 ~ pa_index + (1|provnr) , dat.lme)
tidy(lme1)
(s <- summary(lme1))
#Test
fm1 <-lmer(CEACAM5 ~  (1 | provnr), dat.lme)
fm2 <- lmer(CEACAM5 ~ pa_index + (1 | provnr), dat.lme)
# also works with lme objects
anova(fm1, fm2) 
```


Differences explained by differneces analysis:


```{r,echo=F}

# Data fix -----------------
alpha <- 0.05/182 #Bonferroni level

# Några saknar upprepade prover: Samma om man använder LOB eller NA data
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Physical activity vairabel
dat.lme["phys"] <- dat.lme$pa_index
#dat.lme["phys"] <- dat.lme$g6

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1,y=dat.2,by="person")
dim(dat.rep)
#dat.rep$phys.x <- as.factor(dat.rep$phys.x)
#levels(dat.rep$phys.x) <- c(1,2,3,4,4) #Slå ihop grupper G6

# Hur mkt har livsstilsvariaberna ändrats på 10 år?
#View(dat.2[,9:21]-dat.1[9:21]) 
#View(dat.rep[,c("person","pa_index.x","pa_index.y","g6.x","g6.y")]) 
# Variabel för förändring i physical activity per år
# PA
dat.rep["phys.d"] <- dat.rep$phys.y-dat.rep$phys.x
dat.rep$phys.d <- as.factor(dat.rep$phys.d)
levels(dat.rep$phys.d) <- c(-1,-1,-1,0,1,1,1) #Slå ihop gruppe
dat.rep$phys.d <- relevel(dat.rep$phys.d,ref="0")

# G6
dat.rep["phys.d"] <- dat.rep$phys.y-dat.rep$phys.x
dat.rep$phys.d <- as.factor(dat.rep$phys.d)
levels(dat.rep$phys.d) <- c(-1,-1,-1,-1,0,1,1,1,1) #Slå ihop gruppe
dat.rep$phys.d <- relevel(dat.rep$phys.d,ref="0")

# Variables with many missing:
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
na2 <- apply(dat.22,2,function(x) sum(is.na(x))/length(x))
#plot(na1)
#plot(na2)
manyna1 <- names(na1[na1>=0.5])
manyna2 <- names(na2[na2>=0.5])
# Remove them: (only important if dat1 is used)
dat <- dplyr::select(dat.11,-one_of(unique(c(manyna1,manyna2))))

# Model fitting  -----------------

# Lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","skol","stg","blods0","blods2","midbp","smoke","snus","med") 
cov <- paste(cov,"x",sep=".")

# Matrix to store estimate in:
modd <- mod <- matrix(nrow=ncol(dat),ncol=length(cov)+2)
coeff <- coefd <- matrix(nrow=ncol(dat),ncol=2)
colnames(modd) <-colnames(mod) <- c("Baseline","Physical activity","Case","Age","Gender","Length","Weight","Colesterol","Triglycerides","P-glucose","2h Glucose test","mid BP","Smoking","Snus","Medications")
rownames(modd) <- rownames(mod) <- var1 <- names(dat)
rdata1 <- dat.22
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODEL 1 - adjusting for baseline
  moddat <- na.omit(dat.rep[,c(paste(i,"y",sep="."),paste(i,"x",sep="."),"phys.d",cov)])
  g <- glm(moddat[,paste(i,"y",sep=".")]~.,data=moddat[,-1]) #fit model remove NAs
  coeff[j,] <- g$coefficients[3:4]
  #ANOVA 1
  a <-   anova(g,test="Chisq")
  mod[j,] <- a$`Pr(>Chi)`[-1]
  #MODEL 2 - differences
  moddat <- data.frame(diff=dat.rep[,paste(i,"x",sep=".")]-dat.rep[,paste(i,"y",sep=".")],phys.d=dat.rep[,"phys.d"],dat.rep[,cov])
  moddat <- na.omit(moddat)
  gd <- glm(diff~.,data=moddat) #fit model remove NAs
  coefd[j,] <- gd$coefficients["phys.d"]
  #ANOVA 2 
  ad <-   anova(gd,test="Chisq")
  modd[j,] <- c(1,ad$`Pr(>Chi)`[-1])

  #TRANSFORM data for correlation analysis
  #covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<alpha][-1]) #get significant covariates + casecontrol status
  #rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

# Estimates: Model 1 - adjusting for baseline
mod3 <- data.frame(var=rownames(mod),ifelse(mod<=alpha,1,0)) 
sign3 <- mutate(mod3,any.sign=rowSums(mod3[2:5])) %>% filter(any.sign>1) #get significant variables 
sign3

#Phyiscal activiry:
pa <- mod[,2]
p <- cbind(coeff,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
p[p[,3]<0.05,]
nn <- rownames(p[p[,3]<0.05,])

# Estimates: Model 2 - Diff:
mod3d <- data.frame(var=rownames(modd),ifelse(modd<=alpha,1,0)) 
sign3d <- mutate(mod3d,any.sign=rowSums(mod3d[2:5])) %>% filter(any.sign>1) #get significant variables 
sign3d

# Physical activity:
pa <- modd[,2]
pd <- cbind(coeff,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
pd[pd[,3]<0.05,]
nnd <- rownames(pd[pd[,1]<0.05,])

# Export estimates to excel
write.xlsx(rbind(p[p[,3]<0.05,],pd[pd[,3]<0.05,]), file ="diff diff.xlsx",sheetName = "TestSheet", row.names = T)



# PLOTTING  ----------------- 

dat.rep$phys.x <- as.factor(dat.rep$phys.x)

# MODEL 1 - plot "significant" variables 7*7 inch
gdata <- dat.rep[,c("phys.x",paste(nn,"y",sep="."))]
gdata2 <- melt(gdata,id="phys.x")
ggplot(gdata2,aes(y=value,x=phys.x,fill=phys.x))+
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.35, height=0),size=0.5,alpha=0.3)+
  facet_wrap(~variable,scales="free")+theme_bw()

# MODEL 2 - plot "significant" variables 
gdata <- data.frame(phys.x=dat.rep[,c("phys.x")],(dat.rep[,paste(nnd,"x",sep=".")]-dat.rep[,paste(nnd,"y",sep=".")]))
gdata2 <- melt(gdata,id="phys.x")
ggplot(gdata2,aes(y=value,x=phys.x,fill=phys.x))+
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.35, height=0),size=0.5,alpha=0.3)+
  facet_wrap(~variable,scales="free")+theme_bw()



```



The same using lapply

```{r,echo=F}

#DATA
alpha <- 0.05/182 #alpha level bonferroni corrected
dat21 <- filter(dat1,provnr==1)
dat <- select(dat21,starts_with("1"))

#variables with many NAs
na <- apply(dat,2,function(x) sum(is.na(x))/length(x))
plot(na)
manyna <- names(na[na>=0.8])
#remove them:
dat <- select(dat,-one_of(manyna))


#calculate models with LAPPLY
models1 <- lapply(dat, function(q){
   glm(q ~ dat21$casecontrol+dat21$gender+dat21$langd+dat21$vikt)
    })

#get p-values from anova.glm
ps <- lapply(models1,function(x) data.frame(var=names(coef(x)),coef=coef(x),p=anova(x,test="Chisq")$`Pr(>Chi)`))

#extract significant associations
sign <- lapply(ps,function(x) na.omit(x[x$p<=alpha,]))
sign1 <- do.call(rbind, lapply(sign, data.frame, stringsAsFactors=FALSE)) #transform to data frame
sign1

#test
s <- step(models1$"101_IL-8",direction="backward",test="F")


```



#Correlations between markers using adjusted and transformed data

Prov 1
```{r,echo=F}
# Correlations prov 1
cor1 <- cor(rdata1,method="spearman",use="pairwise.complete.obs")

#Data fix --------------------
cor11 <- melt(cor1);nrow(cor11)
cor11 <- cor11[cor11[,1]!=cor11[,2],];nrow(cor11)
cor11[,3] <- cor11[,3]^2
cor11[,4] <- ifelse(cor11[,3]>=0.5,1,0) 
cor11 <- cor11[!duplicated(cor11[,3]),]

# Heatmap 2 : 8*10 inches works good
heat <- t(as.matrix(cor1))
dist.pear <- function(x) as.dist(1-cor(t(x),method="spearman",use="pairwise.complete.obs"))
myclust <- function(x) hclust(x, method="average")
#heatmap.2(heat,col=bluered, trace="none", distfun=dist.pear, hclustfun=hclust.ave)
heatmap.2(heat,dendrogram = "row",
          distfun = dist.pear,
          hclustfun = myclust,
          trace="none",
          col=bluered(24),main="",margins=c(10,12),srtCol=55,key.title="Color key",key.xlab="Speaman's correlation")

```

Circos correlations:
```{r,echo=F}
#Data fix --------------------
cor22 <- cor11[cor11[,4]==1,]

# Circos plot  --------------------
chordDiagram(cor22[,1:3]) 
circos.clear() #Resets graphical parameters

```

Circos lifestyle Prov 1

```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix --------------------
lf1 <- dplyr::select(sign1,-Case,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("forestgreen","green","yellow", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```



Circos lifestyle Prov 2
```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix --------------------
lf1 <- dplyr::select(sign2,-Case,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("forestgreen","green","yellow", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```












