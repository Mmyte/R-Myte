---
title: "Sophia Early Detection"
author: "Robin Myte"
date: "16 augusti 2016"
output: html_document
---


##Importera data
```{r,echo=FALSE,message=FALSE}

setwd("~/Dropbox/Documents/JOBB ONKO/Sophia Early Detection")

# Packages RUN -------------------------
library(cluster)
library(Hmisc)
library(FactoMineR)
library(GenABEL)
library(mgcv)
library(car)
library(boot)
library(gdata)
library(gplots)
library(xlsx)
library(reshape)
library(ENmix)
library(gdata)                
library(ggExtra)
library(dplyr)
library(tidyr)
library(lme4)
library(broom)
library(forcats)
library(circlize)
library(RColorBrewer)

# Functions ---------------------------
source('~/Dropbox/Documents/JOBB ONKO/R/Kaplan Meier.R')
source("~/Dropbox/Documents/JOBB ONKO/R/confadjust.R")
source("~/Dropbox/Documents/JOBB ONKO/R/summ.R")
source("~/Dropbox/Documents/JOBB ONKO/R/RD quartiles.R")
source('~/Dropbox/Documents/JOBB ONKO/R/table_myte.R')
source('~/Dropbox/Documents/JOBB ONKO/R/subtype clog.R')

# Import data -------------------------
# OLINK data - Inflammation 
p.inflam = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_INF.xlsx",
                            rows=1:267,
                           sheet=1, 
                           skipEmptyRows=FALSE)
p.inflamlod = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_INF.xlsx",
                            rows=1:267,
                           sheet=2, 
                           skipEmptyRows=FALSE)
#p.inflam <- p.inflam[1:266,]

# OLINK data - oncology 
p.onc = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_ONCII.xlsx",
                           rows=1:270,
                          sheet=1, 
                           skipEmptyRows=FALSE)
p.onclod = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/NPX and linear_ONCII.xlsx",
                           rows=1:270,
                          sheet=2, 
                           skipEmptyRows=FALSE)
#p.onc <- p.onc[1:269,]

# MERGE inflam and onc
p.inflam["id"] <- p.inflamlod["id"] <- as.numeric(p.inflam$NPX)
p.onc["id"] <- p.onclod["id"] <- as.numeric(p.onc$NPX)
datx <- merge(p.inflam,p.onc,by="id")
datlod <- merge(p.inflamlod,p.onclod,by="id")
# Remove variables
datx <- dplyr::select(datx,-contains("NPX"),-contains("Flagged"))
datlod <- dplyr::select(datlod,-contains("Ctrl"),-contains("NPX"),-contains("Flagged"),-contains("Chip"),-contains("MissData"),-contains("S-Type"))
# Fix variable names 
names(datx) <- gsub('-', '_', names(datx))
names(datlod) <- gsub('-', '_', names(datlod))
names(datx)[-1] <- substr(names(datx)[-1],5,nchar(names(datx)[-1]))
names(datlod)[-1] <- substr(names(datlod)[-1],5,nchar(names(datlod)[-1]))
# Remove double variables:
par(mfrow=c(2,2))
plot(datx$TGFA,datx$TGF_alpha)
plot(datx$HGF.y,datx$HGF.x)
plot(datx$VEGF_A.y,datx$VEGF_A.x)
#datx <- dplyr::select(datx,-HGF.x,-TGFA,-VEGF_A.x) %>% rename(HGF=HGF.y,VEGF_A=VEGF_A.y)
#datlod <- dplyr::select(datlod,-HGF.x,-TGFA,-VEGF_A.x) %>% rename(HGF=HGF.y,VEGF_A=VEGF_A.y)
datx <- dplyr::select(datx,-HGF.y,-TGF_alpha,-VEGF_A.y) %>% dplyr::rename(HGF=HGF.x,VEGF_A=VEGF_A.x)
datlod <- dplyr::select(datlod,-HGF.y,-TGF_alpha,-VEGF_A.y) %>% dplyr::rename(HGF=HGF.x,VEGF_A=VEGF_A.x)
par(mfrow=c(1,1))
# MISSING OLINK-data
# percent missing in each variable, endast på datx, datlod har inga missing (ersatt med lowest detectable value)
na.col <- apply(datx,2,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.col)
na.col[na.col>0.8]
summary(datx[,names(na.col[na.col>0.8])])
# percent missing in each obs
na.row <- apply(datx,1,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.row) #Som högst 12 %, så OK

# SELECT and FILTER OLINK data
names(datlod)==names(datx) #samma variabler i båda
var <- names(datlod)[-1] #lista för senare bruk

# VIP data 
phen = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/crc_enkatdata160907.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)
alder = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Documents/DATA-filer/Sophia early detection/phenotypdata.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)
# fixa id och age-variabler
phen <- phen[order(phen$pat_code),]
alder <- alder[order(alder$pat_code),]
phen["id"] <- phen$pat_code
phen["birth"] <- alder$birth
phen["pdatum"] <- alder$pdatum
phen["bdatum"] <- as.Date(as.character(phen$birth),'%Y%m%d')
phen["pdatum2"] <- as.Date(as.character(phen$pdatum),'%Y%m%d')
phen["age"] <- as.numeric((phen$pdatum2-phen$bdatum))/365
phen[phen==9999] <- NA
phen[phen==8888] <- NA

# NYA VARIABLER VIP
# Select lifestyle variables of interest:
summary(phen)

phen <- dplyr::select(phen,id,casecontrol,caseset,caseset2,provnr,pdatum2,diadat=DIADAT,age,gender,langd,vikt,bmi,skol,stg,blods0,blods2,sbt,dbt,starts_with("med"),smartmed,andra_mediciner,g6,sm_status,sn_status,pa_index,pa_index_miss)
##nya
phen["agef"] <- ceiling(phen$age)
phen["age4"] <- cut(phen$agef,breaks=c(0,40,50,60,70),right=T,labels=c(30,40,50,60))
# BMI
phen["bmi3"] <- cut(phen$bmi,breaks=c(0,20,25,30,50),right=T,labels=c(1,2,3,4))
phen$bmi3 <- fct_relevel(phen$bmi3,"2")
phen$stgc <- phen$stg
phen$stg <- log(phen$stg)
phen["midbp"] <- (phen$sbt+phen$dbt)/2
# Medicin variable, tar du NÅGON medicin
phen["med"] <- rowSums(phen[,19:23],na.rm=T) 
phen$med <- as.factor(ifelse(phen$med>0,1,ifelse(phen$med==0&phen$med_C5f==1,0,9999)))
# Smoking 
phen["smoke"] <- as.factor(phen$sm_status)
levels(phen$smoke) <- c(1,2,0,1,2)
phen$smoke<- fct_relevel(phen$smoke,"0")
# Snus
phen["snus"] <- as.factor(phen$sn_status)
levels(phen$snus) <- c(1,2,0)
phen$snus<- fct_relevel(phen$snus,"0")
phen[which(is.na(phen$pa_index)==T),"pa_index"] <- 1
# MetS variables
# Z-transformed variables per gender and sample
phen<- transform(phen, 
          bmiz=ave(bmi, gender, provnr, FUN=scale),
          stgz=ave(stg, gender, provnr, FUN=scale),
          midbpz=ave(midbp, gender, provnr, FUN=scale),
          blods0z=ave(blods0, gender, provnr, FUN=scale),
          skolz=ave(skol, gender, provnr, FUN=scale))
phen["metsz"] <- phen$bmiz + phen$stgz + phen$midbpz + phen$blods0z + phen$skolz
# Cut-off MetS
phen["bmi2"] <- ifelse(phen$bmi>=30,1,0)
phen["stg2"] <- ifelse(phen$stgc>=1.7,1,0)
phen[is.na(phen$med_C5a),"med_C5a"] <- 0
phen["ht2"] <- ifelse(phen$sbt>=130|phen$dbt>=85|phen$med_C5a==1,1,0)
phen["htm"] <- phen$med_C5a
phen["gluc2"] <- ifelse(phen$blods0>=5.6,1,0)
phen["mets"] <- phen$stg2 + phen$ht2 + phen$gluc2
phen["mets2"] <- as.factor(ifelse((phen$bmi>=25)&(phen$mets>1),1,0))

# Kön
phen$gender <- as.factor(phen$gender)

# Final remove all uncessesary variables:
phen <- dplyr::select(phen,-contains("med_"),-smartmed,-andra_mediciner,-sm_status,-sn_status)
summary(phen)

# MISSING VIP:
# percent missing in each obs
na.row <- apply(phen,1,function(x) round(sum(is.na(x))/length(x),2))
boxplot(na.row) #En individ har missing på 60€ av variablerna, (har bara kön och ålder)
na.row[na.row>0.5]
phen[names(na.row[na.row>0.5]),] 

#Select and filter phen data
phen <- filter(phen,id!=phen[names(na.row[na.row>0.5]),"id"])

# merge PHEN och OLINK data ------------------------

# NA-data
dat1 <- merge(phen,datx,by="id")
dat1 <- unite(dat1,"person",caseset,casecontrol,remove=FALSE)

# LOD-data
dat2 <- merge(phen,datlod,by="id")
dat2 <- unite(dat2,"person",caseset,casecontrol,remove=FALSE)

# Borttagna flagged prover: (11 stycken + 1 som saknade phen data), stämmer överrens med OLINKs lista. 
phen[!(phen$id %in% dat1$id),"pat_code"]

#dub <-  dplyr::select(dat1,contains("HGF"),contains("IL_6"),contains("SCF"),contains("TRAIL"),contains("TGF"),contains("VEGF")) %>% names()


# ANNAT -----------------------

# Get Nature communications significant associations PEA vs Lifestyle
natcom = openxlsx::read.xlsx(xlsxFile="/Users/Myte/Dropbox/Documents/JOBB ONKO/Sophia Early Detection/VariablesNatCom.xlsx",
                           sheet=1, 
                           skipEmptyRows=FALSE)

natcom <- dplyr::select(natcom,-Waist,-TLS) %>% dplyr::rename(Heigth=Length) 
natcom <- natcom[,c("var","Age","Sex","Height","Weight","BMI","SBP","DBP","Smoking","Snus")]
# Only take proteins we have in our study:
var.n <- as.factor(gsub('-', '_', natcom$var))
levels(var.n)[levels(var.n)=="ErbB2"] <- "ERBB2"
levels(var.n)[levels(var.n)=="ErbB3"] <- "ERBB3"
levels(var.n)[levels(var.n)=="ErbB4"] <- "ERBB4"
levels(var.n)[levels(var.n)=="FasL"] <- "FASLG"
levels(var.n)[levels(var.n)=="CEA"] <- "CEACAM5"
levels(var.n)[levels(var.n)=="MIC_A"] <- "MIC_A/B"
levels(var.n)[levels(var.n)=="TGF_beta_1"] <- "LAP.TGF_beta_1"
var.n <- as.character(var.n)
natcom$var <- var.n

natcom1 <- natcom[natcom$var %in% var,]

par(mfrow=c(1,1))
```



Samma variabler i onc och infl panel?
```{r,echo=F}
on <- names(p.onc)[2:93]
inf <- names(p.inflam)[2:91]
on <- substr(on,5,nchar(on))
inf <- substr(inf,5,nchar(inf))

inf[inf %in% on]
on[on %in% inf]

summary(select(dat1,contains("VEGF-A")))
summary(select(dat1,contains("HGF")))
```



##Descriptive statistics:


#heatmap of levels
```{r,echo=F}
# Remove many NAs
na1 <- apply(dat1[,var],2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])

# Data
corre <- filter(dat1,provnr==1)%>%
          dplyr::select(one_of(var)) %>%
          dplyr::select(-one_of(c(manyna1)))

dim(corre)

# Sort columns
n <- apply(corre,2,function(x) sum(is.na(x)))
n <- sort(n,decreasing=T)
corre <- corre[names(n)]

# Sort rows according to ammount of NA
nr <- apply(corre,1,function(x) sum(is.na(x)))
names(nr) <- 1:length(nr)
nr <- sort(nr,decreasing=F)
#corre[is.na(corre)] <- 0
#corre <- apply(corre,2,sort,decreasing=T)

# Heatmap --------------------
# get rownames
corre["names"] <- rownames(corre)
df <- melt(corre,id.vars="names")
df$names <- factor(df$names,levels=names(nr))

g1 <- ggplot(df, aes(names, variable)) + 
   geom_tile(aes(fill = value), colour = "white") + 
   scale_fill_gradient(low = "darkblue",high = "yellow",na.value="white") +
   theme_bw()+labs(x = "", y = "")+
   theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     legend.position="right")

# Remove legend to add to own square
get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
legend <- get_legend(g1)
g1 <- g1+theme(legend.position="none")

# Margin plots
left <- data.frame(name=1:length(n),value=round(100*n/length(n),0))
top <- data.frame(name=1:length(nr),value=round(100*nr/length(nr),0))

gleft <- ggplot(left, aes(x=name,y=value))+geom_line()+ geom_line(stat="identity")+theme_bw()+labs(x = "", y = "")+
  ylim(c(0,100))+xlim(c(1,182))+
  coord_flip()+ 
  ggtitle("Percent values below detection limit per protein")+ 
    theme(
     axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     plot.margin = unit(c(0,0,-0.5,0),"cm"),
     panel.margin = unit(c(0,0,-0.5,0),"cm"),
     plot.title = element_text(size=10))

gtop <- ggplot(top, aes(x=name,y=value)) + geom_line()+theme_bw()+labs(x = "", y = "")+
  ylim(c(0,100))+xlim(c(1,133))+
  ggtitle("Percent values below detection limit per indivual")+
  theme(
     axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     plot.margin = unit(c(0,0,-0.5,0),"cm"),
     panel.margin = unit(c(0,0,-0.5,0),"cm"),
     plot.title = element_text(size=10))
     

# Grid-arrange plot
lay <- rbind(c(NA,1,1,2),
             c(3,4,4,2),
             c(3,4,4,2))
             
grid.arrange(gtop,legend,gleft,g1,layout_matrix=lay,widths=c(0.75,2,2,0.5),heights=c(0.75,2,2)) #7*10 inches




# ggMarginal
g1 <- ggplot(df, aes(names, variable)) + 
   geom_tile(aes(fill = value), colour = "white") + 
   scale_fill_gradient(low = "darkblue",high = "yellow",na.value="white") +
   theme_bw()+labs(x = "", y = "")+
   theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
     legend.position="left")

ggMarginal(g1+
  theme_bw()+
  labs(x = "", y = "")+
  theme(axis.ticks = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
  legend.position="left"),
  data=top,x="value",y="name")

```


Cluster analysis:

```{r,echo=F}
# Data fix -----------------
# Remove many NAs
na1 <- apply(dat1[,var],2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])

#
# Data - provnr --------------------
con <-  dplyr::select(dat1,provnr,one_of(var)) %>%
          dplyr::select(-one_of(c(manyna1)))
con[,-1] <- scale(con[,-1])
heat <- as.matrix(con[,-c(1)])
heat <- t(heat)

#col legend
fcol <- ifelse(con$provnr==1,"firebrick","forestgreen")

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="average")}

# Plot Heatmap -----------------
heatmap.2(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun =mydist,col=bluered(256),
          margins=c(6,12),srtCol=90,ColSideColors=fcol,key.title="Color key",key.xlab="standardized log-concentration")

legend("topright", legend = c("Prov 1", "Prov 2"),fill=c("firebrick","forestgreen"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)


#
# Data - METs --------------------
con <- filter(dat1,provnr==1)%>%
          dplyr::select(mets2,one_of(var)) %>%
          dplyr::select(-one_of(c(manyna1)))
con[,-1] <- scale(con[,-1])
heat <- as.matrix(con[,-c(1)])
heat <- t(heat)

#col legend
fcol <- ifelse(con$mets2==1,"firebrick","forestgreen")

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="average")}

# Plot Heatmap -----------------
heatmap.2(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun =mydist,col=bluered(256),
          margins=c(6,12),srtCol=90,ColSideColors=fcol,key.title="Color key",key.xlab="standardized log-concentration")

legend("topright", legend = c("MetS", "Non-MetS"),fill=c("firebrick","forestgreen"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)

#
# Data - BMI --------------------
con <- filter(dat1,provnr==1)%>%
          dplyr::select(bmi3,one_of(var)) %>%
          dplyr::select(-one_of(c(manyna1)))
con$bmi3 <- relevel(con$bmi3,ref="1")
con[,-1] <- scale(con[,-1])
heat <- as.matrix(con[,-c(1)])
heat <- t(heat)

#col legend
b <- brewer.pal(4,"Blues")
fcol <- ifelse(con$bmi3==1,b[1],ifelse(con$bmi3==2,b[2],ifelse(con$bmi3==3,b[3],b[4])))

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="average")}

# Plot Heatmap -----------------
heatmap.2(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun =mydist,col=bluered(256),
          margins=c(6,12),srtCol=90,ColSideColors=fcol,key.title="Color key",key.xlab="standardized log-concentration")

legend("topright", legend = c("<20", "20-25","25-30",">30"),fill=c("dodgerblue1","dodgerblue2","dodgerblue3","dodgerblue4"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)

# Data - Case control --------------------
con <- filter(dat1,provnr==1)%>%
          dplyr::select(casecontrol,one_of(var)) %>%
          dplyr::select(-one_of(c(manyna1)))
con[,-1] <- scale(con[,-1])
heat <- as.matrix(con[,-c(1)])
heat <- t(heat)

#col legend
fcol <- ifelse(con$casecontrol==1,"firebrick","forestgreen")

# distance/cluster functions
mydist=function(c) {dist(c,method="euclidian")}
myclust=function(c) {hclust(c,method="average")}

# Plot Heatmap -----------------
heatmap.2(heat,
          dendrogram = "both",
          trace="none",
          hclustfun=myclust,
          distfun =mydist,col=bluered(256),
          margins=c(6,12),srtCol=90,ColSideColors=fcol,key.title="Color key",key.xlab="standardized log-concentration")

legend("topright", legend = c("Case", "Control"),fill=c("firebrick","forestgreen"),border=FALSE, bty="n", y.intersp = 0.7, cex=0.7)


```



#PCA (NOT SHOWN)

```{r,echo=F}
# Data fix -----------------
na1 <- apply(dat1[,var],2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])

con <- filter(dat2,provnr==1) %>%
          dplyr::select(mets2,one_of(var)) %>%
          dplyr::select(-one_of(c(manyna1)))

con[,-1] <- scale(con[,-1])
#con$g6 <- as.factor(con$g6)
#levels(con$g6) <- c(1,2,3,4,4) #Slå ihop grupper G6

# PCA -----------------
pca <- prcomp(con[,-c(1)],center = FALSE,scale. = FALSE) 
pca;summary(pca)
plot(pca,type="l")
pca1 <- data.frame(mets=con[,1],pca$x[,1:5])

# Plot -----------------
scatterplotMatrix(~PC1+PC2+PC3+PC4+PC5|mets, data=pca1,main="PCA",by.groups=F,smoother=F,reg.line=F,col=c("red","blue","green","purple"),pch=c(18,20,22,24))

```



##Associations biomarkers vs lifestyle


Prov 1: (zntransform on model before does not change sign covariates)

```{r,echo=F}
# Data fix   ----------------- 
dat21 <- filter(dat1,provnr==1)

# Physical activity: 

# PA-index:
#dat21["phys"] <- dat21$pa_index
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,1,2,2) #Slå ihop grupper G6
# G6
dat21["phys"] <- dat21$g6
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,2,3,4,4) #Slå ihop grupper G6

# data frame for ztransform:
dat <- dplyr::select(dat21,one_of(var))

# Variables with many missing:
na <- apply(dat,2,function(x) sum(is.na(x))/length(x))
plot(na);abline(h=0.7);abline(h=0.5)
#remove variables with above 50% missing:
manyna <- names(na[na>=0.5])
dat <- dplyr::select(dat,-one_of(manyna))

# Model fitting   ----------------- 

# lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","bmi","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 

# Matrix to store estimate in:
mod1 <- matrix(nrow=ncol(dat),ncol=length(cov))
coef1 <- matrix(nrow=ncol(dat),ncol=1)
colnames(mod1) <- c("Case","Age","Sex","Height","Weight","BMI","Physical activity","Colesterol","Triglycerides","Glucose","Glucose tolerance","SBP","DBP","Smoking","Snus","Medications")
rownames(mod1) <- rownames(coef1) <- var1 <- names(dat)
rdata1 <- dat
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODE
  moddat <- na.omit(dat21[,c(i,cov)])
  g <- glm(moddat[,i]~.,data=moddat[,-1]) #fit model remove NAs
  coef1[j,] <- g$coefficients["phys"]
  #ANOVA
  a <-   anova(g,test="Chisq")
  mod1[j,] <- a$`Pr(>Chi)`[-1]
  #TRANSFORM data for correlation analysis
  covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<0.05][-1]) #get significant covariates + casecontrol status
  rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

#Estimates:
mod1.bh <- apply(mod1,2,p.adjust,method="BH")
mod11 <- data.frame(var=rownames(mod1.bh),ifelse(mod1.bh<=0.05,1,0)) 
sign1 <- mutate(mod11,sum.sign=rowSums(mod11[-1])) %>% filter(sum.sign>0) #get significant variables 
sign1

# Physical activity:
pa <- mod1[,7]
bh <- cbind(coef1,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
bh <- round(bh,4)
bh[bh[,2]<0.05,]
nn <- rownames(bh[bh[,3]<0.05,])

# Enroth variables:
enroth <- data.frame(var=rownames(mod1),mod1)
enroth <- dplyr::select(enroth,var,Age,Sex,Length,Weight,BMI,SBP,DBP,Smoking,Snus)
enroth <- enroth[enroth$var %in% natcom1$var,]
enroth <- enroth[order(enroth$var),]
natcom1 <- natcom1[order(natcom1$var),]
# BH p values:
enroth.bh <- apply(enroth[,-1],2,p.adjust,method="BH")
enroth1 <- data.frame(var=rownames(enroth.bh),ifelse(enroth.bh<=0.05,1,0)) 
#enroth1 <- mutate(enroth.bh11,sum.sign=rowSums(enroth.bh11[-1])) %>% filter(sum.sign>0) #get significant variables 

# Export estimates to excel
#write.xlsx(bh[bh[,2]<0.05,], file ="hej proteins2.xlsx",sheetName = "TestSheet", row.names = T)

# PLOTTING   ----------------- 
# plot "significant" variables
gdata <- dat21[,c("phys",nn)]
gdata$phys <- as.factor(gdata$phys)
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys,fill=phys))+
  geom_boxplot(outlier.shape=NA,alpha=0.3) + #avoid plotting outliers twice
  geom_jitter(aes(color=phys),position=position_jitter(width=.35, height=0),size=0.5)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Scatter plot with reg line
gdata <- dat21[,c("phys",nn)]
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys))+
  facet_wrap(~variable,scales="free")+theme_bw()+
  geom_smooth(method = "lm", se=FALSE, color="blue", formula = y ~ x) +
  geom_point(size=0.5,alpha=0.3)

# plot "significant" variables in full data, both sample 1 & 2
gdata <- dat1[,c("provnr","g6",nn)]
gdata$provnr <- as.factor(gdata$provnr)
gdata$g6 <- as.factor(gdata$g6)
gdata2 <- melt(gdata,id=c("provnr","g6"))
ggplot(gdata2,aes(x = g6, y = value,fill=provnr))+
  facet_wrap(~variable, scales="free")+
    geom_boxplot(outlier.shape=NA,alpha=0.2)+ #avoid plotting outliers twice
  geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
  theme_bw()

```

Prov 1 - Scatterplots:

```{r,echo0F}
#Scatterplotmatrix

panel.cor <- function(x, y, digits = 2, cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  # correlation coefficient
  r <- cor(x, y,method="spearman",use="complete")
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.6, txt)
  
  # p-value calculation
  p <- cor.test(x, y)$p.value
  txt2 <- format(c(p, 0.123456789), digits = digits)[1]
  txt2 <- paste("p= ", txt2, sep = "")
  if(p<0.01) txt2 <- paste("p= ", "<0.01", sep = "")
  text(0.5, 0.4, txt2)
}

#Diagonal histograms
panel.hist <- function(x, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) )
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks; nB <- length(breaks)
  y <- h$counts; y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, ...)
}

# MODEL 1
gdata <- dat21[,c(nn,"phys")]
#plot with pairs, 9*10 inch
pairs(gdata, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")


```

Prov 2:

```{r,echo=F}

# Data fix   ----------------- 
dat21 <- filter(dat1,provnr==2)

# Physical activity: 

# PA-index:
#dat21["phys"] <- dat21$pa_index
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,1,2,2) #Slå ihop grupper G6
# G6
dat21["phys"] <- dat21$g6
#dat21$phys <- as.factor(dat21$phys)
#levels(dat21$phys) <- c(1,2,3,4,4) #Slå ihop grupper G6

# data frame for ztransform:
dat <- dplyr::select(dat21,one_of(var))

# Variables with many missing:
na <- apply(dat,2,function(x) sum(is.na(x))/length(x))
plot(na);abline(h=0.5)
#remove variables with above 50% missing:
manyna <- names(na[na>=0.5])
dat <- dplyr::select(dat,-one_of(manyna))

# Model fitting   ----------------- 

# lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","bmi","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 

# Matrix to store estimate in:
mod1 <- matrix(nrow=ncol(dat),ncol=length(cov))
coef1 <- matrix(nrow=ncol(dat),ncol=1)
colnames(mod1) <- c("Case","Age","Sex","Height","Weight","BMI","Physical activity","Colesterol","Triglycerides","Glucose","Glucose tolerance","SBP","DBP","Smoking","Snus","Medications")
rownames(mod1) <- rownames(coef1) <- var1 <- names(dat)
rdata1 <- dat
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODE
  moddat <- na.omit(dat21[,c(i,cov)])
  g <- glm(moddat[,i]~.,data=moddat[,-1]) #fit model remove NAs
  coef1[j,] <- g$coefficients["phys"]
  #ANOVA
  a <-   anova(g,test="Chisq")
  mod1[j,] <- a$`Pr(>Chi)`[-1]
  #TRANSFORM data for correlation analysis
  covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<0.05][-1]) #get significant covariates + casecontrol status
  #rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

#Estimates:
mod1.bh <- apply(mod1,2,p.adjust,method="BH")
mod11 <- data.frame(var=rownames(mod1.bh),ifelse(mod1.bh<=0.05,1,0)) 
sign2 <- mutate(mod11,sum.sign=rowSums(mod11[-1])) %>% filter(sum.sign>0) #get significant variables 
sign2

# Physical activity:
pa <- mod1[,7]
bh <- cbind(coef1,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
bh <- round(bh,3)
bh[bh[,2]<0.06,]
nn <- rownames(bh[bh[,3]<0.05,])


# Export estimates to excel
write.xlsx(bh[bh[,2]<0.05,], file ="hej proteins2.xlsx",sheetName = "TestSheet", row.names = T)

# PLOTTING   ----------------- 
# plot "significant" variables
gdata <- dat21[,c("phys",nn)]
gdata$phys <- as.factor(gdata$phys)
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys,fill=phys))+
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.35, height=0),size=0.5,alpha=0.3)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Scatter plot with reg line
gdata <- dat21[,c("phys",nn)]
gdata2 <- melt(gdata,id="phys")
ggplot(gdata2,aes(y=value,x=phys))+
  facet_wrap(~variable,scales="free")+theme_bw()+
  geom_smooth(method = "lm", se=FALSE, color="blue", formula = y ~ x) +
  geom_point(size=0.5,alpha=0.3)

# plot "significant" variables in full data, both sample 1 & 2
gdata <- dat1[,c("provnr","g6",nn)]
gdata$provnr <- as.factor(gdata$provnr)
gdata$g6 <- as.factor(gdata$g6)
gdata2 <- melt(gdata,id=c("provnr","g6"))
ggplot(gdata2,aes(x = g6, y = value,fill=provnr))+
  facet_wrap(~variable, scales="free")+
    geom_boxplot(outlier.shape=NA,alpha=0.2)+ #avoid plotting outliers twice
  geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
  theme_bw()

```



Repeated measures analysis (Dmitry method):

```{r,echo=F}

# Data fix -----------------

# Några saknar upprepade prover: Samma om man använder LOB eller NA data
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Physical activity vairabel
#dat.lme["phys"] <- dat.lme$pa_index
dat.lme["phys"] <- dat.lme$g6

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1,y=dat.2,by="person")
dim(dat.rep)
#dat.rep$phys.x <- as.factor(dat.rep$phys.x)
#levels(dat.rep$phys.x) <- c(1,2,3,4,4) #Slå ihop grupper G6

# Hur mkt har livsstilsvariaberna ändrats på 10 år?
#View(dat.2[,9:21]-dat.1[9:21]) 
#View(dat.rep[,c("pa_index.x","pa_index.y","g6.x","g6.y")]) 

# Data frames för z-transform
dat.11 <- dplyr::select(dat.1,one_of(var))
dat.22 <- dplyr::select(dat.2,one_of(var))

# Variables with many missing: Remove with over 50% missing
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
na2 <- apply(dat.22,2,function(x) sum(is.na(x))/length(x))
#plot(na1)
#plot(na2)
manyna1 <- names(na1[na1>=0.5])
manyna2 <- names(na2[na2>=0.5])
# Remove them: (only important if dat1 is used)
dat <- dplyr::select(dat.11,-one_of(unique(c(manyna1,manyna2))))

# Model fitting  -----------------

# Lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","bmi","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
cov <- paste(cov,"x",sep=".")

# Matrix to store estimate in:
modd <- mod <- matrix(nrow=ncol(dat),ncol=length(cov)+1)
coeff <- coefd <- matrix(nrow=ncol(dat),ncol=1)
colnames(modd) <-colnames(mod) <- c("Baseline","Case","Age","Sex","Height","Weight","BMI","Physical activity","Colesterol","Triglycerides","P-glucose","Glucose tolerance","SBP","DBP","Smoking","Snus","Medications")
rownames(modd) <- rownames(mod) <- var1 <- names(dat)
rdata1 <- dat.22
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODEL 1 - adjusting for baseline
  moddat <- na.omit(dat.rep[,c(paste(i,"y",sep="."),paste(i,"x",sep="."),cov)])
  g <- glm(moddat[,paste(i,"y",sep=".")]~.,data=moddat[,-1]) #fit model remove NAs
  coeff[j,] <- g$coefficients["phys.x"]
  #ANOVA 1
  a <-   anova(g,test="Chisq")
  mod[j,] <- a$`Pr(>Chi)`[-1]
  #MODEL 2 - differences
  moddat <- data.frame(diff=dat.rep[,paste(i,"x",sep=".")]-dat.rep[,paste(i,"y",sep=".")],dat.rep[,cov])
  moddat <- na.omit(moddat)
  gd <- glm(diff~.,data=moddat) #fit model remove NAs
  coefd[j,] <- gd$coefficients["phys.x"]
  #ANOVA 2 
  ad <-   anova(gd,test="Chisq")
  modd[j,] <- c(1,ad$`Pr(>Chi)`[-1])

  #TRANSFORM data for correlation analysis
  #covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<alpha][-1]) #get significant covariates + casecontrol status
  #rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

#Estimates: MODEL 1 - baseline followup
modf.bh <- apply(mod[,-1],2,p.adjust,method="BH")
modf <- data.frame(var=rownames(modf.bh),ifelse(modf.bh<=0.05,1,0)) 
signf <- mutate(modf,sum.sign=rowSums(modf[-1])) %>% filter(sum.sign>0) #get significant variables 
signf

# Estimates: MODEL 2 - Diff:
modd.bh <- apply(modd,2,p.adjust,method="BH")
modd1 <- data.frame(var=rownames(modd.bh),ifelse(modd.bh<=0.05,1,0)) 
signd <- mutate(modd1,sum.sign=rowSums(modd1[-1])) %>% filter(sum.sign>0) #get significant variables 
signd

#Phyiscal activiry: MODEL 1 - baseline followup
pa <- mod[,8]
p <- cbind(coeff,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
p[p[,2]<0.05,]
nn <- rownames(p[p[,2]<0.05,])

# Physical activity MODEL 2 - Diff:
pa <- modd[,8]
pd <- cbind(coefd,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
pd[pd[,2]<0.05,]
nnd <- rownames(pd[pd[,2]<0.05,])

# Export estimates to excel
#write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
#write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)


# PLOTTING  ----------------- 

dat.rep$phys.x <- as.factor(dat.rep$phys.x)
dat.rep$phys.y <- as.factor(dat.rep$phys.y)

# MODEL 1 - plot "significant" variables 7*7 inch
gdata <- data.frame(phys.1 = dat.rep[,"phys.x"],phys.2 = dat.rep[,"phys.y"],dat.rep[,paste(nn,"y",sep=".")])
gdata2 <- melt(gdata,id=c("phys.1","phys.2"))
ggplot(gdata2,aes(y=value,x=phys.1,fill=phys.1))+
  geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
  geom_jitter(aes(color=phys.2),position=position_jitter(width=.35, height=0),size=1.75,pch=20)+
  facet_wrap(~variable,scales="free")+theme_bw()

# MODEL 2 - plot "significant" variables 
gdata <- data.frame(phys.1=dat.rep[,c("phys.x")], phys.2=dat.rep[,c("phys.y")], (dat.rep[,paste(nnd,"x",sep=".")]-dat.rep[,paste(nnd,"y",sep=".")]))
gdata2 <- melt(gdata,id=c("phys.1","phys.2"))
ggplot(gdata2,aes(y=value,x=phys.1,fill=phys.1))+
  geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
  geom_jitter(aes(color=phys.2),position=position_jitter(width=.35, height=0),size=1.75,pch=20)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Change paths in physical activity
gdata <- dat1[,c("pa_index","g6","person","provnr")]
gdata$provnr <- as.factor(gdata$provnr)
gdata$g6 <- as.factor(gdata$g6)
gdata$pa_index <- as.factor(gdata$pa_index)
gdata <- na.omit(gdata)
gdata <- melt(gdata,id=c("person","provnr"))
ggplot(gdata,aes(x = provnr, y = value, color = value,group=person,label=person))+
  #geom_point(aes(color=g6),position=position_jitter(width=0.1, height=0.3),size=0.5)+
  geom_line(aes(color=value),position=position_jitter(width=.1, height=0.3),size=0.5)+
  facet_wrap(~variable,scales="free")+theme_bw()

# Test - inga skillnader mellan G6 och PA-index mellan proven
testdata <- na.omit(dat.rep[,c("g6.x","g6.y")])
wilcox.test(testdata[,1],testdata[,2], paired=TRUE)
testdata <- na.omit(dat.rep[,c("pa_index.x","pa_index.y")])
wilcox.test(testdata[,1],testdata[,2], paired=TRUE)

#
g <- glm(ESM_1~as.factor(casecontrol)+g6*as.factor(provnr),data=dat1)
```


SCatterplots:
```{r,echo=F}
#Scatterplotmatrix

panel.cor <- function(x, y, digits = 2, cex.cor, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  # correlation coefficient
  r <- cor(x, y,method="spearman",use="complete")
  txt <- format(c(r, 0.123456789), digits = digits)[1]
  txt <- paste("r= ", txt, sep = "")
  text(0.5, 0.6, txt)
  
  # p-value calculation
  p <- cor.test(x, y)$p.value
  txt2 <- format(c(p, 0.123456789), digits = digits)[1]
  txt2 <- paste("p= ", txt2, sep = "")
  if(p<0.01) txt2 <- paste("p= ", "<0.01", sep = "")
  text(0.5, 0.4, txt2)
}

#Diagonal histograms
panel.hist <- function(x, ...)
{
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) )
  h <- hist(x, plot = FALSE)
  breaks <- h$breaks; nB <- length(breaks)
  y <- h$counts; y <- y/max(y)
  rect(breaks[-nB], 0, breaks[-1], y, ...)
}

# MODEL 1
gdata <- dat.rep[,c(paste(nn,"y",sep="."),"phys.x")]
#plot with pairs, 9*10 inch
pairs(gdata, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")

# Model 2
gdata <- data.frame((dat.rep[,paste(nnd,"x",sep=".")]-dat.rep[,paste(nnd,"y",sep=".")]),phys.x=dat.rep[,c("phys.x")])
#plot with pairs, 9*10 inch
pairs(gdata, diag.panel = panel.hist, upper.panel = panel.smooth,lower.panel = panel.cor,pch=19,cex=0.2,cex.labels=1.2, gap=0.5,col.smooth="black",col="gray")

```

 
DoE approach, as Per Johansson metabolomics:

Repeated measures analysis:

```{r,echo=F}

# Data fix -----------------
dat.lme <- dat1

# Physical activity vairabel
#dat.lme["phys"] <- dat.lme$pa_index
dat.lme["phys"] <- dat.lme$g6
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="2") 

dat.11 <- dplyr::select(dat.lme,one_of(var))

# Variables with many missing: Remove with over 50% missing
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])
# Remove them: (only important if dat1 is used)
dat <- dplyr::select(dat.11,-one_of(c(manyna1)))
var1 <- names(dat)
alpha <- 0.05/length(var1)


# Model fitting  -----------------

# Lifestyle variables: KÖR BMI för sig, verkar vara problem
cov <- c("age","gender","langd","vikt","phys","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
p <- length(cov)
covm <- c("age","gender","phys","smoke","snus","med","bmi","bmi3","metsz","mets2","ht2","htm") 
pm <- length(covm)
# Matrix to store estimate in:
mod1 <- coef1 <- mod2 <- coef2 <- sd1 <- matrix(nrow=ncol(dat),ncol=length(cov))
mod.mets1 <- mod.mets2 <- matrix(nrow=ncol(dat),ncol=6)
coef.mets1 <- coef.mets2 <- sd.mets1 <- matrix(nrow=ncol(dat),ncol=8) 
# colnames
colnames(mod1) <- colnames(coef1) <- colnames(mod2) <- colnames(coef2) <- colnames(sd1) <- c("Age","Sex","Height","Weight","Physical activity","Colesterol","Triglycerides","P-glucose","Glucose tolerance","SBP","DBP","Smoking","Snus","Medications")
colnames(mod.mets1) <- colnames(mod.mets2)  <-  c("BMIgroups","BMIcont","MetSgroups","MetScont","HT","HTmed")
colnames(coef.mets1) <- colnames(coef.mets2) <- colnames(sd.mets1) <- c("BMI<20","BMI25-30","BMI>30","BMIcont","MetSgroups","MetScont","HT","HTmed")
# rownames
rownames(mod1) <- rownames(coef1) <- rownames(mod2) <- rownames(coef2) <- rownames(mod.mets1) <- rownames(coef.mets1)  <- rownames(mod.mets2) <- rownames(coef.mets2) <- rownames(sd1) <- rownames(sd.mets1) <- var1 
#var1 <- sort(var1)
rdata1 <- mutate(dat,provnr=dat.lme$provnr) %>% filter(provnr==1) %>% dplyr::select(-provnr)
rdata2 <- mutate(dat,provnr=dat.lme$provnr) %>% filter(provnr==2) %>% dplyr::select(-provnr)
j=0

# Main loop:
for(i in var1){
  j=j+1
  cat(length(var1)-j," ")
  # MODEL
  for(l in 1:p){
    moddat <- na.omit(dat.lme[,c(i,"casecontrol","provnr",cov)])
    formula1 <- as.formula(paste("moddat[,i]","~","+casecontrol+",cov[l],"*provnr+",paste(cov[-l],collapse="+"),sep=""))
    #formula1 <- as.formula(paste("moddat[,i]","~","+casecontrol+",cov[l],"*provnr+","gender+age",sep=""))
    g <- glm(formula1,data=moddat) #fit model remove NAs  
    a <-   anova(g,test="Chisq")
    mod1[j,l] <- a$`Pr(>Chi)`[3]
    mod2[j,l] <- a$`Pr(>Chi)`[18] #18
    coef2[j,l] <- coef(g)[20] #20
    #För att få rätt coefficients:
    formula2 <- as.formula(paste("moddat[,i]","~","+casecontrol+",cov[l],"+provnr+",paste(cov[-l],collapse="+"),sep=""))
    #formula1 <- as.formula(paste("moddat[,i]","~","+casecontrol+",cov[l],"*provnr+","gender+age",sep=""))
    g2 <- glm(formula2,data=moddat) #fit model remove NAs  
    coef1[j,l] <- coef(g2)[3]
    sd1[j,l] <- tidy(g2)[3,3]
  }
  
  # TRANSFORM data for correlation analysis - model
  g3 <- glm(moddat[,i]~.,data=moddat[,-1]) #fit model remove NAs
  # ANOVA 
  a3 <-   anova(g,test="Chisq")
  # EXCTRACT significant covariates and rank-TRANSFORM 
  covt <- c(i,"casecontrol","provnr",row.names(a)[a$`Pr(>Chi)`<alpha][-1]) #get significant covariates + casecontrol status
  rdata1[,j] <- rntransform(dat.lme[dat.lme$provnr==1,i],data=dat.lme[dat.lme$provnr==1,covt],family="gaussian") 
  rdata2[,j] <- rntransform(dat.lme[dat.lme$provnr==2,i],data=dat.lme[dat.lme$provnr==2,covt],family="gaussian") 
  
  # BMI and MetS analyses:
    moddat <- na.omit(dat.lme[,c(i,"casecontrol","provnr",covm)])
    gm1 <- glm(moddat[,i]~bmi3*provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm2 <- glm(moddat[,i]~bmi*provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm3 <- glm(moddat[,i]~mets2*provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm4 <- glm(moddat[,i]~metsz*provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm5 <- glm(moddat[,i]~ht2*provnr+casecontrol+age+gender+phys+smoke+snus+med+bmi,data=moddat) #fit model remove NAs
    gm6 <- glm(moddat[,i]~htm*provnr+casecontrol+age+gender+phys+smoke+snus+bmi,data=moddat) #fit model remove NAs

  # ANOVA
    am1 <-   anova(gm1,test="Chisq")
    am2 <-   anova(gm2,test="Chisq")
    am3 <-   anova(gm3,test="Chisq")
    am4 <-   anova(gm4,test="Chisq")
    am5 <-   anova(gm5,test="Chisq")
    am6 <-   anova(gm6,test="Chisq")
    # P for Effect 
    mod.mets1[i,1] <- am1$`Pr(>Chi)`[2]
    mod.mets1[i,2] <- am2$`Pr(>Chi)`[2]
    mod.mets1[i,3] <- am3$`Pr(>Chi)`[2]
    mod.mets1[i,4] <- am4$`Pr(>Chi)`[2]
    mod.mets1[i,5] <- am5$`Pr(>Chi)`[2]
    mod.mets1[i,6] <- am6$`Pr(>Chi)`[2]
    # Interaction with provnr
    mod.mets2[i,1] <- am1$`Pr(>Chi)`[11]
    mod.mets2[i,2] <- am2$`Pr(>Chi)`[11]
    mod.mets2[i,3] <- am3$`Pr(>Chi)`[11]
    mod.mets2[i,4] <- am4$`Pr(>Chi)`[11]
    mod.mets2[i,5] <- am5$`Pr(>Chi)`[11]
    mod.mets2[i,6] <- am6$`Pr(>Chi)`[11]
    # Coef for Effect 
    gm1 <- glm(moddat[,i]~bmi3+provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm2 <- glm(moddat[,i]~bmi+provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm3 <- glm(moddat[,i]~mets2+provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm4 <- glm(moddat[,i]~metsz+provnr+casecontrol+age+gender+phys+smoke+snus+med,data=moddat) #fit model remove NAs
    gm5 <- glm(moddat[,i]~ht2+provnr+casecontrol+age+gender+phys+smoke+snus+med+bmi,data=moddat) #fit model remove NAs
    gm6 <- glm(moddat[,i]~htm+provnr+casecontrol+age+gender+phys+smoke+snus+bmi,data=moddat) #fit model remove NAs

    coef.mets1[i,1:3] <- coef(gm1)[2:4] # coef for BMI > 30 
    coef.mets1[i,4] <- coef(gm2)[2] 
    coef.mets1[i,5] <- coef(gm3)[2] 
    coef.mets1[i,6] <- coef(gm4)[2] 
    coef.mets1[i,7] <- coef(gm5)[2]
    coef.mets1[i,8] <- coef(gm6)[2]
    
    sd.mets1[i,1:3] <- tidy(gm1)[2:4,3] # coef for BMI > 30 
    sd.mets1[i,4] <- tidy(gm2)[2,3]
    sd.mets1[i,5] <- tidy(gm3)[2,3] 
    sd.mets1[i,6] <- tidy(gm4)[2,3]
    sd.mets1[i,7] <- tidy(gm5)[2,3]
    sd.mets1[i,8] <- tidy(gm6)[2,3]
    
}

# Estimates: main effect
modf.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
modm <- data.frame(var=rownames(modf.bh0),ifelse(modf.bh0<=0.05,1,0)) 
signm <- mutate(modm,sum.sign=rowSums(modm[,-1])) %>% filter(sum.sign>0) #get significant variables 
signm <- signm[order(signm$var),]
coefm <- data.frame(var=rownames(coef1),coef1)
signm 
  
# Estimates: Provnr interaction effect
modl.bh <- apply(mod2,2,p.adjust,method="bonferroni")
#modl.bh <- mod2
modl <- data.frame(var=rownames(modl.bh),ifelse(modl.bh<=0.05,1,0)) 
signl <- mutate(modl,sum.sign=rowSums(modl[,-1])) %>% filter(sum.sign>0) #get significant variables 
signl

# Look at interactions with provnr with lowest p-values:
modl2 <- data.frame(var=rownames(modl.bh),modl.bh)
signl2 <- melt(modl.bh,id="var")
signl2 <- filter(signl2,value!=1)
signl2 <- signl2[order(signl2$value,decreasing = F),]
signl2["p"] <- round(signl2$value/length(var1),4)
signl2
signl3 <- drop.levels(signl2)
signl3 <- as.matrix(table(signl3$X1,signl3$X2))
signl3
sign3 <- data.frame(var=rownames(signl3),ifelse(signl3==0,0,1)) 

# METS and BMI estimates: main effect
mets.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.sign <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,-1])) %>% filter(sum.sign>0) #get significant variables 
mets.sign <- mets.sign[order(mets.sign$var),]
mets.coef <- data.frame(var=rownames(coef.mets1),coef.mets1)
mets.sign 

# METS and BMI estimates: interaction effect NONE
mets.bh2 <- apply(mod.mets2,2,p.adjust,method="bonferroni")
mets.bh22 <- data.frame(var=rownames(mets.bh2),ifelse(mets.bh2<=0.05,1,0)) 
mets.sign2 <- mutate(mets.bh22,sum.sign=rowSums(mets.bh22[,-1])) %>% filter(sum.sign>0) #get significant variables 
mets.sign2 <- mets.sign2[order(mets.sign2$var),]
mets.sign2 

# Look at interactions with provnr with lowest p-values:
x1 <- data.frame(var=rownames(mod.mets2),mod.mets2)
mets.sign3 <- melt(x1,id="var")
mets.sign3 <- filter(mets.sign3,value<0.05)
mets.sign3 <- mets.sign3[order(mets.sign3$value,decreasing = F),]
mets.sign3
mets.sign4 <- drop.levels(mets.sign3)
mets.sign4 <- as.matrix(table(mets.sign4$var,mets.sign4$variable))
mets.sign4
mets.sign4 <- data.frame(var=rownames(mets.sign4),ifelse(mets.sign4==0,0,1)) 

# Skapa Sophias excel-fil:
# adj p
mod.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
mod.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")

sop <- data.frame(padj=mod.bh0[,1],age=coef1[,1],agesd=sd1[,1],
                  padj=mod.bh0[,2],sex=coef1[,2],sexsd=sd1[,2],
                  padj=mod.bh0[,3],height=coef1[,3],heightsd=sd1[,3],
                  padj=mod.bh0[,4],weight=coef1[,4],weightsd=sd1[,4],
                  padj=mod.bh0[,6],chol=coef1[,6],cholsd=sd1[,6],
                  padj=mod.bh0[,7],trig=coef1[,7],cholsd=sd1[,7],
                  padj=mod.bh0[,10],sbt=coef1[,10],sbtsd=sd1[,10],
                  padj=mod.bh0[,11],dbt=coef1[,11],dbtsd=sd1[,11],
                  padj=mod.bh1[,5],HT=coef.mets1[,7],HTsd=sd.mets1[,7],
                  padj=mod.bh1[,6],HTmed=coef.mets1[,8],HTmedsd=sd.mets1[,8],
                  padj=mod.bh1[,1],BMI20=coef.mets1[,1],BMI20sd=sd.mets1[,1],BMI2530=coef.mets1[,2],BMI2530sd=sd.mets1[,2],BMI30=coef.mets1[,3],BMI30sd=sd.mets1[,3],
                  padj=mod.bh1[,2],BMIcont=coef.mets1[,4],BMIcontsd=sd.mets1[,4],
                  padj=mod.bh1[,3],Mets=coef.mets1[,5],Metssd=sd.mets1[,5],
                  padj=mod.bh1[,4],Metscont=coef.mets1[,6],Metscontsd=sd.mets1[,6])
sop["var"] <- rownames(sop)
sop <- sop[order(sop$var),]
# Export estimates to excel
#write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
#write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
write.xlsx(sop, file ="sophia3.xlsx",sheetName = "TestSheet", row.names = T)


```

Metabolomics method PLOTS:

```{r,echo=F}

# PLOTTING  -----------------
#Loop som plottar alla singificanta associationer:

nam <- c("Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
str(dat.lme[,cov])
k=0
for(i in cov){
  k=k+1
  # Ta ut significants
  s1 <- signm[,c("var",nam[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  s1 <- data.frame(s1,coef=round(coefm[nn,nam[k]],4))
  cat("\nSignificant associations: \n")
  print(nam[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
  #Samma som i Enroth?
  if(nam[k] %in% names(natcom)){
    nat1 <- natcom[natcom[,nam[k]]>0,]
  cat("\nAlso significant in Enroth 2014 \n")
  print(s1[s1[,1] %in% nat1[,1],])
  }else cat("\nCovariate not included in Enroth 2014 \n")
  # Plotta 
  if(sum(signm[,nam[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme[,i])==T){ 
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  }else{
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  } 
}

```


Metabolomics method PLOTS 2 - interaction with ProvNR: 
```{r,echo=F}


# Plot variables with possible interaction with PROVNR
covx <- cbind(nam,cov)
colnames(signl3) <- gsub(' ', '.', colnames(signl3))
colnames(signl3) <- gsub('-', '.', colnames(signl3))
cov2 <- covx[covx[,1] %in% colnames(signl3),2]
nam2 <- covx[covx[,1] %in% colnames(signl3),1]
k=0
#dat.lme2 <- filter(dat.lme,blods0>3,blods0<10) %>% filter(FGF_5<3)
dat.lme2 <- dat.lme

for(i in cov2){
  k=k+1
  # Ta ut significants
  s1 <- sign3[,c("var",nam2[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  s1 <- data.frame(s1,coef=round(coefm[nn,nam2[k]],4))
  cat("\nSignificant associations: \n")
  print(nam2[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
 
    # Plotta 
  if(sum(sign3[,nam2[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme2[,i])==T){ 
    gdata <- dat.lme2[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab("Provnr")+ylab("")+ggtitle(nam2[k]))
  }else{
    gdata <- dat.lme2[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam2[k])+ylab(""))
  } 
}


```


Metabolomics method PLOTS - MetS and BMI:

```{r,echo=F}

# PLOTTING  -----------------
#Loop som plottar alla singificanta associationer:

nam <- colnames(mod.mets2)
covm2 <- c("bmi3","bmi","mets2","metsz","ht2","htm")
str(dat.lme[,covm])
dat.lme$ht2 <- as.factor(dat.lme$ht2)
dat.lme$htm <- as.factor(dat.lme$htm)
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="1") 
k=0
for(i in covm2){
  k=k+1
  # Ta ut significants
  s1 <- mets.sign[,c("var",nam[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  if(nam[k]=="BMIgroups"){
    s1 <- data.frame(s1,coef=round(mets.coef[nn,2:4],4))
  }else{ s1 <- data.frame(s1,coef=round(mets.coef[nn,nam[k]],4)) } 
  cat("\nSignificant associations: \n")
  print(nam[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
  # Plotta 
  if(sum(mets.sign[,nam[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme[,i])==T){ 
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  }else{
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  } 
}

```


MetS and BMI- One protein potentially interacting with provNR 
```{r,echo=F}
mets.sign4
nam <- colnames(mod.mets2)
covm2 <- c("bmi3","bmi","mets2","metsz","ht2","htm")
str(dat.lme[,covm])
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="1") 

# Plot variables covm2 possible interaction with PROVNR
covx <- cbind(nam,covm2)
cov2 <- covx[covx[,1] %in% colnames(mets.sign4),2]
nam2 <- covx[covx[,1] %in% colnames(mets.sign4),1]
k=0
#dat.lme2 <- filter(dat.lme,blods0>3,blods0<10) %>% filter(FGF_5<3)
dat.lme2 <- dat.lme

for(i in cov2){
  k=k+1
  # Ta ut significants
  s1 <- mets.sign4[,c("var",nam2[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  s1 <- data.frame(s1,coef=round(mets.coef[nn,nam2[k]],4))
  cat("\nSignificant associations: \n")
  print(nam2[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
 
    # Plotta 
  if(sum(mets.sign4[,nam2[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme2[,i])==T){ 
    gdata <- dat.lme2[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab("Provnr")+ylab("")+ggtitle(nam2[k]))
  }else{
    gdata <- dat.lme2[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam2[k])+ylab(""))
  } 
}

dplyr::select(dat.lme,1:30,FR_gamma) %>% filter(FR_gamma>8) %>% summary()
dplyr::select(dat.lme,1:30,FR_gamma) %>% filter(FR_gamma<8) %>% summary()

ggplot(dat.lme, aes(x=FR_gamma, fill=as.factor(provnr))) +
    geom_histogram(binwidth=0.1, alpha=.5, position="identity")+ theme_bw()

ggplot(dat.lme, aes(x=FR_gamma, fill=as.factor(gender))) +
    geom_histogram(binwidth=0.1, alpha=.5, position="identity")+ theme_bw()

ggplot(dat.lme, aes(x=FR_gamma, fill=as.factor(casecontrol))) +
    geom_histogram(binwidth=0.1, alpha=.5, position="identity")+ theme_bw()

```

Mets Matched line plot prov 1 och 2:
```{r match line plots,echo=F}
x1 <- c("CCL4","FGF_21","FURIN","HGF","LYPD3","SCF","SEZ6L")
x2 <- c("ERBB2","ESM_1","FGF_21","FGF_BP1","FURIN","HGF","IL_18R1","IL_7","IL_8","LYPD3","SCF","TNFSF14","VEGFR_2")

#mets continous
gdata <- dplyr::select(dat.lme,metsz,provnr,person,one_of(x2))
gdata$provnr <- as.factor(gdata$provnr)
gdata2 <- melt(gdata,id=c("metsz","provnr","person"))
gdata2 <- gdata2[order(gdata2$provnr),]
# Skapa diff variabel mellan prov 1 och 2 för mets och markörer 
gdata2 <- transform(gdata2, 
          metsdiff=ave(metsz, person, variable,  FUN=function(x) diff(x)),
          valuediff=ave(value, person, variable,  FUN=function(x) diff(x)))
gdata2 <- mutate(gdata2,
                 metschange=ifelse(metsdiff>0,"increase","decrease"),
                 valuechange=ifelse(valuediff>0,"increase","decrease"),
                 metsvaluechange=interaction(metschange,valuechange))
#colors:
pal <- c("dodgerblue","dodgerblue4","firebrick","darkorchid","gold","darkorange")

# plot
ggplot(gdata2,aes(y=value,x=metsz))+
    geom_smooth(aes(fill=provnr),method="lm",color="black",alpha=0.3)+
    geom_line(aes(group=as.factor(person),color=metsvaluechange),alpha=0.8,size=0.5)+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab("MetS continous")+ylab("")+
    scale_fill_manual(values=pal)+
    scale_color_manual(values=pal)

# Mets groups - blir shit! 
gdata <- dplyr::select(dat.lme,mets2,provnr,person,one_of(x1))
gdata$provnr <- as.factor(gdata$provnr)
gdata2 <- melt(gdata,id=c("mets2","provnr","person"))
# plot
ggplot(gdata2,aes(y=value,x=provnr,fill=mets2))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_line(aes(group=as.factor(person)),position=position_dodge(width=0.7),alpha=0.4,size=0.3)+
    #geom_point(aes(color=mets2),position=position_dodge(width=0.7),size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab("MetS yes/no")+ylab("")
#position = position_jitterdodge()

```


MetS changed over time? Predict MetS in sample 2? 

```{r,echo=F}
# Significant variables with mets2
x1 <- c("CCL4","FGF_21","FURIN","HGF","LYPD3","SCF","SEZ6L")
x2 <- c("ERBB2","ESM_1","FGF_21","FGF_BP1","FURIN","HGF","IL_18R1","IL_7","IL_8","LYPD3","SCF","TNFSF14","VEGFR_2")

# Några saknar upprepade prover: Samma om man använder LOB eller NA data
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1,y=dat.2,by="person")

# View sample 1 and 2 BMI / MetS
dat.diff <- dplyr::select(dat.rep,casecontrol.x,age.x,age.y,mets2.x,mets2.y,bmi.x,bmi.y,vikt.x,vikt.y,langd.x,FURIN.x,FURIN.y) %>% 
  mutate(mets.diff = as.numeric(mets2.y)-as.numeric(mets2.x))
View(dat.diff)
table(dat.diff$mets.diff)
dplyr::filter(dat.diff,mets.diff==1) %>% View()

#Predict sample 2 MetS
# Log-reg of yes/no mets variable:
form <- as.formula(paste0("mets2.y~mets2.x+age.x+gender.x+casecontrol.x+",paste0(x1,".x",collapse="+")))
pred1 <- glm(form,
             data=dat.rep,
             family="binomial")
summary(pred1)
cbind(round(exp(cbind(OR = coef(pred1), confint(pred1))),2))

# Lin-reg of metsz
form <- as.formula(paste0("metsz.y~metsz.x+age.x+gender.x+casecontrol.x+",paste0(x2,".x",collapse="+")))
pred2 <- lm(form, data=dat.rep)
summary(pred2)

```



Histograms:

```{r,echo=F}
dplyr::select(dat.lme,provnr,one_of(var1[1:50])) %>% melt(id="provnr") %>%
  ggplot(aes(x=value, fill=as.factor(provnr))) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 
  
dplyr::select(dat.lme,provnr,one_of(var1[51:100])) %>% melt(id="provnr") %>%
  ggplot(aes(x=value, fill=as.factor(provnr))) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 
  
dplyr::select(dat.lme,provnr,one_of(var1[101:length(var1)])) %>% melt(id="provnr") %>%
  ggplot(aes(x=value, fill=as.factor(provnr))) +
  geom_histogram(alpha=.5, position="identity")+
  facet_wrap(~variable,scales="free") + theme_bw() 
  




```


Differences explained by differneces analysis:

```{r,echo=F}

# Data fix -----------------
alpha <- 0.05/182 #Bonferroni level

# Några saknar upprepade prover: Samma om man använder LOB eller NA data
id2 <- names(table(dat1$person)[table(dat1$person)<2])
dat.lme <- dplyr::filter(dat1,!person %in% id2)

# Physical activity vairabel
dat.lme["phys"] <- dat.lme$pa_index
#dat.lme["phys"] <- dat.lme$g6

# Get sample 1 and 2 and merge columns:
dat.1 <- filter(dat.lme,provnr==1);dat.1 <- dat.1[order(dat.1$person),]
dat.2 <- filter(dat.lme,provnr==2);dat.2 <- dat.2[order(dat.2$person),]
sum(dat.1$person==dat.2$person)
dat.rep <- merge(x=dat.1,y=dat.2,by="person")
dim(dat.rep)
#dat.rep$phys.x <- as.factor(dat.rep$phys.x)
#levels(dat.rep$phys.x) <- c(1,2,3,4,4) #Slå ihop grupper G6

# Hur mkt har livsstilsvariaberna ändrats på 10 år?
#View(dat.2[,9:21]-dat.1[9:21]) 
#View(dat.rep[,c("person","pa_index.x","pa_index.y","g6.x","g6.y")]) 
# Variabel för förändring i physical activity per år
# PA
dat.rep["phys.d"] <- dat.rep$phys.y-dat.rep$phys.x
dat.rep$phys.d <- as.factor(dat.rep$phys.d)
levels(dat.rep$phys.d) <- c(-1,-1,-1,0,1,1,1) #Slå ihop gruppe
dat.rep$phys.d <- relevel(dat.rep$phys.d,ref="0")

# G6
dat.rep["phys.d"] <- dat.rep$phys.y-dat.rep$phys.x
dat.rep$phys.d <- as.factor(dat.rep$phys.d)
levels(dat.rep$phys.d) <- c(-1,-1,-1,-1,0,1,1,1,1) #Slå ihop gruppe
dat.rep$phys.d <- relevel(dat.rep$phys.d,ref="0")

# Variables with many missing:
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
na2 <- apply(dat.22,2,function(x) sum(is.na(x))/length(x))
#plot(na1)
#plot(na2)
manyna1 <- names(na1[na1>=0.5])
manyna2 <- names(na2[na2>=0.5])
# Remove them: (only important if dat1 is used)
dat <- dplyr::select(dat.11,-one_of(unique(c(manyna1,manyna2))))

# Model fitting  -----------------

# Lifestyle variables:
cov <- c("casecontrol","age","gender","langd","vikt","skol","stg","blods0","blods2","midbp","smoke","snus","med") 
cov <- paste(cov,"x",sep=".")

# Matrix to store estimate in:
modd <- mod <- matrix(nrow=ncol(dat),ncol=length(cov)+2)
coeff <- coefd <- matrix(nrow=ncol(dat),ncol=2)
colnames(modd) <-colnames(mod) <- c("Baseline","Physical activity","Case","Age","Gender","Height","Weight","Colesterol","Triglycerides","P-glucose","2h Glucose test","mid BP","Smoking","Snus","Medications")
rownames(modd) <- rownames(mod) <- var1 <- names(dat)
rdata1 <- dat.22
j=0

# Main loop:
for(i in var1){
  j=j+1
  #MODEL 1 - adjusting for baseline
  moddat <- na.omit(dat.rep[,c(paste(i,"y",sep="."),paste(i,"x",sep="."),"phys.d",cov)])
  g <- glm(moddat[,paste(i,"y",sep=".")]~.,data=moddat[,-1]) #fit model remove NAs
  coeff[j,] <- g$coefficients[3:4]
  #ANOVA 1
  a <-   anova(g,test="Chisq")
  mod[j,] <- a$`Pr(>Chi)`[-1]
  #MODEL 2 - differences
  moddat <- data.frame(diff=dat.rep[,paste(i,"x",sep=".")]-dat.rep[,paste(i,"y",sep=".")],phys.d=dat.rep[,"phys.d"],dat.rep[,cov])
  moddat <- na.omit(moddat)
  gd <- glm(diff~.,data=moddat) #fit model remove NAs
  coefd[j,] <- gd$coefficients["phys.d"]
  #ANOVA 2 
  ad <-   anova(gd,test="Chisq")
  modd[j,] <- c(1,ad$`Pr(>Chi)`[-1])

  #TRANSFORM data for correlation analysis
  #covt <- c(i,"casecontrol",row.names(a)[a$`Pr(>Chi)`<alpha][-1]) #get significant covariates + casecontrol status
  #rdata1[,j] <- rntransform(dat21[,i],data=dat21[,covt],family="gaussian") 
}

# Estimates: Model 1 - adjusting for baseline
mod3 <- data.frame(var=rownames(mod),ifelse(mod<=alpha,1,0)) 
sign3 <- mutate(mod3,any.sign=rowSums(mod3[2:5])) %>% filter(any.sign>1) #get significant variables 
sign3

#Phyiscal activiry:
pa <- mod[,2]
p <- cbind(coeff,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
p[p[,3]<0.05,]
nn <- rownames(p[p[,3]<0.05,])

# Estimates: Model 2 - Diff:
mod3d <- data.frame(var=rownames(modd),ifelse(modd<=alpha,1,0)) 
sign3d <- mutate(mod3d,any.sign=rowSums(mod3d[2:5])) %>% filter(any.sign>1) #get significant variables 
sign3d

# Physical activity:
pa <- modd[,2]
pd <- cbind(coeff,pa,p.adjust(pa,method="BH"),p.adjust(pa,method="bonferroni"))
pd[pd[,3]<0.05,]
nnd <- rownames(pd[pd[,1]<0.05,])

# Export estimates to excel
write.xlsx(rbind(p[p[,3]<0.05,],pd[pd[,3]<0.05,]), file ="diff diff.xlsx",sheetName = "TestSheet", row.names = T)



# PLOTTING  ----------------- 

dat.rep$phys.x <- as.factor(dat.rep$phys.x)

# MODEL 1 - plot "significant" variables 7*7 inch
gdata <- dat.rep[,c("phys.x",paste(nn,"y",sep="."))]
gdata2 <- melt(gdata,id="phys.x")
ggplot(gdata2,aes(y=value,x=phys.x,fill=phys.x))+
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.35, height=0),size=0.5,alpha=0.3)+
  facet_wrap(~variable,scales="free")+theme_bw()

# MODEL 2 - plot "significant" variables 
gdata <- data.frame(phys.x=dat.rep[,c("phys.x")],(dat.rep[,paste(nnd,"x",sep=".")]-dat.rep[,paste(nnd,"y",sep=".")]))
gdata2 <- melt(gdata,id="phys.x")
ggplot(gdata2,aes(y=value,x=phys.x,fill=phys.x))+
  geom_boxplot(outlier.shape=NA) + #avoid plotting outliers twice
  geom_jitter(position=position_jitter(width=.35, height=0),size=0.5,alpha=0.3)+
  facet_wrap(~variable,scales="free")+theme_bw()



```

The same using lapply

```{r,echo=F}

#DATA
alpha <- 0.05/182 #alpha level bonferroni corrected
dat21 <- filter(dat1,provnr==1)
dat <- select(dat21,starts_with("1"))

#variables with many NAs
na <- apply(dat,2,function(x) sum(is.na(x))/length(x))
plot(na)
manyna <- names(na[na>=0.8])
#remove them:
dat <- select(dat,-one_of(manyna))


#calculate models with LAPPLY
models1 <- lapply(dat, function(q){
   glm(q ~ dat21$casecontrol+dat21$gender+dat21$langd+dat21$vikt)
    })

#get p-values from anova.glm
ps <- lapply(models1,function(x) data.frame(var=names(coef(x)),coef=coef(x),p=anova(x,test="Chisq")$`Pr(>Chi)`))

#extract significant associations
sign <- lapply(ps,function(x) na.omit(x[x$p<=alpha,]))
sign1 <- do.call(rbind, lapply(sign, data.frame, stringsAsFactors=FALSE)) #transform to data frame
sign1

#test
s <- step(models1$"101_IL-8",direction="backward",test="F")


```

#Mixed models:
Use Random intercepts models.
For nlme, the column "Intercept" refers the measure of the variability for each random effect that you added to the model. "Residual" refers to the measure of the variability that is not due to differences between individuals. The ICC here is always non-negative, allowing it to be interpreted as the proportion of total variance that is "between groups." 

```{r}
dat.lme <- dplyr::select(dat1,ESM_1,casecontrol,g6,person,provnr,age,gender,langd,vikt,skol,stg,blods0,blods2,sbt,dbt,smoke,snus,med) %>% na.omit()

test <- lme(ESM_1 ~ 1, random=list(~1|person), dat.lme)
summary(test)
# "between person", variance:
tapply(dat.lme$ESM_1,dat.lme$person,mean)
sd(tapply(dat.lme$ESM_1,dat.lme$person,mean))/sqrt(2)
# Residual "Within person", variance:
tapply(dat.lme$ESM_1,dat.lme$person,sd)
mean(tapply(dat.lme$ESM_1,dat.lme$person,sd),na.rm=T)

#lme4
lme1 <- lmer(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med+(1|person) , dat.lme, REML=F)
(s <- summary(lme1))

#nlme (blir samma)
lme2 <- lme(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, random=list(~1|person), dat.lme,method="ML")
(s <- summary(lme2))
anova(lme2)
#variation in intercept between individuals: basically the same as in the model output, under random effects "Intercept"
sd(lme2$coefficients$random$person)

# Fixed plm doesnt work, duplicated obs
fixed <- plm(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, data=dat.lme, index=c("person"), model="within")
summary(fixed)

# Random plm
random <- plm(ESM_1 ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med, data=dat.lme, index=c("person"), model="random")
summary(random)

#With glm:
glm1 <- glm(ESM_1~casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,dat.lme,family="gaussian")
summary(glm1)
anova(glm1,test="Chisq")

```

##Mixed models loop:

```{r mixed effects models,echo=F}

# Data fix -----------------
dat.lme <- dat1

# Physical activity vairabel
#dat.lme["phys"] <- dat.lme$pa_index
dat.lme["phys"] <- dat.lme$g6
dat.lme$bmi3 <- relevel(dat.lme$bmi3,ref="2") 

dat.11 <- dplyr::select(dat.lme,one_of(var))

# Variables with many missing: Remove with over 50% missing
na1 <- apply(dat.11,2,function(x) sum(is.na(x))/length(x))
plot(na1);abline(h=0.5)
na1[na1>=0.5]
manyna1 <- names(na1[na1>=0.5])
# Remove them: (only important if dat1 is used)
dat <- dplyr::select(dat.11,-one_of(c(manyna1)))
var1 <- names(dat)
alpha <- 0.05/length(var1)


#Loop:
library(nlme)
#calculate models with LAPPLY
models1 <- lapply(dat.lme[,var1], function(q){
   lme(q ~ casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random = ~1|person,
            na.action=na.omit,
            data=dat.lme)
    })

summary(models1$IL_8)
anova(models1$IL_8,test="Chisq")

#
# Model fitting  -----------------

# Lifestyle variables: KÖR BMI för sig, verkar vara problem
cov <- c("casecontrol","age","gender","langd","vikt","g6","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
p <- length(cov)
covm <- c("casecontrol","age","gender","g6","smoke","snus","med","bmi","bmi3","metsz","mets2","ht2","htm") 
pm <- length(covm)
# Matrix to store estimate in:
mod1 <- mod2 <- matrix(nrow=ncol(dat),ncol=length(cov))
coef1 <- sd1 <- matrix(nrow=ncol(dat),ncol=length(cov)+2)
mod.mets1 <- mod.mets2 <- matrix(nrow=ncol(dat),ncol=6)
coef.mets1 <- coef.mets2 <- sd.mets1 <- matrix(nrow=ncol(dat),ncol=8) 
# colnames
colnames(mod1) <- colnames(mod2) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
colnames(coef1) <-  colnames(sd1) <- c("Case","Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Ex.smoking","Snus","Ex.snus","Medications")
colnames(mod.mets1) <-  c("BMIgroups","BMIcont","MetSgroups","MetScont","HT","HTmed")
colnames(coef.mets1) <- colnames(sd.mets1) <- c("BMI<20","BMI25-30","BMI>30","BMIcont","MetSgroups","MetScont","HT","HTmed")
# rownames
rownames(mod1) <- rownames(coef1) <- rownames(mod2) <- rownames(coef2) <- rownames(mod.mets1) <- rownames(coef.mets1)  <- rownames(mod.mets2) <- rownames(coef.mets2) <- rownames(sd1) <- rownames(sd.mets1) <- var1 
# intraclass correlations:
icc <- numeric(length(var1))
names(icc) <- var1
# Main loop:
j=0
for(i in var1){
  j=j+1
  cat(length(var1)-j," ")
  # MODELs lifestyle
    moddat <- na.omit(data.frame(var=dat.lme[,i],dat.lme[,c("person","provnr",cov)]))
    g <- lme(var~casecontrol+age+gender+langd+vikt+g6+skol+stg+blods0+blods2+sbt+dbt+smoke+snus+med,
            random =list(~1|person),
            na.action=na.omit, method="ML",
            data=moddat)
    # p-values
    a <-   anova(g)
    mod1[j,] <- a$`p-value`[-1]
    # Coefficients
    coef1[j,] <- g$coefficients$fixed[-1]
    # SD
    sd1[j,] <- sqrt(diag(g$varFix))[-1]
    # Intercept : between-subjects variace, residual: within subject variance
    varests <- as.numeric(VarCorr(g)[c(1,2)]) 
    icc[j] <- varests[1]/sum(varests)
 # MODELs MetS
    moddat <- na.omit(data.frame(var=dat.lme[,i],dat.lme[,c("person","provnr",covm)]))
    g1 <- lme(var~bmi3+casecontrol+age+gender+g6+smoke+snus+med,
              random = ~1|person, na.action=na.omit,method="ML",data=moddat)
    g2 <- lme(var~bmi+casecontrol+age+gender+g6+smoke+snus+med,
              random = ~1|person, na.action=na.omit,method="ML",data=moddat)
    g3 <- lme(var~mets2+casecontrol+age+gender+g6+smoke+snus+med,
              random = ~1|person, na.action=na.omit,method="ML",data=moddat)
    g4 <- lme(var~metsz+casecontrol+age+gender+g6+smoke+snus+med,
              random = ~1|person, na.action=na.omit,method="ML",data=moddat)
    g5 <- lme(var~ht2+casecontrol+age+gender+g6+smoke+snus+med+bmi,
              random = ~1|person, na.action=na.omit,method="ML",data=moddat)
    g6 <- lme(var~htm+casecontrol+age+gender+g6+smoke+snus+med+bmi,
              random = ~1|person, na.action=na.omit,method="ML",data=moddat)
    # P-values
    mod.mets1[j,1] <- anova(g1)$`p-value`[2]
    mod.mets1[j,2] <- anova(g2)$`p-value`[2]
    mod.mets1[j,3] <- anova(g3)$`p-value`[2]
    mod.mets1[j,4] <- anova(g4)$`p-value`[2]
    mod.mets1[j,5] <- anova(g5)$`p-value`[2]
    mod.mets1[j,6] <- anova(g6)$`p-value`[2]
    # Coefficients
    coef.mets1[j,1:3] <- g1$coefficients$fixed[2:4]
    coef.mets1[j,4] <- g2$coefficients$fixed[2]
    coef.mets1[j,5] <- g3$coefficients$fixed[2]
    coef.mets1[j,6] <- g4$coefficients$fixed[2]
    coef.mets1[j,7] <- g5$coefficients$fixed[2]
    coef.mets1[j,8] <- g6$coefficients$fixed[2]
    # sd
    sd.mets1[j,1:3] <- sqrt(diag(g1$varFix))[2:4]
    sd.mets1[j,4] <- sqrt(diag(g2$varFix))[2]
    sd.mets1[j,5] <- sqrt(diag(g3$varFix))[2]
    sd.mets1[j,6] <- sqrt(diag(g4$varFix))[2]
    sd.mets1[j,7] <- sqrt(diag(g5$varFix))[2]
    sd.mets1[j,8] <- sqrt(diag(g6$varFix))[2]

}

```

### Get significant varaibles:
```{r get significants}

# Significant lifestyle variables
modf.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
modm <- data.frame(var=rownames(modf.bh0),ifelse(modf.bh0<=0.05,1,0)) 
signm <- mutate(modm,sum.sign=rowSums(modm[,-1])) %>% filter(sum.sign>0) #get significant variables 
signm <- signm[order(signm$var),]
coefm <- data.frame(var=rownames(coef1),coef1)
signm 
  
# Significant BMI and Mets
mets.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")
mets.bh2 <- data.frame(var=rownames(mets.bh1),ifelse(mets.bh1<=0.05,1,0)) 
mets.sign <- mutate(mets.bh2,sum.sign=rowSums(mets.bh2[,2:5])) %>% filter(sum.sign>0) 
mets.sign <- mets.sign[order(mets.sign$var),]
mets.coef <- data.frame(var=rownames(coef.mets1),coef.mets1)
mets.sign 

# Skapa Sophias excel-fil:
# adj p
mod.bh0 <- apply(mod1,2,p.adjust,method="bonferroni")
mod.bh1 <- apply(mod.mets1,2,p.adjust,method="bonferroni")
sop <- data.frame(padj=mod.bh0[,2],age=coef1[,2],agesd=sd1[,1],
                  padj=mod.bh0[,3],sex=coef1[,3],sexsd=sd1[,2],
                  padj=mod.bh0[,4],height=coef1[,4],heightsd=sd1[,3],
                  padj=mod.bh0[,5],weight=coef1[,5],weightsd=sd1[,4],
                  padj=mod.bh0[,7],chol=coef1[,7],cholsd=sd1[,6],
                  padj=mod.bh0[,8],trig=coef1[,8],cholsd=sd1[,7],
                  padj=mod.bh0[11],sbt=coef1[,11],sbtsd=sd1[,10],
                  padj=mod.bh0[,12],dbt=coef1[,12],dbtsd=sd1[,11],
                  padj=mod.bh1[,5],HT=coef.mets1[,7],HTsd=sd.mets1[,7],
                  padj=mod.bh1[,6],HTmed=coef.mets1[,8],HTmedsd=sd.mets1[,8],
                  padj=mod.bh1[,1],BMI20=coef.mets1[,1],BMI20sd=sd.mets1[,1],BMI2530=coef.mets1[,2],BMI2530sd=sd.mets1[,2],BMI30=coef.mets1[,3],BMI30sd=sd.mets1[,3],
                  padj=mod.bh1[,2],BMIcont=coef.mets1[,4],BMIcontsd=sd.mets1[,4],
                  padj=mod.bh1[,3],Mets=coef.mets1[,5],Metssd=sd.mets1[,5],
                  padj=mod.bh1[,4],Metscont=coef.mets1[,6],Metscontsd=sd.mets1[,6])
sop["var"] <- rownames(sop)
sop <- sop[order(sop$var),]
# Export estimates to excel
#write.xlsx(rbind(p[p[,2]<0.05,],pd[pd[,2]<0.05,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
#write.xlsx(cbind(p[nn,],pd[nn,]), file ="hej.xlsx",sheetName = "TestSheet", row.names = T)
write.xlsx(sop, file ="sophia3.xlsx",sheetName = "TestSheet", row.names = T)

```


## ICC
```{r plot ICC}
#Plot ICCs
gdata <- data.frame(var1=var1,icc=icc)
ggplot(gdata,aes(x=reorder(var1,icc),y=icc)) +
  geom_bar(stat="identity",width=.15)+
  geom_point(size=1)+
  coord_flip() + 
  theme_bw()
```

### Proteins with low and high icc?
Proteins with low ICCs, "more black", that is higher variation within indiviuals between the two samples. 

Proteins with high ICCs, "less black", more variation between individuals. Most individuals have little diff between two samples. 
```{r plot variables with extreme ICC}
# ICC under 0.1 - little of variation is between individuals (more within individuals)
icclow <- names(icc[icc<0.05])
dplyr::select(dat.lme,person,provnr,one_of(icclow)) %>% melt(id=c("person","provnr")) %>% 
  ggplot(aes(y=value, x=as.factor(person),color=as.factor(provnr))) +
  geom_point(size=0.5) + 
  geom_line(aes(group=as.factor(person)),color="black") + 
  facet_wrap(~variable,scales="free") + theme_bw() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())

# ICC over 0.8 - much of total variation is between indiviuals
icclow <- names(icc[icc>0.9])
dplyr::select(dat.lme,person,provnr,one_of(icclow)) %>% melt(id=c("person","provnr")) %>% 
  ggplot(aes(y=value, x=as.factor(person),color=as.factor(provnr))) +
  geom_point(size=0.5) + 
  geom_line(aes(group=as.factor(person)),color="black") + 
  facet_wrap(~variable,scales="free") + theme_bw() + theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())
    

```

### Plot significant variabls in mixed models:

```{r univariate plots mixed models,echo=F}

# PLOTTING  -----------------
#Loop som plottar alla singificanta associationer:
cov <- c("age","gender","langd","vikt","g6","skol","stg","blods0","blods2","sbt","dbt","smoke","snus","med") 
nam <- c("Age","Sex","Height","Weight","Physical.activity","Colesterol","Triglycerides","P.glucose","Glucose.tolerance","SBP","DBP","Smoking","Snus","Medications")
coef1 <- as.data.frame(coef1)
sd1 <- as.data.frame(sd1)
str(dat.lme[,cov])
k=0
for(i in cov){
  k=k+1
  # Ta ut significants
  s1 <- signm[,c("var",nam[k])]
  s1 <- s1[s1[,2]>0,]
  nn <- as.character(s1[,1])
  coef <- dplyr::select(coef1,contains(nam[k]))
  coef <- as.matrix(coef[nn,])
  sd <- dplyr::select(sd1,contains(nam[k]))
  sd <- as.matrix(sd[nn,])
  s1 <- data.frame(s1,Coef=round(coef,4),SE=round(sd,4))
  cat("\nSignificant associations: \n")
  print(nam[k])
  cat("No of proteins = ",dim(s1)[1],"\n")
  print(s1)
  #Samma som i Enroth?
  if(nam[k] %in% names(natcom)){
    nat1 <- natcom[natcom[,nam[k]]>0,]
  cat("\nAlso significant in Enroth 2014 \n")
  print(s1[s1[,1] %in% nat1[,1],])
  }else cat("\nCovariate not included in Enroth 2014 \n")
  # Plotta 
  if(sum(signm[,nam[k]])==0){
    cat("\nNo significant associations \n")
    
  }else if(is.factor(dat.lme[,i])==T){ 
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=provnr,fill=gdata2[,i]))+
    geom_boxplot(outlier.shape=NA,alpha=0.2) + #avoid plotting outliers twice
    geom_point(aes(color=gdata2[,i]),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
    #,
  }else{
    gdata <- dat.lme[,c(i,"provnr",nn)]
    gdata$provnr <- as.factor(gdata$provnr)
    gdata2 <- melt(gdata,id=c(i,"provnr"))
    # plot
    print(ggplot(gdata2,aes(y=value,x=gdata2[,i],fill=provnr))+
    geom_smooth(method="lm",color="black")+
    geom_point(aes(color=provnr),position = position_jitterdodge(), size=0.5)+
    facet_wrap(~variable,scales="free")+theme_bw()+xlab(nam[k])+ylab(""))
  } 
}



```



#Correlations between markers using adjusted and transformed data

Heatmap old
```{r,echo=F}

# Heatmap 2 : 8*10 inches works good
heat <- t(as.matrix(cor1))
dist.pear <- function(x) as.dist(1-cor(t(x),method="spearman",use="pairwise.complete.obs"))
myclust <- function(x) hclust(x, method="average")
#heatmap.2(heat,col=bluered, trace="none", distfun=dist.pear, hclustfun=hclust.ave)
heatmap.2(heat,dendrogram = "row",
          distfun = dist.pear,
          hclustfun = myclust,
          trace="none",
          col=bluered(24),main="",margins=c(10,12),srtCol=55,key.title="Color key",key.xlab="Speaman's correlation")

```

Circos correlations:
PROV 1
```{r,echo=F}
#Data fix --------------------
# Correlations prov 1
str(rdata1)
cor1 <- cor(rdata1,method="spearman",use="pairwise.complete.obs")
# Melt
cor11 <- melt(cor1);nrow(cor11)
#Remove diagnonal in correlations matrix
cor11 <- cor11[cor11[,1]!=cor11[,2],];nrow(cor11)
# How many negative correlations above 0.5?
sum(cor11[,3]<0 & abs(cor11[,3])>0.5)
# R^2
cor11[,3] <- cor11[,3]^2
# Variable indicating R^2>0.5
cor11[,4] <- ifelse(cor11[,3]>=0.5,1,0) 
# Remove same correlations 
cor11 <- cor11[!duplicated(cor11[,3]),]
# Only those above 0.5
cor22 <- cor11[cor11[,4]==1,1:3]

# Circos plot  --------------------
# Set grid colors
uniq <- union(cor22[[1]], cor22[[2]])
col3 <- colorRampPalette(c("dodgerblue", "forestgreen", "green", "gold", "orange", "red", "purple","darkblue", "blue"),alpha=F)
grid.col=col3(length(uniq))
names(grid.col)=uniq

#Highlight cols
col <-  grid.col[match(cor22[,1],names(grid.col))]
col[cor22[3] < 0.80] = "gray90"

# Scale correlations
cor22[,3] <- (1/(1-cor22[,3]))^2

# Plot
chordDiagram(cor22, 
             directional = 0,transparency=0.20,
             direction.type = c("diffHeight"),
             annotationTrack = c("grid"),annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col, col=col,
             link.sort = TRUE, link.largest.ontop = TRUE) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```

Circos correlations:
PROV 2
```{r,echo=F}
#Data fix --------------------
# Correlations prov 2
str(rdata2)
cor1 <- cor(rdata2,method="spearman",use="pairwise.complete.obs")
# Melt
cor11 <- melt(cor1);nrow(cor11)
#Remove diagnonal in correlations matrix
cor11 <- cor11[cor11[,1]!=cor11[,2],];nrow(cor11)
# How many negative correlations above 0.5?
sum(cor11[,3]<0 & abs(cor11[,3])>0.5)
# R^2
cor11[,3] <- cor11[,3]^2
# Variable indicating R^2>0.5
cor11[,4] <- ifelse(cor11[,3]>=0.5,1,0) 
# Remove same correlations 
cor11 <- cor11[!duplicated(cor11[,3]),]
# Only those above 0.5
cor22 <- cor11[cor11[,4]==1,1:3]

# Circos plot  --------------------
# Set grid colors
uniq <- union(cor22[[1]], cor22[[2]])
col3 <- colorRampPalette(c("dodgerblue", "forestgreen", "green", "gold", "orange", "red", "purple","darkblue", "blue"),alpha=F)
grid.col=col3(length(uniq))
names(grid.col)=uniq

#Highlight cols
col <-  grid.col[match(cor22[,1],names(grid.col))]
col[cor22[3] < 0.80] = "gray90"

# Scale correlations
cor22[,3] <- (1/(1-cor22[,3]))^2

# Plot
chordDiagram(cor22, 
             directional = 0,transparency=0.20,
             direction.type = c("diffHeight"),
             annotationTrack = c("grid"),annotationTrackHeight = c(0.05, 0.1),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col, col=col,
             link.sort = TRUE, link.largest.ontop = TRUE) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```


Circos lifestyle Prov 1

```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix --------------------
lf1 <- dplyr::select(sign1,-Case,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("forestgreen","green","yellow", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col,
             link.lwd=2) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```



Circos lifestyle Prov 2
```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix --------------------
lf1 <- dplyr::select(sign2,-Case,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```


Circos Enroth Prov 1
```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))
par(mfrow=c(1,2))

# IN ENROTH DATA_

#Data fix --------------------
lf1 <- melt(natcom1,id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
#levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

# IN OUR DATA

#Data fix --------------------
lf1 <- melt(enroth1,id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
#levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=310,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 

```


Circos metabolomics metod:

```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix --------------------
lf1 <- dplyr::select(signm,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=313,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 



```


Circos metabolomics metod - MetS and BMI

```{r,echo=F}
par(mar=c(5.1,4.1,4.1,2.1))

#Data fix --------------------
lf1 <- dplyr::select(mets.sign,-sum.sign) %>% melt(id="var")
lf1 <- lf1[lf1$value>0,]
head(lf1);nrow(lf1)
levels(lf1$var) <- gsub('_', '-', levels(lf1$var))

# Circos plot  --------------------
# Start degree so that lifestyle are at the right
# gap degree to seperate lifestyle from proteins
circos.par(start.degree=290,
           gap.degree=c(rep(2, length(unique(lf1[[1]]))-1), 12, rep(2, length(unique(lf1[[2]]))-1), 12))

# Set grid colors
uniq <- union(lf1[[1]], lf1[[2]])
col3 <- colorRampPalette(c("dodgerblue","forestgreen","gold", "red", "blue"))
grid.col=col3(length(uniq))
names(grid.col)=uniq

# Plot
chordDiagram(lf1, 
             annotationTrack = c("grid"),
             preAllocateTracks = list(track.height = 0.3),
             grid.col = grid.col) 

# Add labels that are horizontal: 
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) { 
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index") 
  circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
}, bg.border = NA) # here set bg.border to NA is important

# Clear graphics
circos.clear() 



```










